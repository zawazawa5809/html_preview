<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Slide Presentation Editor</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/feather-icons@4.29.1/dist/feather.min.js"></script>
    <script src="https://unpkg.com/lodash@4.17.21/lodash.min.js"></script>
    <!-- CodeMirror core -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/codemirror.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/mode/markdown/markdown.min.js"></script>
    <!-- CodeMirror addons: fold -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/fold/foldgutter.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/fold/xml-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/fold/brace-fold.min.js"></script>
    <!-- CodeMirror addons: search -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/dialog/dialog.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/dialog/dialog.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/search/searchcursor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/search/search.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/search/jump-to-line.min.js"></script>
    <!-- CodeMirror addons: active line, continuelist -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/selection/active-line.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/edit/continuelist.min.js"></script>
    <!-- marked, DOMPurify, js-beautify -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.15.1/beautify-html.min.js"></script>
    <style>
    :root {
      --da-ink: #1e1f25;
      --da-charcoal: #282a32;
      --da-graphite: #353842;
      --da-slate: #4a4e5c;
      --da-ash: #6b7085;
      --da-stone: #9498ab;
      --da-cloud: #c4c8d6;
      --da-mist: #e2e4ec;
      --da-frost: #f0f1f5;
      --da-snow: #f8f9fb;
      --da-secondary: #5b8fcc;
      --da-secondary-hover: #4a7db8;
      --da-accent-muted: #5b8fcc26;
      --da-accent-glow: #5b8fcc12;
      --da-success: #4aba8a;
      --da-warning: #d4943a;
      --da-error: #d45a5a;
      --ease-out-expo: cubic-bezier(0.22, 1, 0.36, 1);
      --duration-fast: 100ms;
      --duration-normal: 200ms;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.15);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.2);
      --app-text-primary: var(--da-ink);
      --app-text-secondary: var(--da-slate);
      --app-text-on-dark: var(--da-snow);
      --app-text-muted: var(--da-ash);
      --app-bg-primary: var(--da-snow);
      --app-bg-secondary: var(--da-frost);
      --app-bg-dark: var(--da-charcoal);
      --app-border-default: var(--da-mist);
      --app-border-focus: var(--da-secondary);
      --app-border-hover: var(--da-cloud);
      --app-toolbar-bg: var(--da-charcoal);
      --app-toolbar-text: var(--da-snow);
      --app-toolbar-border: var(--da-graphite);
      --app-panel-header-bg: var(--da-ink);
      --app-panel-header-text: var(--da-snow);
      --app-editor-bg: var(--da-snow);
      --app-editor-text: var(--da-ink);
      --app-editor-placeholder: var(--da-ash);
      --app-line-numbers-bg: var(--da-ink);
      --app-line-numbers-text: var(--da-cloud);
      --app-gutter-bg: var(--da-ink);
      --app-gutter-hover: var(--da-graphite);
      --app-gutter-handle: var(--da-stone);
      --app-accent: var(--da-secondary);
      --app-accent-hover: var(--da-secondary-hover);
    }

    :root[data-theme="dark"] {
      --app-text-primary: var(--da-frost);
      --app-text-secondary: var(--da-stone);
      --app-text-muted: var(--da-ash);
      --app-bg-primary: var(--da-charcoal);
      --app-bg-secondary: var(--da-ink);
      --app-bg-dark: var(--da-ink);
      --app-border-default: var(--da-graphite);
      --app-border-hover: var(--da-slate);
      --app-toolbar-bg: var(--da-ink);
      --app-toolbar-text: var(--da-frost);
      --app-toolbar-border: var(--da-graphite);
      --app-panel-header-bg: var(--da-ink);
      --app-panel-header-text: var(--da-frost);
      --app-editor-bg: var(--da-charcoal);
      --app-editor-text: var(--da-frost);
      --app-editor-placeholder: var(--da-ash);
      --app-line-numbers-bg: var(--da-ink);
      --app-line-numbers-text: var(--da-cloud);
      --app-gutter-bg: var(--da-ink);
      --app-gutter-hover: var(--da-graphite);
      --app-gutter-handle: var(--da-stone);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
      font-size: 16px;
      line-height: 1.5;
      font-weight: 400;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      background-color: var(--app-bg-primary);
      color: var(--app-text-primary);
    }

    .toolbar {
      background-color: var(--app-toolbar-bg);
      color: var(--app-toolbar-text);
      padding: 8px 16px;
      border-bottom: 1px solid var(--app-toolbar-border);
      box-shadow: inset 0 -2px 0 0 var(--da-secondary);
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
      min-height: 48px;
    }

    .toolbar-menu {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
    }

    .btn-group {
      display: flex;
      gap: 2px;
      background: rgba(255, 255, 255, 0.04);
      border-radius: 8px;
      padding: 2px;
    }

    .toolbar-button {
      background: none;
      border: 1px solid transparent;
      padding: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      min-width: 34px;
      min-height: 34px;
      transition: all var(--duration-normal) var(--ease-out-expo);
    }
    .toolbar-button svg {
      width: 17px;
      height: 17px;
      color: var(--da-cloud);
      transition: all var(--duration-normal) var(--ease-out-expo);
    }
    .toolbar-button:hover { background-color: var(--da-graphite); }
    .toolbar-button:hover svg { color: var(--da-snow); }
    .toolbar-button:active { transform: scale(0.93); }
    .toolbar-button.active {
      background: var(--da-accent-muted);
      border-color: var(--da-secondary);
    }
    .toolbar-button.active svg { color: var(--da-snow); }
    .toolbar-button:focus-visible {
      outline: 2px solid var(--da-secondary);
      outline-offset: 2px;
      box-shadow: 0 0 0 4px var(--da-accent-muted);
      border-radius: 6px;
    }

    .toolbar-separator {
      width: 1px;
      height: 24px;
      background: var(--da-graphite);
      margin: 0 4px;
    }

    .toolbar-label {
      font-size: 12px;
      font-weight: 500;
      color: var(--da-cloud);
      white-space: nowrap;
      user-select: none;
    }

    .slide-counter {
      font-size: 12px;
      font-weight: 600;
      color: var(--da-snow);
      min-width: 60px;
      text-align: center;
      white-space: nowrap;
      user-select: none;
      font-variant-numeric: tabular-nums;
    }

    @media (max-width: 600px) {
      .toolbar { flex-wrap: wrap; }
      .toolbar-menu { width: 100%; justify-content: center; flex-wrap: wrap; }
    }

    #html-editor:focus, #html-editor:focus-visible {
      outline: 2px solid var(--app-border-focus);
      outline-offset: -2px;
      border-radius: 4px;
    }

    .split-view {
      display: flex;
      width: 100%;
      flex-grow: 1;
      position: relative;
      overflow: hidden;
    }
    .split-view.layout-lr { flex-direction: row; }
    .split-view.layout-tb { flex-direction: column; }

    .editor-container, .preview-panel {
      display: flex;
      flex-direction: column;
      min-width: 0;
      min-height: 0;
      overflow: hidden;
      transition: width 250ms var(--ease-out-expo), height 250ms var(--ease-out-expo);
    }

    .editor-container { background-color: var(--app-editor-bg); }
    .split-view.layout-lr .editor-container { width: 50%; height: 100%; }
    .split-view.layout-tb .editor-container { width: 100%; height: 50%; }
    .preview-panel { background-color: var(--app-bg-primary); }
    .split-view.layout-lr .preview-panel { width: 50%; height: 100%; }
    .split-view.layout-tb .preview-panel { width: 100%; height: 50%; }

    .split-view.layout-po .editor-container,
    .split-view.layout-po .gutter { display: none; }
    .split-view.layout-po .preview-panel { width: 100% !important; height: 100% !important; }

    .panel-header {
      background: var(--app-panel-header-bg);
      color: var(--app-panel-header-text);
      padding: 8px 16px;
      border-left: 3px solid var(--da-secondary);
      font-weight: 600;
      font-size: 11px;
      line-height: 1.5;
      text-align: left;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      user-select: none;
      flex-shrink: 0;
    }
    .panel-tabs {
      display: flex;
      gap: 0;
      padding: 0;
      border-left: none;
    }
    .panel-tab {
      background: transparent;
      border: none;
      color: var(--app-panel-header-text);
      padding: 8px 16px;
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      opacity: 0.6;
      transition: all var(--duration-normal);
    }
    .panel-tab.active {
      opacity: 1;
      border-bottom-color: var(--da-secondary);
    }
    .panel-tab:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    .panel-tab:not(:disabled):hover {
      opacity: 0.9;
      background: rgba(255,255,255,0.05);
    }

    .editor-content-wrapper {
      display: flex;
      flex-grow: 1;
      overflow: hidden;
      border: 1px solid var(--app-border-default);
      border-top: none;
      border-radius: 0 0 4px 4px;
      box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    :root[data-theme="dark"] .editor-content-wrapper {
      box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    #html-editor {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 0;
      padding: 12px 16px;
      font-family: "Noto Sans Mono", Consolas, "Courier New", monospace;
      font-size: 14px;
      line-height: 1.5;
      resize: none;
      flex-grow: 1;
      background-color: var(--app-editor-bg);
      color: var(--app-editor-text);
    }
    .CodeMirror { width: 100%; height: 100%; flex-grow: 1; }
    .CodeMirror-activeline-background { background: var(--da-accent-glow) !important; }
    .CodeMirror-selected { background: var(--da-accent-muted) !important; }
    .CodeMirror-focused .CodeMirror-selected { background: var(--da-accent-muted) !important; }
    #html-editor::placeholder {
      color: var(--app-editor-placeholder);
      font-style: italic;
    }

    /* CodeMirror slide separator decoration */
    .cm-slide-separator {
      background: var(--da-graphite) !important;
      border-top: 1px solid var(--da-secondary) !important;
      border-bottom: 1px solid var(--da-secondary) !important;
    }
    .cm-slide-separator .CodeMirror-linenumber {
      color: var(--da-secondary) !important;
    }
    .cm-design-highlight {
      background: rgba(91, 143, 204, 0.15) !important;
    }

    .panel-content {
      flex-grow: 1;
      overflow: hidden;
      padding: 0;
      border: 1px solid var(--app-border-default);
      border-top: none;
      background-color: var(--app-bg-primary);
      border-radius: 0 0 4px 4px;
      display: flex;
      flex-direction: column;
    }

    #preview-container {
      width: 100%;
      height: 100%;
      border: none;
      background-color: var(--app-bg-primary);
      border-radius: 4px;
      flex-grow: 1;
    }

    /* Design Mode active: blue border on preview */
    .preview-panel.design-active .panel-content {
      border: 2px solid var(--da-secondary);
      border-radius: 0 0 4px 4px;
    }

    .gutter {
      background-color: var(--app-gutter-bg);
      position: relative;
      transition: background-color var(--duration-normal) var(--ease-out-expo);
    }
    .split-view.layout-lr .gutter {
      width: 6px; height: 100%; cursor: col-resize;
      margin: 0 -4px; padding: 0 4px; background-clip: content-box;
    }
    .split-view.layout-tb .gutter {
      width: 100%; height: 6px; cursor: row-resize;
      margin: -4px 0; padding: 4px 0; background-clip: content-box;
    }
    .gutter:hover { background-color: var(--da-secondary); }
    .gutter.dragging { box-shadow: 0 0 8px var(--da-accent-muted); }
    .gutter::before {
      content: "";
      position: absolute;
      border-radius: 2px;
      transition: background-color var(--duration-normal) var(--ease-out-expo);
    }
    .split-view.layout-lr .gutter::before {
      top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 3px; height: 3px;
      box-shadow: 0 -6px 0 0 var(--app-gutter-handle), 0 0 0 0 var(--app-gutter-handle), 0 6px 0 0 var(--app-gutter-handle);
      background: var(--app-gutter-handle);
    }
    .split-view.layout-tb .gutter::before {
      top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 3px; height: 3px;
      box-shadow: -6px 0 0 0 var(--app-gutter-handle), 0 0 0 0 var(--app-gutter-handle), 6px 0 0 0 var(--app-gutter-handle);
      background: var(--app-gutter-handle);
    }

    body.dragging-lr, body.dragging-lr * { cursor: col-resize !important; }
    body.dragging-tb, body.dragging-tb * { cursor: row-resize !important; }
    .resize-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 9999;
    }

    /* Toast notifications */
    @keyframes toast-slide-in {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes toast-fade-out {
      from { transform: translateY(0); opacity: 1; }
      to { transform: translateY(-8px); opacity: 0; }
    }
    .temp-message {
      position: fixed;
      top: 60px; right: 20px;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 13px;
      z-index: 10000;
      pointer-events: none;
      background-color: var(--da-charcoal);
      color: var(--da-snow);
      border: 1px solid var(--da-graphite);
      box-shadow: var(--shadow-md);
      animation: toast-slide-in 300ms var(--ease-out-expo);
    }
    .temp-message[role="status"] { border-left: 3px solid var(--da-success); }
    .temp-message.toast-error[role="status"] { border-left: 3px solid var(--da-error); }
    .temp-message.toast-out { animation: toast-fade-out 300ms var(--ease-out-expo) forwards; }

    .theme-icon-spin svg { animation: theme-spin 400ms var(--ease-out-expo); }
    @keyframes theme-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .toolbar-nav {
      display: flex;
      align-items: center;
      gap: 2px;
      margin-left: 4px;
    }
    .toolbar-nav a {
      color: var(--da-cloud);
      text-decoration: none;
      font-size: 12px;
      font-weight: 500;
      padding: 5px 10px;
      border-radius: 6px;
      transition: all var(--duration-normal) var(--ease-out-expo);
      white-space: nowrap;
    }
    .toolbar-nav a:hover { color: var(--da-snow); background-color: var(--da-graphite); }
    .toolbar-nav a.nav-active { color: var(--da-secondary); background: var(--da-accent-muted); }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* ======== Slide Navigator / Thumbnail Strip ======== */
    .slide-navigator {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 6px 12px;
      background: var(--app-bg-secondary);
      border-top: 1px solid var(--app-border-default);
      border-bottom: 1px solid var(--app-border-default);
      overflow-x: auto;
      flex-shrink: 0;
    }
    .slide-navigator::-webkit-scrollbar { height: 4px; }
    .slide-navigator::-webkit-scrollbar-track { background: transparent; }
    .slide-navigator::-webkit-scrollbar-thumb {
      background: var(--da-ash);
      border-radius: 2px;
    }
    .slide-nav-item {
      min-width: 32px;
      height: 24px;
      padding: 0 8px;
      border: 1px solid var(--app-border-default);
      border-radius: 4px;
      background: var(--app-bg-primary);
      color: var(--app-text-secondary);
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--duration-fast);
      flex-shrink: 0;
    }
    .slide-nav-item:hover {
      border-color: var(--app-border-hover);
      color: var(--app-text-primary);
    }
    .slide-nav-item.active {
      background: var(--da-accent-muted);
      border-color: var(--da-secondary);
      color: var(--da-secondary);
    }

    /* ======== Design Toolbar ======== */
    .design-toolbar {
      background: var(--app-bg-secondary);
      border-top: 1px solid var(--app-border-default);
      overflow-y: auto;
      flex-grow: 1;
      font-size: 12px;
    }
    .design-toolbar::-webkit-scrollbar { width: 5px; }
    .design-toolbar::-webkit-scrollbar-track { background: transparent; }
    .design-toolbar::-webkit-scrollbar-thumb {
      background: var(--da-ash);
      border-radius: 3px;
    }

    .dt-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 12px;
      background: var(--app-panel-header-bg);
      border-bottom: 1px solid var(--app-border-default);
      gap: 8px;
    }
    .dt-element-tag {
      font-family: "Noto Sans Mono", Consolas, monospace;
      font-size: 13px;
      color: var(--da-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .dt-hint {
      font-size: 11px;
      color: var(--da-stone);
      padding: 8px 12px;
      text-align: center;
    }
    .dt-actions {
      display: flex;
      gap: 3px;
      flex-shrink: 0;
    }
    .dt-btn {
      background: none;
      border: 1px solid var(--da-graphite);
      border-radius: 4px;
      padding: 3px 5px;
      cursor: pointer;
      color: var(--da-cloud);
      display: flex;
      align-items: center;
      transition: all var(--duration-fast);
    }
    .dt-btn:hover {
      background: var(--da-accent-muted);
      border-color: var(--da-secondary);
      color: var(--da-snow);
    }
    .dt-btn svg { width: 13px; height: 13px; }

    .dt-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 5px 12px;
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--app-text-secondary);
      border-bottom: 1px solid var(--app-border-default);
      user-select: none;
      transition: background var(--duration-fast);
    }
    .dt-section-header:hover { background: var(--da-accent-glow); }
    .dt-section-header .dt-chevron {
      width: 14px; height: 14px;
      transition: transform 200ms var(--ease-out-expo);
    }
    .dt-section-header.collapsed .dt-chevron { transform: rotate(-90deg); }

    .dt-section-body {
      padding: 8px 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      border-bottom: 1px solid var(--app-border-default);
    }
    .dt-section-body.collapsed { display: none; }

    .dt-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .dt-row label {
      min-width: 65px;
      color: var(--app-text-secondary);
      font-size: 11px;
      flex-shrink: 0;
    }

    .dt-color-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .dt-color-row label {
      min-width: 50px;
      color: var(--app-text-secondary);
      font-size: 11px;
      flex-shrink: 0;
    }
    .dt-color-row input[type="color"] {
      width: 26px; height: 26px;
      border: 1px solid var(--app-border-default);
      border-radius: 4px;
      padding: 1px;
      cursor: pointer;
      background: none;
    }
    .dt-input, .dt-input-sm {
      border: 1px solid var(--app-border-default);
      border-radius: 4px;
      padding: 3px 6px;
      font-size: 11px;
      background: var(--app-editor-bg);
      color: var(--app-text-primary);
      font-family: inherit;
    }
    .dt-input { width: 90px; }
    .dt-input-sm { width: 52px; }

    .dt-select {
      border: 1px solid var(--app-border-default);
      border-radius: 4px;
      padding: 3px 6px;
      font-size: 11px;
      background: var(--app-editor-bg);
      color: var(--app-text-primary);
      font-family: inherit;
    }

    .dt-row input[type="range"] {
      flex: 1;
      min-width: 60px;
      accent-color: var(--da-secondary);
      height: 16px;
    }

    .dt-btn-group {
      display: flex;
      gap: 1px;
      background: var(--app-border-default);
      border-radius: 4px;
      overflow: hidden;
    }
    .dt-btn-sm {
      background: var(--app-bg-secondary);
      border: none;
      padding: 3px 8px;
      cursor: pointer;
      font-size: 11px;
      color: var(--app-text-secondary);
      transition: all var(--duration-fast);
    }
    .dt-btn-sm:hover, .dt-btn-sm.active {
      background: var(--da-accent-muted);
      color: var(--app-text-primary);
    }

    .dt-transparent-btn {
      background: none;
      border: 1px solid var(--app-border-default);
      border-radius: 4px;
      padding: 2px 6px;
      cursor: pointer;
      font-size: 11px;
      color: var(--app-text-muted);
      line-height: 1;
    }
    .dt-transparent-btn:hover {
      border-color: var(--da-error);
      color: var(--da-error);
    }

    .dt-link-btn {
      background: none;
      border: 1px solid var(--app-border-default);
      border-radius: 4px;
      padding: 2px 5px;
      cursor: pointer;
      font-size: 11px;
      color: var(--app-text-muted);
      display: flex;
      align-items: center;
    }
    .dt-link-btn.linked {
      color: var(--da-secondary);
      border-color: var(--da-secondary);
    }
    .dt-link-btn svg { width: 12px; height: 12px; }

    /* Box model diagram */
    .dt-box-model {
      width: 100%;
      max-width: 260px;
      margin: 4px auto;
      font-size: 10px;
    }
    .dt-box-margin {
      position: relative;
      background: rgba(255, 165, 0, 0.1);
      border: 1px dashed rgba(255, 165, 0, 0.3);
      padding: 18px 24px;
    }
    .dt-box-padding {
      position: relative;
      background: rgba(76, 175, 80, 0.1);
      border: 1px dashed rgba(76, 175, 80, 0.3);
      padding: 18px 24px;
    }
    .dt-box-content {
      background: rgba(91, 143, 204, 0.15);
      border: 1px solid rgba(91, 143, 204, 0.3);
      padding: 6px;
      text-align: center;
      color: var(--app-text-muted);
      font-size: 10px;
    }
    .dt-box-label {
      position: absolute;
      top: 1px; left: 3px;
      font-size: 9px;
      color: var(--app-text-muted);
      opacity: 0.7;
    }
    .dt-box-input {
      position: absolute;
      width: 32px;
      text-align: center;
      border: 1px solid var(--app-border-default);
      border-radius: 3px;
      font-size: 10px;
      padding: 1px;
      background: var(--app-editor-bg);
      color: var(--app-text-primary);
      font-family: inherit;
    }
    .dt-box-input:focus {
      outline: 1px solid var(--da-secondary);
      border-color: var(--da-secondary);
    }
    .dt-box-top { top: 1px; left: 50%; transform: translateX(-50%); }
    .dt-box-right { right: 2px; top: 50%; transform: translateY(-50%); }
    .dt-box-bottom { bottom: 1px; left: 50%; transform: translateX(-50%); }
    .dt-box-left { left: 2px; top: 50%; transform: translateY(-50%); }

    /* Add child dropdown */
    .dt-add-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: var(--app-bg-primary);
      border: 1px solid var(--app-border-default);
      border-radius: 6px;
      box-shadow: var(--shadow-md);
      z-index: 200;
      min-width: 120px;
      padding: 4px 0;
    }
    .dt-add-dropdown button {
      display: block;
      width: 100%;
      text-align: left;
      background: none;
      border: none;
      padding: 5px 12px;
      font-size: 12px;
      font-family: "Noto Sans Mono", Consolas, monospace;
      color: var(--app-text-primary);
      cursor: pointer;
    }
    .dt-add-dropdown button:hover {
      background: var(--da-accent-muted);
    }
    .dt-dropdown-category {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--app-text-muted);
      padding: 6px 12px 2px;
      border-top: 1px solid var(--app-border-default);
    }
    .dt-dropdown-category:first-child { border-top: none; }

    /* Breadcrumb */
    .dt-breadcrumb {
      display: flex;
      flex-wrap: wrap;
      gap: 2px;
      padding: 4px 12px;
      font-size: 10px;
      align-items: center;
      border-bottom: 1px solid var(--app-border-default);
      background: var(--app-panel-header-bg);
      min-height: 0;
    }
    .dt-breadcrumb:empty { display: none; }
    .dt-breadcrumb-item {
      cursor: pointer;
      padding: 1px 4px;
      border-radius: 3px;
      color: var(--da-stone);
      font-family: "Noto Sans Mono", Consolas, monospace;
    }
    .dt-breadcrumb-item:hover { background: var(--da-accent-muted); color: var(--da-snow); }
    .dt-breadcrumb-item.active { color: var(--da-secondary); }
    .dt-breadcrumb-sep { color: var(--da-ash); font-size: 9px; }

    /* ======== Presentation Overlay ======== */
    .presentation-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #000;
      z-index: 100000;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    .presentation-overlay iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: #000;
    }
    .presentation-controls {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      align-items: center;
      background: rgba(0, 0, 0, 0.7);
      padding: 8px 16px;
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
      z-index: 100001;
      opacity: 0;
      transition: opacity 300ms;
    }
    .presentation-overlay:hover .presentation-controls {
      opacity: 1;
    }
    .presentation-controls button {
      background: none;
      border: 1px solid rgba(255,255,255,0.3);
      color: #fff;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    .presentation-controls button:hover {
      background: rgba(255,255,255,0.15);
    }
    </style>
  </head>
  <body>
    <div class="toolbar">
      <div class="toolbar-menu">
        <div class="btn-group" role="group" aria-label="編集操作">
          <button class="toolbar-button" id="undo-btn" title="元に戻す (Ctrl+Z)" aria-label="元に戻す" tabindex="0">
            <i data-feather="rotate-ccw"></i>
          </button>
          <button class="toolbar-button" id="redo-btn" title="やり直す (Ctrl+Y)" aria-label="やり直す" tabindex="0">
            <i data-feather="rotate-cw"></i>
          </button>
          <button class="toolbar-button" id="copy-btn" title="コードをクリップボードにコピー (Ctrl+Shift+C)" aria-label="コピー" tabindex="0">
            <i data-feather="copy"></i>
          </button>
          <button class="toolbar-button" id="paste-btn" title="クリップボードから貼り付け" aria-label="貼り付け" tabindex="0">
            <i data-feather="clipboard"></i>
          </button>
          <button class="toolbar-button" id="clear-btn" title="エディターをクリア (Ctrl+Delete)" aria-label="クリア" tabindex="0">
            <i data-feather="trash-2"></i>
          </button>
        </div>
        <div class="toolbar-separator"></div>
        <div class="btn-group" role="group" aria-label="レイアウト切り替え">
          <button class="toolbar-button" id="layout-lr-btn" title="左右分割レイアウト (Ctrl+1)" aria-label="左右分割" tabindex="0">
            <i data-feather="columns"></i>
          </button>
          <button class="toolbar-button" id="layout-tb-btn" title="上下分割レイアウト (Ctrl+2)" aria-label="上下分割" tabindex="0">
            <i data-feather="minimize-2"></i>
          </button>
          <button class="toolbar-button" id="layout-po-btn" title="プレビューのみ (Ctrl+3)" aria-label="プレビューのみ" tabindex="0">
            <i data-feather="eye"></i>
          </button>
          <button class="toolbar-button" id="theme-toggle-btn" title="テーマ切り替え" aria-label="テーマ切り替え" tabindex="0">
            <i data-feather="moon" id="theme-toggle-icon"></i>
          </button>
        </div>
        <div class="toolbar-separator"></div>
        <div class="btn-group" role="group" aria-label="スライド操作">
          <button class="toolbar-button" id="prev-slide-btn" title="前のスライド (Ctrl+Shift+Enter)" aria-label="前のスライド" tabindex="0">
            <i data-feather="chevron-left"></i>
          </button>
          <span class="slide-counter" id="slide-counter">0 / 0</span>
          <button class="toolbar-button" id="next-slide-btn" title="次のスライド (Ctrl+Enter)" aria-label="次のスライド" tabindex="0">
            <i data-feather="chevron-right"></i>
          </button>
          <button class="toolbar-button" id="add-slide-btn" title="スライド追加" aria-label="スライド追加" tabindex="0">
            <i data-feather="plus"></i>
          </button>
        </div>
        <div class="toolbar-separator"></div>
        <div class="btn-group" role="group" aria-label="アスペクト比">
          <button class="toolbar-button" id="aspect-16-9-btn" title="16:9" aria-label="16:9" tabindex="0">
            <span class="toolbar-label">16:9</span>
          </button>
          <button class="toolbar-button" id="aspect-4-3-btn" title="4:3" aria-label="4:3" tabindex="0">
            <span class="toolbar-label">4:3</span>
          </button>
        </div>
        <div class="toolbar-separator"></div>
        <div class="btn-group" role="group" aria-label="デザインモード">
          <button class="toolbar-button" id="design-mode-btn" title="デザインモード (Ctrl+D)" aria-label="デザインモード切替" tabindex="0">
            <i data-feather="edit-3"></i>
          </button>
        </div>
        <div class="toolbar-separator"></div>
        <div class="btn-group" role="group" aria-label="プレゼンテーション">
          <button class="toolbar-button" id="present-btn" title="プレゼンテーション (F5)" aria-label="プレゼンテーション" tabindex="0">
            <i data-feather="play"></i>
          </button>
          <button class="toolbar-button" id="print-btn" title="印刷 (Ctrl+P)" aria-label="印刷" tabindex="0">
            <i data-feather="printer"></i>
          </button>
        </div>
        <div style="flex-grow: 1" aria-hidden="true"></div>
        <div class="btn-group" role="group" aria-label="ファイル操作">
          <button class="toolbar-button" id="open-btn" title="ファイルを開く" aria-label="開く" tabindex="0">
            <i data-feather="upload"></i>
          </button>
          <input type="file" id="file-input" accept=".html,.htm,.md" style="display: none;" />
          <button class="toolbar-button" id="save-btn" title="ファイルをダウンロード (Ctrl+S)" aria-label="保存" tabindex="0">
            <i data-feather="download"></i>
          </button>
        </div>
        <nav class="toolbar-nav" role="navigation" aria-label="ツール切り替え">
          <a href="index.html">HTML</a>
          <a href="designer.html">Designer</a>
          <a href="markdown_preview.html">MD</a>
          <a href="slides.html" class="nav-active">Slides</a>
          <a href="loom.html">Loom</a>
          <a href="shelf.html">Shelf</a>
          <a href="tangle.html">Tangle</a>
          <a href="nexus.html">Nexus</a>
          <a href="diffuse.html">Diffuse</a>
        </nav>
      </div>
    </div>

    <div class="split-view" id="split-view">
      <div class="editor-container" id="editor-container">
        <div class="panel-header panel-tabs">
          <button class="panel-tab active" id="tab-code" data-tab="code">Code</button>
          <button class="panel-tab" id="tab-design" data-tab="design">Design</button>
          <button class="panel-tab" id="tab-settings" data-tab="settings">Settings</button>
        </div>
        <div class="editor-content-wrapper" id="code-panel">
          <textarea
            id="html-editor"
            placeholder="スライド内容を入力... (--- で区切り)"
            wrap="soft"
            aria-label="スライドエディター"
            role="textbox"
            aria-multiline="true"
            spellcheck="false"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="off"
          ></textarea>
        </div>
        <!-- Design Toolbar (Phase 4 placeholder) -->
        <div id="design-toolbar" class="design-toolbar" style="display: none;">
          <div class="dt-header">
            <span class="dt-element-tag" id="dt-element-tag">--</span>
            <div class="dt-actions" id="dt-actions" style="display: none;">
              <button class="dt-btn" id="dt-move-up" title="上へ移動"><i data-feather="chevron-up"></i></button>
              <button class="dt-btn" id="dt-move-down" title="下へ移動"><i data-feather="chevron-down"></i></button>
              <button class="dt-btn" id="dt-duplicate" title="複製"><i data-feather="copy"></i></button>
              <button class="dt-btn" id="dt-delete" title="削除"><i data-feather="trash-2"></i></button>
              <button class="dt-btn" id="dt-copy-style" title="スタイルコピー"><i data-feather="droplet"></i></button>
              <button class="dt-btn" id="dt-paste-style" title="スタイル貼り付け"><i data-feather="clipboard"></i></button>
              <div style="position:relative">
                <button class="dt-btn" id="dt-add-child" title="子要素追加"><i data-feather="plus"></i></button>
                <div class="dt-add-dropdown" id="dt-add-dropdown" style="display:none">
                  <div class="dt-dropdown-category">Layout</div>
                  <button data-template="container">Container</button>
                  <button data-template="section">Section</button>
                  <button data-template="flex-row">Flex Row</button>
                  <button data-template="flex-col">Flex Column</button>
                  <button data-template="grid-2col">Grid (2col)</button>
                  <button data-template="divider">Divider</button>
                  <div class="dt-dropdown-category">Content</div>
                  <button data-template="heading">Heading</button>
                  <button data-template="text">Text Block</button>
                  <button data-template="list">List</button>
                  <div class="dt-dropdown-category">Media</div>
                  <button data-template="image">Image</button>
                  <div class="dt-dropdown-category">Interactive</div>
                  <button data-template="button">Button</button>
                  <button data-template="link">Link</button>
                </div>
              </div>
            </div>
          </div>
          <div class="dt-breadcrumb" id="dt-breadcrumb"></div>

          <div id="dt-hint" class="dt-hint">要素をクリックして選択</div>

          <div id="dt-controls" style="display: none;">
            <!-- Colors -->
            <div class="dt-section-header" data-section="dt-colors">
              <span>Colors</span>
              <i data-feather="chevron-down" class="dt-chevron"></i>
            </div>
            <div class="dt-section-body" id="dt-colors">
              <div class="dt-color-row">
                <label>Background</label>
                <input type="color" id="dt-bg-color" value="#ffffff" />
                <input type="text" id="dt-bg-color-text" class="dt-input-sm" placeholder="#fff" />
                <button class="dt-transparent-btn" id="dt-bg-transparent" title="transparent">T</button>
              </div>
              <div class="dt-color-row">
                <label>Text</label>
                <input type="color" id="dt-text-color" value="#000000" />
                <input type="text" id="dt-text-color-text" class="dt-input-sm" placeholder="#000" />
              </div>
              <div class="dt-color-row">
                <label>Border</label>
                <input type="color" id="dt-border-color" value="#000000" />
                <input type="text" id="dt-border-color-text" class="dt-input-sm" placeholder="#000" />
              </div>
            </div>

            <!-- Typography -->
            <div class="dt-section-header collapsed" data-section="dt-typography">
              <span>Typography</span>
              <i data-feather="chevron-down" class="dt-chevron"></i>
            </div>
            <div class="dt-section-body collapsed" id="dt-typography">
              <div class="dt-row">
                <label>Font Size</label>
                <input type="range" id="dt-font-size-slider" min="8" max="72" value="16" />
                <input type="number" id="dt-font-size" class="dt-input-sm" min="1" max="200" value="16" />
                <span>px</span>
              </div>
              <div class="dt-row">
                <label>Weight</label>
                <select id="dt-font-weight" class="dt-select">
                  <option value="100">100</option>
                  <option value="200">200</option>
                  <option value="300">300</option>
                  <option value="400" selected>400</option>
                  <option value="500">500</option>
                  <option value="600">600</option>
                  <option value="700">700</option>
                  <option value="800">800</option>
                  <option value="900">900</option>
                </select>
              </div>
              <div class="dt-row">
                <label>Align</label>
                <div class="dt-btn-group" id="dt-text-align-group">
                  <button class="dt-btn-sm" data-align="left">L</button>
                  <button class="dt-btn-sm" data-align="center">C</button>
                  <button class="dt-btn-sm" data-align="right">R</button>
                  <button class="dt-btn-sm" data-align="justify">J</button>
                </div>
              </div>
              <div class="dt-row">
                <label>Line Height</label>
                <input type="range" id="dt-line-height-slider" min="0.5" max="3" step="0.1" value="1.5" />
                <input type="number" id="dt-line-height" class="dt-input-sm" min="0.5" max="5" step="0.1" value="1.5" />
              </div>
            </div>

            <!-- Spacing -->
            <div class="dt-section-header collapsed" data-section="dt-spacing">
              <span>Spacing</span>
              <i data-feather="chevron-down" class="dt-chevron"></i>
            </div>
            <div class="dt-section-body collapsed" id="dt-spacing">
              <div class="dt-box-model">
                <div class="dt-box-margin">
                  <span class="dt-box-label">margin</span>
                  <input class="dt-box-input dt-box-top" id="dt-margin-top" value="0" data-prop="marginTop" />
                  <input class="dt-box-input dt-box-right" id="dt-margin-right" value="0" data-prop="marginRight" />
                  <input class="dt-box-input dt-box-bottom" id="dt-margin-bottom" value="0" data-prop="marginBottom" />
                  <input class="dt-box-input dt-box-left" id="dt-margin-left" value="0" data-prop="marginLeft" />
                  <div class="dt-box-padding">
                    <span class="dt-box-label">padding</span>
                    <input class="dt-box-input dt-box-top" id="dt-padding-top" value="0" data-prop="paddingTop" />
                    <input class="dt-box-input dt-box-right" id="dt-padding-right" value="0" data-prop="paddingRight" />
                    <input class="dt-box-input dt-box-bottom" id="dt-padding-bottom" value="0" data-prop="paddingBottom" />
                    <input class="dt-box-input dt-box-left" id="dt-padding-left" value="0" data-prop="paddingLeft" />
                    <div class="dt-box-content">content</div>
                  </div>
                </div>
              </div>
              <div class="dt-row" style="margin-top:4px; justify-content:center; gap:12px">
                <button class="dt-link-btn" id="dt-padding-link" title="Padding一括変更">
                  <i data-feather="link"></i>
                  <span style="margin-left:3px">Pad</span>
                </button>
                <button class="dt-link-btn" id="dt-margin-link" title="Margin一括変更">
                  <i data-feather="link"></i>
                  <span style="margin-left:3px">Mar</span>
                </button>
              </div>
            </div>

            <!-- Box -->
            <div class="dt-section-header collapsed" data-section="dt-box">
              <span>Box</span>
              <i data-feather="chevron-down" class="dt-chevron"></i>
            </div>
            <div class="dt-section-body collapsed" id="dt-box">
              <div class="dt-row">
                <label>Width</label>
                <input type="text" id="dt-width" class="dt-input" placeholder="auto" />
              </div>
              <div class="dt-row">
                <label>Height</label>
                <input type="text" id="dt-height" class="dt-input" placeholder="auto" />
              </div>
              <div class="dt-row">
                <label>Radius</label>
                <input type="range" id="dt-border-radius-slider" min="0" max="50" value="0" />
                <input type="number" id="dt-border-radius" class="dt-input-sm" min="0" max="999" value="0" />
                <span>px</span>
              </div>
              <div class="dt-row">
                <label>Opacity</label>
                <input type="range" id="dt-opacity-slider" min="0" max="1" step="0.05" value="1" />
                <span id="dt-opacity-value" style="min-width:28px;text-align:right">1</span>
              </div>
              <div class="dt-row">
                <label>Display</label>
                <select id="dt-display" class="dt-select">
                  <option value="block">block</option>
                  <option value="flex">flex</option>
                  <option value="grid">grid</option>
                  <option value="inline">inline</option>
                  <option value="inline-block">inline-block</option>
                  <option value="none">none</option>
                </select>
              </div>
              <div class="dt-row">
                <label>Overflow</label>
                <select id="dt-overflow" class="dt-select">
                  <option value="visible">visible</option>
                  <option value="hidden">hidden</option>
                  <option value="scroll">scroll</option>
                  <option value="auto">auto</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        <!-- Settings Panel -->
        <div id="settings-panel" class="design-toolbar" style="display: none;">
          <div class="dt-section-header" data-section="st-theme">
            <span>Theme</span>
            <i data-feather="chevron-down" class="dt-chevron"></i>
          </div>
          <div class="dt-section-body" id="st-theme">
            <div class="dt-row">
              <label>Preset</label>
              <select id="st-theme-preset" class="dt-select" style="width:auto">
                <option value="default">Default</option>
                <option value="dark">Dark</option>
                <option value="corporate">Corporate</option>
                <option value="minimal">Minimal</option>
                <option value="warm">Warm</option>
                <option value="ocean">Ocean</option>
              </select>
            </div>
            <div class="dt-color-row">
              <label>Background</label>
              <input type="color" id="st-bg-color" value="#ffffff" />
              <input type="text" id="st-bg-color-text" class="dt-input-sm" />
            </div>
            <div class="dt-color-row">
              <label>Text</label>
              <input type="color" id="st-text-color" value="#1e1f25" />
              <input type="text" id="st-text-color-text" class="dt-input-sm" />
            </div>
            <div class="dt-color-row">
              <label>Heading</label>
              <input type="color" id="st-heading-color" value="#1e1f25" />
              <input type="text" id="st-heading-color-text" class="dt-input-sm" />
            </div>
            <div class="dt-color-row">
              <label>Accent</label>
              <input type="color" id="st-accent-color" value="#5b8fcc" />
              <input type="text" id="st-accent-color-text" class="dt-input-sm" />
            </div>
            <div class="dt-row">
              <label>Font</label>
              <select id="st-font-family" class="dt-select" style="width:auto">
                <option value="&quot;Noto Sans JP&quot;, system-ui, sans-serif">Noto Sans JP</option>
                <option value="system-ui, sans-serif">System UI</option>
                <option value="Georgia, serif">Georgia</option>
                <option value="&quot;Helvetica Neue&quot;, Arial, sans-serif">Helvetica</option>
              </select>
            </div>
          </div>

          <div class="dt-section-header" data-section="st-page-numbers">
            <span>Page Numbers</span>
            <i data-feather="chevron-down" class="dt-chevron"></i>
          </div>
          <div class="dt-section-body" id="st-page-numbers">
            <div class="dt-row">
              <label>Show</label>
              <input type="checkbox" id="st-page-show" style="accent-color:var(--da-secondary)" />
            </div>
            <div class="dt-row">
              <label>Position</label>
              <select id="st-page-position" class="dt-select">
                <option value="bottom-left">Bottom Left</option>
                <option value="bottom-center">Bottom Center</option>
                <option value="bottom-right" selected>Bottom Right</option>
              </select>
            </div>
            <div class="dt-row">
              <label>Format</label>
              <input type="text" id="st-page-format" class="dt-input" value="{n} / {total}" style="width:auto;flex:1" />
            </div>
          </div>

          <div class="dt-section-header collapsed" data-section="st-header">
            <span>Header</span>
            <i data-feather="chevron-down" class="dt-chevron"></i>
          </div>
          <div class="dt-section-body collapsed" id="st-header">
            <div class="dt-row">
              <label>Show</label>
              <input type="checkbox" id="st-header-show" style="accent-color:var(--da-secondary)" />
            </div>
            <div class="dt-row">
              <label>Text</label>
              <input type="text" id="st-header-text" class="dt-input" placeholder="Header text" style="width:auto;flex:1" />
            </div>
            <div class="dt-color-row">
              <label>Bg Color</label>
              <input type="color" id="st-header-bg-color" value="#ffffff" />
              <input type="text" id="st-header-bg-color-text" class="dt-input-sm" placeholder="transparent" />
            </div>
            <div class="dt-row">
              <label>Font Size</label>
              <input type="number" id="st-header-font-size" class="dt-input-sm" min="8" max="36" value="12" />
              <span style="font-size:11px;color:var(--app-text-secondary)">px</span>
            </div>
          </div>

          <div class="dt-section-header collapsed" data-section="st-footer">
            <span>Footer</span>
            <i data-feather="chevron-down" class="dt-chevron"></i>
          </div>
          <div class="dt-section-body collapsed" id="st-footer">
            <div class="dt-row">
              <label>Show</label>
              <input type="checkbox" id="st-footer-show" style="accent-color:var(--da-secondary)" />
            </div>
            <div class="dt-row">
              <label>Text</label>
              <input type="text" id="st-footer-text" class="dt-input" placeholder="Footer text" style="width:auto;flex:1" />
            </div>
            <div class="dt-color-row">
              <label>Bg Color</label>
              <input type="color" id="st-footer-bg-color" value="#ffffff" />
              <input type="text" id="st-footer-bg-color-text" class="dt-input-sm" placeholder="transparent" />
            </div>
            <div class="dt-row">
              <label>Font Size</label>
              <input type="number" id="st-footer-font-size" class="dt-input-sm" min="8" max="36" value="12" />
              <span style="font-size:11px;color:var(--app-text-secondary)">px</span>
            </div>
          </div>
        </div>
      </div>
      <div class="gutter" id="gutter"></div>
      <div class="preview-panel" id="preview-panel">
        <div class="panel-header">Preview</div>
        <div class="slide-navigator" id="slide-navigator"></div>
        <div class="panel-content">
          <iframe id="preview-container" frameborder="0" aria-label="スライドプレビュー" title="スライドプレビュー"></iframe>
        </div>
      </div>
    </div>

    <!-- Presentation Overlay (hidden by default) -->
    <div class="presentation-overlay" id="presentation-overlay" style="display: none;">
      <iframe id="presentation-iframe" frameborder="0"></iframe>
      <div class="presentation-controls">
        <button id="pres-prev-btn" title="前のスライド">Prev</button>
        <span id="pres-counter">0 / 0</span>
        <button id="pres-next-btn" title="次のスライド">Next</button>
        <button id="pres-exit-btn" title="終了 (Esc)">Exit</button>
      </div>
    </div>

    <script>
    (function() {
      'use strict';

      // ========================================
      // CONFIG
      // ========================================
      var CONFIG = {
        defaultLayout: 'lr',
        storageKey: 'slidesCode',
        layoutStorageKey: 'slidesLayout',
        themeStorageKey: 'slidesTheme',
        aspectRatioStorageKey: 'slidesAspectRatio',
        settingsStorageKey: 'slidesSettings',
        debounceDelay: 300,
        designSyncDelay: 600,
        layouts: { lr: 'Left-Right', tb: 'Top-Bottom', po: 'Preview Only' },
        defaultTemplate: '# Presentation Title\n\nYour Name \u2014 Date\n\n---\n\n## Table of Contents\n\n1. Introduction\n2. Main Topic\n3. Details\n4. Summary\n\n---\n\n## Introduction\n\n- Background context here\n- Key motivation\n- What we\'ll cover\n\n---\n\n## Main Content\n\n### Key Point\n\nDetailed explanation goes here.\n\n- Supporting point 1\n- Supporting point 2\n- Supporting point 3\n\n---\n\n## Thank You\n\nQuestions & Discussion'
      };

      // ========================================
      // UTILITIES
      // ========================================
      var ErrorHandler = {
        log: function(error, context) {
          console.error('[Slides' + (context ? ' - ' + context : '') + ']', error);
        },
        showPreviewError: function(error) {
          var iframeDoc = elements.previewContainer.contentDocument ||
            (elements.previewContainer.contentWindow && elements.previewContainer.contentWindow.document);
          if (!iframeDoc) return;
          iframeDoc.open();
          iframeDoc.write(
            '<div style="padding:20px;background:#fff3cd;border:1px solid #ffeaa7;color:#856404;font-family:system-ui">' +
            '<h3 style="margin-top:0">Preview Error</h3>' +
            '<pre style="background:#f8f9fa;padding:10px;border-radius:4px;overflow-x:auto">' +
            escHtml(error.message || String(error)) + '</pre></div>'
          );
          iframeDoc.close();
        },
        handle: function(error, context, showToUser) {
          ErrorHandler.log(error, context);
          if (showToUser && context === 'preview') ErrorHandler.showPreviewError(error);
        }
      };

      var debounce = window._ ? _.debounce : function(func, delay) {
        var timeoutId;
        return function() {
          var args = arguments, self = this;
          clearTimeout(timeoutId);
          timeoutId = setTimeout(function() { func.apply(self, args); }, delay);
        };
      };

      function escHtml(str) {
        return (str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
      }

      function doTouchDrag(ev) { doDrag(ev.touches[0]); }

      function colorToHex(color) {
        if (!color || color === 'transparent' || color === 'rgba(0, 0, 0, 0)') return '';
        var match = color.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
        if (!match) return color;
        return '#' + [match[1], match[2], match[3]].map(function(x) {
          return parseInt(x).toString(16).padStart(2, '0');
        }).join('');
      }

      function parsePixelValue(val) {
        return parseInt(val) || 0;
      }

      function beautifyHtml(html) {
        if (typeof html_beautify === 'function') {
          return html_beautify(html, {
            indent_size: 2,
            wrap_line_length: 0,
            preserve_newlines: true,
            max_preserve_newlines: 2,
            indent_inner_html: true
          });
        }
        return html;
      }

      // ========================================
      // DOM ELEMENTS
      // ========================================
      var elements = {
        splitView: document.getElementById('split-view'),
        editorContainer: document.getElementById('editor-container'),
        previewPanel: document.getElementById('preview-panel'),
        gutter: document.getElementById('gutter'),
        htmlEditor: document.getElementById('html-editor'),
        previewContainer: document.getElementById('preview-container'),
        layoutLrBtn: document.getElementById('layout-lr-btn'),
        layoutTbBtn: document.getElementById('layout-tb-btn'),
        layoutPoBtn: document.getElementById('layout-po-btn'),
        undoBtn: document.getElementById('undo-btn'),
        redoBtn: document.getElementById('redo-btn'),
        copyBtn: document.getElementById('copy-btn'),
        pasteBtn: document.getElementById('paste-btn'),
        clearBtn: document.getElementById('clear-btn'),
        openBtn: document.getElementById('open-btn'),
        fileInput: document.getElementById('file-input'),
        saveBtn: document.getElementById('save-btn'),
        themeToggleBtn: document.getElementById('theme-toggle-btn'),
        themeToggleIcon: document.getElementById('theme-toggle-icon'),
        designModeBtn: document.getElementById('design-mode-btn'),
        tabCode: document.getElementById('tab-code'),
        tabDesign: document.getElementById('tab-design'),
        codePanel: document.getElementById('code-panel'),
        designToolbar: document.getElementById('design-toolbar'),
        tabSettings: document.getElementById('tab-settings'),
        settingsPanel: document.getElementById('settings-panel'),
        // Settings panel elements
        stThemePreset: document.getElementById('st-theme-preset'),
        stBgColor: document.getElementById('st-bg-color'),
        stBgColorText: document.getElementById('st-bg-color-text'),
        stTextColor: document.getElementById('st-text-color'),
        stTextColorText: document.getElementById('st-text-color-text'),
        stHeadingColor: document.getElementById('st-heading-color'),
        stHeadingColorText: document.getElementById('st-heading-color-text'),
        stAccentColor: document.getElementById('st-accent-color'),
        stAccentColorText: document.getElementById('st-accent-color-text'),
        stFontFamily: document.getElementById('st-font-family'),
        stPageShow: document.getElementById('st-page-show'),
        stPagePosition: document.getElementById('st-page-position'),
        stPageFormat: document.getElementById('st-page-format'),
        stHeaderShow: document.getElementById('st-header-show'),
        stHeaderText: document.getElementById('st-header-text'),
        stHeaderBgColor: document.getElementById('st-header-bg-color'),
        stHeaderBgColorText: document.getElementById('st-header-bg-color-text'),
        stHeaderFontSize: document.getElementById('st-header-font-size'),
        stFooterShow: document.getElementById('st-footer-show'),
        stFooterText: document.getElementById('st-footer-text'),
        stFooterBgColor: document.getElementById('st-footer-bg-color'),
        stFooterBgColorText: document.getElementById('st-footer-bg-color-text'),
        stFooterFontSize: document.getElementById('st-footer-font-size'),
        // Design toolbar elements
        dtElementTag: document.getElementById('dt-element-tag'),
        dtActions: document.getElementById('dt-actions'),
        dtHint: document.getElementById('dt-hint'),
        dtControls: document.getElementById('dt-controls'),
        dtAddDropdown: document.getElementById('dt-add-dropdown'),
        dtBreadcrumb: document.getElementById('dt-breadcrumb'),
        // Color inputs
        dtBgColor: document.getElementById('dt-bg-color'),
        dtBgColorText: document.getElementById('dt-bg-color-text'),
        dtBgTransparent: document.getElementById('dt-bg-transparent'),
        dtTextColor: document.getElementById('dt-text-color'),
        dtTextColorText: document.getElementById('dt-text-color-text'),
        dtBorderColor: document.getElementById('dt-border-color'),
        dtBorderColorText: document.getElementById('dt-border-color-text'),
        // Typography
        dtFontSizeSlider: document.getElementById('dt-font-size-slider'),
        dtFontSize: document.getElementById('dt-font-size'),
        dtFontWeight: document.getElementById('dt-font-weight'),
        dtTextAlignGroup: document.getElementById('dt-text-align-group'),
        dtLineHeightSlider: document.getElementById('dt-line-height-slider'),
        dtLineHeight: document.getElementById('dt-line-height'),
        // Spacing
        dtPaddingTop: document.getElementById('dt-padding-top'),
        dtPaddingRight: document.getElementById('dt-padding-right'),
        dtPaddingBottom: document.getElementById('dt-padding-bottom'),
        dtPaddingLeft: document.getElementById('dt-padding-left'),
        dtMarginTop: document.getElementById('dt-margin-top'),
        dtMarginRight: document.getElementById('dt-margin-right'),
        dtMarginBottom: document.getElementById('dt-margin-bottom'),
        dtMarginLeft: document.getElementById('dt-margin-left'),
        dtPaddingLink: document.getElementById('dt-padding-link'),
        dtMarginLink: document.getElementById('dt-margin-link'),
        // Box
        dtWidth: document.getElementById('dt-width'),
        dtHeight: document.getElementById('dt-height'),
        dtBorderRadiusSlider: document.getElementById('dt-border-radius-slider'),
        dtBorderRadius: document.getElementById('dt-border-radius'),
        dtOpacitySlider: document.getElementById('dt-opacity-slider'),
        dtOpacityValue: document.getElementById('dt-opacity-value'),
        dtDisplay: document.getElementById('dt-display'),
        dtOverflow: document.getElementById('dt-overflow'),
        // Slide-specific
        prevSlideBtn: document.getElementById('prev-slide-btn'),
        nextSlideBtn: document.getElementById('next-slide-btn'),
        addSlideBtn: document.getElementById('add-slide-btn'),
        slideCounter: document.getElementById('slide-counter'),
        slideNavigator: document.getElementById('slide-navigator'),
        aspect169Btn: document.getElementById('aspect-16-9-btn'),
        aspect43Btn: document.getElementById('aspect-4-3-btn'),
        presentBtn: document.getElementById('present-btn'),
        printBtn: document.getElementById('print-btn'),
        // Presentation overlay
        presentationOverlay: document.getElementById('presentation-overlay'),
        presentationIframe: document.getElementById('presentation-iframe'),
        presCounter: document.getElementById('pres-counter'),
        presPrevBtn: document.getElementById('pres-prev-btn'),
        presNextBtn: document.getElementById('pres-next-btn'),
        presExitBtn: document.getElementById('pres-exit-btn')
      };

      // ========================================
      // STATE
      // ========================================
      var THEME_PRESETS = {
        'default':   { backgroundColor: '#ffffff', textColor: '#1e1f25', headingColor: '#1e1f25', accentColor: '#5b8fcc' },
        'dark':      { backgroundColor: '#1e1f25', textColor: '#e2e4ec', headingColor: '#f0f1f5', accentColor: '#6fa8e0' },
        'corporate': { backgroundColor: '#ffffff', textColor: '#2d3748', headingColor: '#1a365d', accentColor: '#2b6cb0' },
        'minimal':   { backgroundColor: '#fafafa', textColor: '#333333', headingColor: '#111111', accentColor: '#888888' },
        'warm':      { backgroundColor: '#fef8f0', textColor: '#4a3728', headingColor: '#2d1f12', accentColor: '#c57b3a' },
        'ocean':     { backgroundColor: '#f0f7ff', textColor: '#1a3a5c', headingColor: '#0d2137', accentColor: '#1e88e5' }
      };

      function getDefaultSlideSettings() {
        return {
          theme: 'default',
          backgroundColor: '#ffffff',
          fontFamily: '"Noto Sans JP", system-ui, sans-serif',
          textColor: '#1e1f25',
          headingColor: '#1e1f25',
          accentColor: '#5b8fcc',
          showPageNumbers: false,
          pageNumberPosition: 'bottom-right',
          pageNumberFormat: '{n} / {total}',
          header: { text: '', show: false, backgroundColor: 'transparent', fontSize: 12 },
          footer: { text: '', show: false, backgroundColor: 'transparent', fontSize: 12 }
        };
      }

      var state = {
        currentLayout: CONFIG.defaultLayout,
        currentTheme: 'light',
        isDragging: false,
        dragContext: {},
        designMode: false,
        activeTab: 'code',
        currentSlide: 0,
        slides: [],
        aspectRatio: '16:9',
        separatorLines: [],
        presenting: false,
        presentationSlide: 0,
        syncingFromDesign: false,
        designToken: (crypto && crypto.randomUUID) ? crypto.randomUUID() : Math.random().toString(36).slice(2),
        paddingLinked: false,
        marginLinked: false,
        addDropdownOpen: false,
        copiedStyles: null,
        designHighlightMarks: [],
        slideSettings: getDefaultSlideSettings()
      };

      // ========================================
      // INITIALIZATION
      // ========================================
      function initialize() {
        elements.htmlEditor = CodeMirror.fromTextArea(elements.htmlEditor, {
          lineNumbers: true,
          mode: 'markdown',
          lineWrapping: true,
          foldGutter: true,
          gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter'],
          styleActiveLine: true,
          extraKeys: {
            'Enter': 'newlineAndIndentContinueMarkdownList',
            'Alt-F': 'findPersistent'
          }
        });
        loadSavedCode();

        var savedTheme;
        try { savedTheme = localStorage.getItem(CONFIG.themeStorageKey); } catch(e) {}
        applyTheme(savedTheme === 'dark' ? 'dark' : 'light');

        try {
          var savedLayout = localStorage.getItem(CONFIG.layoutStorageKey);
          if (savedLayout && CONFIG.layouts[savedLayout]) state.currentLayout = savedLayout;
        } catch(e) {}
        applyLayout(state.currentLayout);

        // Load aspect ratio
        try {
          var savedAspect = localStorage.getItem(CONFIG.aspectRatioStorageKey);
          if (savedAspect === '4:3') state.aspectRatio = '4:3';
        } catch(e) {}
        updateAspectRatioButtons();

        updatePreview();

        // Editor change handler
        elements.htmlEditor.on('change', handleEditorInput);

        // Cursor activity handler for slide tracking
        elements.htmlEditor.on('cursorActivity', handleCursorActivity);

        // Gutter resize
        elements.gutter.addEventListener('mousedown', startDrag);
        elements.gutter.addEventListener('touchstart', function(e) { e.preventDefault(); startDrag(e.touches[0]); });

        // Layout buttons
        elements.layoutLrBtn.addEventListener('click', function() { applyLayout('lr'); });
        elements.layoutTbBtn.addEventListener('click', function() { applyLayout('tb'); });
        elements.layoutPoBtn.addEventListener('click', function() { applyLayout('po'); });

        // Editor operation buttons
        elements.undoBtn.addEventListener('click', undoEditor);
        elements.redoBtn.addEventListener('click', redoEditor);
        elements.copyBtn.addEventListener('click', copyEditor);
        elements.pasteBtn.addEventListener('click', pasteEditor);
        elements.clearBtn.addEventListener('click', clearEditor);

        // File I/O
        elements.openBtn.addEventListener('click', function() { elements.fileInput.click(); });
        elements.fileInput.addEventListener('change', function(e) {
          loadFromFile(e.target.files[0]);
          e.target.value = '';
        });
        elements.editorContainer.addEventListener('dragover', function(e) { e.preventDefault(); });
        elements.editorContainer.addEventListener('drop', function(e) {
          e.preventDefault();
          loadFromFile(e.dataTransfer.files[0]);
        });
        elements.saveBtn.addEventListener('click', saveToFile);

        // Theme
        elements.themeToggleBtn.addEventListener('click', function() {
          applyTheme(state.currentTheme === 'dark' ? 'light' : 'dark');
        });

        // Slide navigation
        elements.prevSlideBtn.addEventListener('click', function() { navigateSlide(-1); });
        elements.nextSlideBtn.addEventListener('click', function() { navigateSlide(1); });
        elements.addSlideBtn.addEventListener('click', addSlide);

        // Aspect ratio
        elements.aspect169Btn.addEventListener('click', function() { setAspectRatio('16:9'); });
        elements.aspect43Btn.addEventListener('click', function() { setAspectRatio('4:3'); });

        // Design Mode (Phase 4 placeholder)
        elements.designModeBtn.addEventListener('click', toggleDesignMode);

        // Tab switching
        elements.tabCode.addEventListener('click', function() { switchTab('code'); });
        elements.tabDesign.addEventListener('click', function() { switchTab('design'); });
        elements.tabSettings.addEventListener('click', function() { switchTab('settings'); });

        // Move design toolbar and settings panel into editor container
        elements.editorContainer.appendChild(elements.designToolbar);
        elements.editorContainer.appendChild(elements.settingsPanel);

        // Load slide settings
        loadSlideSettings();
        initSettingsEvents();

        // Presentation / Print
        elements.presentBtn.addEventListener('click', enterPresentationMode);
        elements.printBtn.addEventListener('click', handlePrint);
        elements.presExitBtn.addEventListener('click', exitPresentationMode);
        elements.presPrevBtn.addEventListener('click', function() {
          navigatePresentationSlide(-1);
        });
        elements.presNextBtn.addEventListener('click', function() {
          navigatePresentationSlide(1);
        });

        // Design toolbar events
        initDesignToolbarEvents();

        // postMessage listener for design mode
        window.addEventListener('message', handleDesignMessage);

        // Close add-child dropdown on outside click
        document.addEventListener('click', function(e) {
          if (state.addDropdownOpen && !e.target.closest('#dt-add-child') && !e.target.closest('#dt-add-dropdown')) {
            elements.dtAddDropdown.style.display = 'none';
            state.addDropdownOpen = false;
          }
        });

        // Keyboard
        document.addEventListener('keydown', handleKeyboard, true);

        // Toolbar button keyboard support
        var allButtons = document.querySelectorAll('.toolbar-button');
        allButtons.forEach(function(btn) {
          btn.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); btn.click(); }
          });
        });
      }

      var debouncedSaveCode = debounce(saveCode, CONFIG.debounceDelay);
      var debouncedUpdatePreview = debounce(updatePreview, CONFIG.debounceDelay);
      var debouncedDesignSync = debounce(syncDesignToEditor, CONFIG.designSyncDelay);

      // ========================================
      // EDITOR INPUT
      // ========================================
      function handleEditorInput() {
        if (state.syncingFromDesign) {
          state.syncingFromDesign = false;
          return;
        }
        debouncedUpdatePreview();
        debouncedSaveCode();
      }

      // ========================================
      // CURSOR ACTIVITY
      // ========================================
      function handleCursorActivity() {
        if (state.designMode) return;
        var cursor = elements.htmlEditor.getCursor();
        var line = cursor.line;
        var slideIndex = 0;
        for (var i = 0; i < state.slides.length; i++) {
          if (line >= state.slides[i].startLine && line <= state.slides[i].endLine) {
            slideIndex = i;
            break;
          }
        }
        if (slideIndex !== state.currentSlide) {
          state.currentSlide = slideIndex;
          updateSlideCounter();
          updateSlideNavigator();
          scrollToCurrentSlide();
        }
      }

      // ========================================
      // KEYBOARD SHORTCUTS
      // ========================================
      function handleKeyboard(e) {
        if (e.ctrlKey && e.key === 's') {
          e.preventDefault();
          saveToFile();
        }
        else if (e.ctrlKey && e.shiftKey && e.key === 'C') {
          e.preventDefault();
          copyEditor();
        }
        else if (e.ctrlKey && !e.shiftKey && e.key === 'z') {
          e.preventDefault();
          undoEditor();
        }
        else if ((e.ctrlKey && e.key === 'y') || (e.ctrlKey && e.shiftKey && e.key === 'Z')) {
          e.preventDefault();
          redoEditor();
        }
        else if (e.ctrlKey && e.key === 'Delete') {
          e.preventDefault();
          clearEditor();
        }
        else if (e.ctrlKey && e.key === '1') {
          e.preventDefault();
          applyLayout('lr');
        }
        else if (e.ctrlKey && e.key === '2') {
          e.preventDefault();
          applyLayout('tb');
        }
        else if (e.ctrlKey && e.key === '3') {
          e.preventDefault();
          applyLayout('po');
        }
        else if (e.ctrlKey && !e.shiftKey && (e.key === 'd' || e.key === 'D')) {
          e.preventDefault();
          e.stopPropagation();
          toggleDesignMode();
        }
        else if (e.key === 'F5') {
          e.preventDefault();
          if (state.presenting) {
            exitPresentationMode();
          } else {
            enterPresentationMode();
          }
        }
        else if (e.ctrlKey && (e.key === 'p' || e.key === 'P') && !e.shiftKey) {
          e.preventDefault();
          handlePrint();
        }
        else if (e.ctrlKey && !e.shiftKey && e.key === 'Enter') {
          e.preventDefault();
          navigateSlide(1);
        }
        else if (e.ctrlKey && e.shiftKey && e.key === 'Enter') {
          e.preventDefault();
          navigateSlide(-1);
        }
        else if (e.key === 'Escape' && state.presenting) {
          e.preventDefault();
          exitPresentationMode();
        }
      }

      // ========================================
      // LAYOUT
      // ========================================
      function applyLayout(mode) {
        state.currentLayout = mode;
        try { localStorage.setItem(CONFIG.layoutStorageKey, mode); } catch(e) {}
        elements.splitView.className = 'split-view layout-' + mode;
        elements.editorContainer.style.width = '';
        elements.editorContainer.style.height = '';
        elements.previewPanel.style.width = '';
        elements.previewPanel.style.height = '';
        [elements.layoutLrBtn, elements.layoutTbBtn, elements.layoutPoBtn].forEach(function(b) { b.classList.remove('active'); });
        if (mode === 'lr') { elements.layoutLrBtn.classList.add('active'); elements.editorContainer.style.width = '50%'; elements.previewPanel.style.width = '50%'; }
        else if (mode === 'tb') { elements.layoutTbBtn.classList.add('active'); elements.editorContainer.style.height = '50%'; elements.previewPanel.style.height = '50%'; }
        else if (mode === 'po') { elements.layoutPoBtn.classList.add('active'); }
      }

      // ========================================
      // THEME
      // ========================================
      function applyTheme(theme) {
        state.currentTheme = theme;
        document.documentElement.setAttribute('data-theme', theme);
        try { localStorage.setItem(CONFIG.themeStorageKey, theme); } catch(e) {}
        var btn = elements.themeToggleBtn;
        if (btn && typeof feather !== 'undefined') {
          btn.classList.add('theme-icon-spin');
          var oldIcon = btn.querySelector('svg, [data-feather]');
          if (oldIcon) oldIcon.remove();
          var newIcon = document.createElement('i');
          newIcon.id = 'theme-toggle-icon';
          newIcon.setAttribute('data-feather', theme === 'dark' ? 'sun' : 'moon');
          btn.appendChild(newIcon);
          feather.replace();
          setTimeout(function() { btn.classList.remove('theme-icon-spin'); }, 400);
        }
      }

      // ========================================
      // SLIDE ENGINE (Phase 2)
      // ========================================

      /**
       * Parse editor content into slides split by --- separator lines.
       * Returns array of { content, type, startLine, endLine }.
       */
      function parseSlides() {
        var code = elements.htmlEditor.getValue();
        var lines = code.split('\n');
        var slides = [];
        var currentContent = [];
        var startLine = 0;
        var separatorRegex = /^\s*---\s*$/;

        for (var i = 0; i < lines.length; i++) {
          if (separatorRegex.test(lines[i])) {
            // End current slide
            slides.push({
              content: currentContent.join('\n'),
              type: detectSlideType(currentContent.join('\n')),
              startLine: startLine,
              endLine: i > 0 ? i - 1 : 0
            });
            currentContent = [];
            startLine = i + 1;
          } else {
            currentContent.push(lines[i]);
          }
        }

        // Push remaining content as last slide
        if (currentContent.length > 0 || startLine <= lines.length - 1) {
          slides.push({
            content: currentContent.join('\n'),
            type: detectSlideType(currentContent.join('\n')),
            startLine: startLine,
            endLine: lines.length - 1
          });
        }

        // Ensure at least one slide
        if (slides.length === 0) {
          slides.push({
            content: '',
            type: 'md',
            startLine: 0,
            endLine: 0
          });
        }

        return slides;
      }

      /**
       * Detect if slide content is HTML or Markdown.
       */
      function detectSlideType(content) {
        var htmlTagPattern = /<(div|p|h[1-6]|style|span|section|article|header|footer|nav|main|table|ul|ol|form|input|button|img|a|br|hr)\b/i;
        if (htmlTagPattern.test(content)) {
          return 'html';
        }
        return 'md';
      }

      /**
       * Render slide content based on its type.
       */
      function renderSlideContent(content, type) {
        var hasMarked = typeof window.marked !== 'undefined';
        var hasDOMPurify = typeof window.DOMPurify !== 'undefined';
        if (hasMarked && hasDOMPurify) {
          var raw = marked.parse(content, { breaks: true, gfm: true });
          return DOMPurify.sanitize(raw, {
            ADD_TAGS: ['style'],
            ADD_ATTR: ['style'],
            FORCE_BODY: true
          });
        }
        if (hasMarked) {
          return marked.parse(content, { breaks: true, gfm: true });
        }
        // Fallback: escape and wrap in paragraphs
        return '<p>' + escHtml(content).replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>') + '</p>';
      }

      /**
       * Build CSS overrides from slide settings.
       */
      var ALLOWED_FONTS = {
        '"Noto Sans JP", system-ui, sans-serif': true,
        'system-ui, sans-serif': true,
        'Georgia, serif': true,
        '"Helvetica Neue", Arial, sans-serif': true
      };

      function safeFontFamily(val) {
        return ALLOWED_FONTS[val] ? val : '"Noto Sans JP", system-ui, sans-serif';
      }

      function escCssValue(val) {
        return String(val || '').replace(/[{};\\<>"'()]/g, '');
      }

      function buildSlideSettingsCSS() {
        var s = state.slideSettings;
        var css = '';
        css += '.slide{background:' + escCssValue(s.backgroundColor) + ';color:' + escCssValue(s.textColor) + ';font-family:' + safeFontFamily(s.fontFamily) + '}\n';
        css += '.slide h1,.slide h2,.slide h3,.slide h4{color:' + escCssValue(s.headingColor) + '}\n';
        css += '.slide a{color:' + escCssValue(s.accentColor) + '}\n';
        css += '.slide blockquote{border-left-color:' + escCssValue(s.accentColor) + '}\n';
        css += '.slide th{background:' + escCssValue(s.accentColor) + '18}\n';
        css += '.slide-chrome{position:absolute;color:' + escCssValue(s.textColor) + ';opacity:0.5;pointer-events:none;z-index:1}\n';
        var headerFs = parseInt(s.header.fontSize, 10) || 12;
        var headerBg = s.header.backgroundColor && s.header.backgroundColor !== 'transparent'
          ? 'background:' + escCssValue(s.header.backgroundColor) + ';padding:4px 12px;border-radius:4px;' : '';
        css += '.slide-chrome-header{top:12px;left:64px;right:64px;text-align:center;font-size:' + headerFs + 'px;' + headerBg + '}\n';
        var footerFs = parseInt(s.footer.fontSize, 10) || 12;
        var footerBg = s.footer.backgroundColor && s.footer.backgroundColor !== 'transparent'
          ? 'background:' + escCssValue(s.footer.backgroundColor) + ';padding:4px 12px;border-radius:4px;' : '';
        var footerBottom = 12;
        if (s.showPageNumbers && s.pageNumberPosition === 'bottom-center') {
          footerBottom = 28;
        }
        css += '.slide-chrome-footer{bottom:' + footerBottom + 'px;left:64px;right:64px;text-align:center;font-size:' + footerFs + 'px;' + footerBg + '}\n';
        css += '.slide-chrome-page-number{bottom:12px;font-size:12px;font-variant-numeric:tabular-nums}\n';
        css += '.slide-chrome-page-number.pos-bottom-left{left:64px}\n';
        css += '.slide-chrome-page-number.pos-bottom-center{left:50%;transform:translateX(-50%)}\n';
        css += '.slide-chrome-page-number.pos-bottom-right{right:64px}\n';
        return css;
      }

      /**
       * Build a complete HTML document for the iframe with all slides.
       */
      function buildIframeDocument(slides, aspectRatio) {
        var slideHeight = aspectRatio === '4:3' ? '7.5in' : '5.625in';
        var printPageSize = aspectRatio === '4:3' ? '10in 7.5in' : '10in 5.625in';

        var html = '<!DOCTYPE html>\n<html lang="ja">\n<head>\n' +
          '<meta charset="UTF-8">\n' +
          '<meta name="viewport" content="width=device-width, initial-scale=1.0">\n' +
          '<link rel="preconnect" href="https://fonts.googleapis.com">\n' +
          '<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>\n' +
          '<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">\n' +
          '<style>\n' +
          '* { margin: 0; padding: 0; box-sizing: border-box; }\n' +
          'body { background: #e8e8e8; font-family: "Noto Sans JP", system-ui, sans-serif; }\n' +
          '.slide {\n' +
          '  width: 10in;\n' +
          '  height: ' + slideHeight + ';\n' +
          '  background: #fff;\n' +
          '  overflow: hidden;\n' +
          '  box-sizing: border-box;\n' +
          '  padding: 48px 64px;\n' +
          '  box-shadow: 0 4px 16px rgba(0,0,0,0.15);\n' +
          '  position: relative;\n' +
          '  font-size: 20px;\n' +
          '  line-height: 1.6;\n' +
          '  font-family: "Noto Sans JP", system-ui, sans-serif;\n' +
          '  margin: 20px auto;\n' +
          '}\n' +
          '.slide h1 { font-size: 2em; margin-bottom: 0.5em; font-weight: 700; color: #1e1f25; }\n' +
          '.slide h2 { font-size: 1.5em; margin-bottom: 0.4em; font-weight: 600; color: #282a32; }\n' +
          '.slide h3 { font-size: 1.2em; margin-bottom: 0.3em; font-weight: 600; color: #353842; }\n' +
          '.slide h4 { font-size: 1.05em; margin-bottom: 0.3em; font-weight: 500; }\n' +
          '.slide ul, .slide ol { margin-left: 1.5em; margin-bottom: 0.5em; }\n' +
          '.slide li { margin-bottom: 0.3em; }\n' +
          '.slide p { margin-bottom: 0.6em; }\n' +
          '.slide code { background: #f0f1f5; padding: 2px 6px; border-radius: 3px; font-size: 0.85em; font-family: "Noto Sans Mono", Consolas, monospace; }\n' +
          '.slide pre { background: #1e1f25; color: #f0f1f5; padding: 16px; border-radius: 8px; overflow-x: auto; margin-bottom: 0.6em; }\n' +
          '.slide pre code { background: none; padding: 0; color: inherit; }\n' +
          '.slide img { max-width: 100%; border-radius: 4px; }\n' +
          '.slide blockquote { border-left: 4px solid #5b8fcc; padding-left: 16px; color: #4a4e5c; margin-bottom: 0.6em; }\n' +
          '.slide table { border-collapse: collapse; width: 100%; margin-bottom: 0.6em; }\n' +
          '.slide th, .slide td { border: 1px solid #e2e4ec; padding: 8px 12px; text-align: left; }\n' +
          '.slide th { background: #f0f1f5; font-weight: 600; }\n' +
          '.slide a { color: #5b8fcc; text-decoration: none; }\n' +
          '.slide a:hover { text-decoration: underline; }\n' +
          '.slide hr { border: none; border-top: 1px solid #e2e4ec; margin: 1em 0; }\n' +
          '.slide strong { font-weight: 700; }\n' +
          '.slide em { font-style: italic; }\n' +
          '@media print {\n' +
          '  body { background: #fff; }\n' +
          '  @page { size: ' + printPageSize + '; margin: 0; }\n' +
          '  .slide {\n' +
          '    break-after: page;\n' +
          '    page-break-after: always;\n' +
          '    -webkit-print-color-adjust: exact;\n' +
          '    print-color-adjust: exact;\n' +
          '    box-shadow: none;\n' +
          '    margin: 0;\n' +
          '  }\n' +
          '  .slide:last-child {\n' +
          '    break-after: auto;\n' +
          '    page-break-after: auto;\n' +
          '  }\n' +
          '}\n' +
          '</style>\n' +
          '<style>\n' + buildSlideSettingsCSS() + '</style>\n' +
          '</head>\n<body>\n';

        var ss = state.slideSettings;
        for (var i = 0; i < slides.length; i++) {
          var slideContent = renderSlideContent(slides[i].content, slides[i].type);
          var activeAttr = i === state.currentSlide ? ' data-slide-active="true"' : '';
          var chromeHtml = '';
          if (ss.header.show && ss.header.text) {
            chromeHtml += '<div class="slide-chrome slide-chrome-header" data-slide-chrome="true">' + escHtml(ss.header.text) + '</div>';
          }
          if (ss.footer.show && ss.footer.text) {
            chromeHtml += '<div class="slide-chrome slide-chrome-footer" data-slide-chrome="true">' + escHtml(ss.footer.text) + '</div>';
          }
          if (ss.showPageNumbers) {
            var pageText = ss.pageNumberFormat.replace('{n}', String(i + 1)).replace('{total}', String(slides.length));
            chromeHtml += '<div class="slide-chrome slide-chrome-page-number pos-' + escHtml(ss.pageNumberPosition) + '" data-slide-chrome="true">' + escHtml(pageText) + '</div>';
          }
          html += '<div class="slide" data-slide-index="' + i + '"' + activeAttr + '>\n' +
            slideContent + '\n' + chromeHtml + '</div>\n';
        }

        html += '</body>\n</html>';
        return html;
      }

      // ========================================
      // PREVIEW
      // ========================================
      function updatePreview() {
        state.slides = parseSlides();

        // Clamp current slide index
        if (state.currentSlide >= state.slides.length) {
          state.currentSlide = state.slides.length - 1;
        }
        if (state.currentSlide < 0) {
          state.currentSlide = 0;
        }

        var iframeDoc = elements.previewContainer.contentDocument ||
          (elements.previewContainer.contentWindow && elements.previewContainer.contentWindow.document);
        if (!iframeDoc) return;

        try {
          var htmlDoc = buildIframeDocument(state.slides, state.aspectRatio);
          iframeDoc.open();
          iframeDoc.write(htmlDoc);
          iframeDoc.close();
        } catch(error) {
          ErrorHandler.handle(error, 'preview', true);
        }

        // Re-inject design script if design mode is active
        if (state.designMode) {
          var freshDoc = elements.previewContainer.contentDocument;
          if (freshDoc && freshDoc.body) {
            injectDesignScript(freshDoc);
          }
        }

        // Decorate separator lines in CodeMirror
        decorateSeparatorLines();

        // Update UI
        updateSlideCounter();
        updateSlideNavigator();

        // Scroll preview to current slide
        scrollToCurrentSlide();
      }

      /**
       * Decorate --- separator lines in CodeMirror with a visual style.
       */
      function decorateSeparatorLines() {
        var cm = elements.htmlEditor;
        var separatorRegex = /^\s*---\s*$/;

        // Remove previous decorations
        for (var i = 0; i < state.separatorLines.length; i++) {
          cm.removeLineClass(state.separatorLines[i], 'wrap', 'cm-slide-separator');
        }
        state.separatorLines = [];

        // Add new decorations
        var lineCount = cm.lineCount();
        for (var j = 0; j < lineCount; j++) {
          var lineText = cm.getLine(j);
          if (separatorRegex.test(lineText)) {
            cm.addLineClass(j, 'wrap', 'cm-slide-separator');
            state.separatorLines.push(j);
          }
        }
      }

      // ========================================
      // SLIDE NAVIGATION (Phase 3)
      // ========================================

      /**
       * Update the slide counter display in the toolbar.
       */
      function updateSlideCounter() {
        var total = state.slides.length;
        var current = state.currentSlide + 1;
        elements.slideCounter.textContent = current + ' / ' + total;
      }

      /**
       * Update the slide navigator thumbnail strip.
       */
      function updateSlideNavigator() {
        var nav = elements.slideNavigator;
        nav.innerHTML = '';
        for (var i = 0; i < state.slides.length; i++) {
          var item = document.createElement('button');
          item.className = 'slide-nav-item' + (i === state.currentSlide ? ' active' : '');
          item.textContent = String(i + 1);
          item.title = 'Slide ' + (i + 1);
          item.setAttribute('data-slide-index', String(i));
          item.addEventListener('click', (function(idx) {
            return function() { goToSlide(idx); };
          })(i));
          nav.appendChild(item);
        }
      }

      /**
       * Navigate to the previous or next slide.
       */
      function navigateSlide(direction) {
        var newIndex = state.currentSlide + direction;
        if (newIndex < 0 || newIndex >= state.slides.length) return;
        goToSlide(newIndex);
      }

      /**
       * Go to a specific slide by index.
       */
      function goToSlide(index) {
        if (index < 0 || index >= state.slides.length) return;
        state.currentSlide = index;
        updateSlideCounter();
        updateSlideNavigator();
        scrollToCurrentSlide();
        scrollEditorToSlide(index);
        // Update active attribute in iframe
        updateActiveSlideInIframe();
      }

      /**
       * Update the data-slide-active attribute in the preview iframe.
       */
      function updateActiveSlideInIframe() {
        var iframeDoc = elements.previewContainer.contentDocument;
        if (!iframeDoc) return;
        var allSlides = iframeDoc.querySelectorAll('.slide');
        for (var i = 0; i < allSlides.length; i++) {
          if (i === state.currentSlide) {
            allSlides[i].setAttribute('data-slide-active', 'true');
          } else {
            allSlides[i].removeAttribute('data-slide-active');
          }
        }
      }

      /**
       * Scroll the preview iframe to show the current slide.
       */
      function scrollToCurrentSlide() {
        var iframeDoc = elements.previewContainer.contentDocument;
        if (!iframeDoc) return;
        var slideEl = iframeDoc.querySelector('.slide[data-slide-index="' + state.currentSlide + '"]');
        if (slideEl) {
          slideEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }

      /**
       * Scroll the CodeMirror editor to show the start of the given slide.
       */
      function scrollEditorToSlide(index) {
        if (index < 0 || index >= state.slides.length) return;
        var startLine = state.slides[index].startLine;
        elements.htmlEditor.scrollIntoView({ line: startLine, ch: 0 }, 80);
      }

      /**
       * Insert a new slide separator at the cursor position.
       */
      function addSlide() {
        var cursor = elements.htmlEditor.getCursor();
        var line = cursor.line;
        var lineText = elements.htmlEditor.getLine(line);
        var insertPos;

        // Insert after the current line
        insertPos = { line: line, ch: lineText.length };
        elements.htmlEditor.replaceRange('\n\n---\n\n', insertPos);

        // Move cursor to the new slide content area
        elements.htmlEditor.setCursor({ line: line + 4, ch: 0 });
        elements.htmlEditor.focus();
        showTemporaryMessage('Slide added');
      }

      /**
       * Set the aspect ratio and re-render.
       */
      function setAspectRatio(ratio) {
        state.aspectRatio = ratio;
        try { localStorage.setItem(CONFIG.aspectRatioStorageKey, ratio); } catch(e) {}
        updateAspectRatioButtons();
        updatePreview();
        showTemporaryMessage('Aspect ratio: ' + ratio);
      }

      /**
       * Update the aspect ratio button active states.
       */
      function updateAspectRatioButtons() {
        elements.aspect169Btn.classList.toggle('active', state.aspectRatio === '16:9');
        elements.aspect43Btn.classList.toggle('active', state.aspectRatio === '4:3');
      }

      // ========================================
      // STORAGE
      // ========================================
      function saveCode() {
        try {
          localStorage.setItem(CONFIG.storageKey, elements.htmlEditor.getValue());
        } catch(error) {
          if (error.name === 'QuotaExceededError') showTemporaryMessage('Storage full', 'error');
          ErrorHandler.handle(error, 'save', false);
        }
      }

      function loadSavedCode() {
        try {
          var saved = localStorage.getItem(CONFIG.storageKey);
          if (saved !== null) {
            elements.htmlEditor.setValue(saved);
          } else {
            elements.htmlEditor.setValue(CONFIG.defaultTemplate);
          }
        } catch(error) {
          ErrorHandler.handle(error, 'load', false);
        }
      }

      // ========================================
      // EDITOR OPERATIONS
      // ========================================
      function undoEditor() { elements.htmlEditor.undo(); showTemporaryMessage('Undo'); }
      function redoEditor() { elements.htmlEditor.redo(); showTemporaryMessage('Redo'); }

      function clearEditor() {
        if (elements.htmlEditor.getValue().trim() === '') {
          showTemporaryMessage('Already empty');
          return;
        }
        var last = elements.htmlEditor.lastLine();
        elements.htmlEditor.replaceRange('', {line:0,ch:0}, {line:last,ch:elements.htmlEditor.getLine(last).length});
        updatePreview();
        debouncedSaveCode();
        showTemporaryMessage('Cleared');
      }

      function copyEditor() {
        var content = elements.htmlEditor.getValue();
        if (!content.trim()) { showTemporaryMessage('Nothing to copy'); return; }
        navigator.clipboard.writeText(content).then(
          function() { showTemporaryMessage('Copied to clipboard'); },
          function() { showTemporaryMessage('Copy failed', 'error'); }
        );
      }

      function pasteEditor() {
        navigator.clipboard.readText().then(function(text) {
          if (!text.trim()) { showTemporaryMessage('Clipboard empty', 'error'); return; }
          elements.htmlEditor.setValue(text);
          updatePreview();
          debouncedSaveCode();
          showTemporaryMessage('Pasted from clipboard');
        }, function() {
          showTemporaryMessage('Paste failed', 'error');
        });
      }

      // ========================================
      // FILE I/O
      // ========================================
      function loadFromFile(file) {
        if (!file) return;
        if (file.size > 5 * 1024 * 1024) { showTemporaryMessage('File too large (>5MB)', 'error'); return; }
        var ext = file.name.toLowerCase().slice(file.name.lastIndexOf('.'));
        if (ext !== '.html' && ext !== '.htm' && ext !== '.md') { showTemporaryMessage('HTML/MD files only', 'error'); return; }
        var reader = new FileReader();
        reader.onload = function(e) {
          elements.htmlEditor.setValue(e.target.result);
          updatePreview();
          debouncedSaveCode();
          showTemporaryMessage('File loaded');
        };
        reader.onerror = function() { showTemporaryMessage('Read failed', 'error'); };
        reader.readAsText(file);
      }

      function saveToFile() {
        var content = elements.htmlEditor.getValue();
        var blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });
        var link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'slides.md';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
        showTemporaryMessage('File saved');
      }

      // ========================================
      // GUTTER RESIZE
      // ========================================
      function startDrag(e) {
        state.isDragging = true;
        document.body.classList.add(state.currentLayout === 'tb' ? 'dragging-tb' : 'dragging-lr');
        elements.gutter.classList.add('dragging');
        state.dragContext.startX = e.clientX;
        state.dragContext.startY = e.clientY;
        state.dragContext.editorInitialWidth = elements.editorContainer.offsetWidth;
        state.dragContext.editorInitialHeight = elements.editorContainer.offsetHeight;
        window.addEventListener('mousemove', doDrag);
        window.addEventListener('touchmove', doTouchDrag, {passive:false});
        window.addEventListener('mouseup', stopDrag);
        window.addEventListener('touchend', stopDrag);
        window.addEventListener('mouseleave', stopDrag);
        document.body.style.userSelect = 'none';
        document.body.style.cursor = state.currentLayout === 'tb' ? 'row-resize' : 'col-resize';
        var overlay = document.createElement('div');
        overlay.className = 'resize-overlay';
        document.body.appendChild(overlay);
      }

      function doDrag(e) {
        if (!state.isDragging) return;
        requestAnimationFrame(function() {
          var dx = e.clientX - state.dragContext.startX;
          var dy = e.clientY - state.dragContext.startY;
          if (state.currentLayout === 'lr') {
            var totalW = elements.editorContainer.parentElement.clientWidth - elements.gutter.offsetWidth;
            var newW = Math.max(totalW * 0.1, Math.min(totalW * 0.9, state.dragContext.editorInitialWidth + dx));
            elements.editorContainer.style.width = newW + 'px';
            elements.previewPanel.style.width = (totalW - newW) + 'px';
          } else if (state.currentLayout === 'tb') {
            var totalH = elements.editorContainer.parentElement.clientHeight - elements.gutter.offsetHeight;
            var newH = Math.max(totalH * 0.1, Math.min(totalH * 0.9, state.dragContext.editorInitialHeight + dy));
            elements.editorContainer.style.height = newH + 'px';
            elements.previewPanel.style.height = (totalH - newH) + 'px';
          }
        });
      }

      function stopDrag() {
        if (!state.isDragging) return;
        state.isDragging = false;
        document.body.classList.remove('dragging-lr', 'dragging-tb');
        elements.gutter.classList.remove('dragging');
        window.removeEventListener('mousemove', doDrag);
        window.removeEventListener('touchmove', doTouchDrag);
        window.removeEventListener('mouseup', stopDrag);
        window.removeEventListener('touchend', stopDrag);
        window.removeEventListener('mouseleave', stopDrag);
        document.body.style.userSelect = '';
        document.body.style.cursor = '';
        var overlay = document.querySelector('.resize-overlay');
        if (overlay) document.body.removeChild(overlay);
        state.dragContext = {};
      }

      // ========================================
      // TOAST
      // ========================================
      function showTemporaryMessage(message, type) {
        var existing = document.querySelector('.temp-message');
        if (existing) existing.remove();
        var div = document.createElement('div');
        div.className = 'temp-message' + (type === 'error' ? ' toast-error' : '');
        div.textContent = message;
        div.setAttribute('role', 'status');
        div.setAttribute('aria-live', 'polite');
        document.body.appendChild(div);
        setTimeout(function() {
          div.classList.add('toast-out');
          setTimeout(function() { if (div.parentNode) div.parentNode.removeChild(div); }, 300);
        }, 2000);
      }

      // ========================================
      // TAB SWITCHING
      // ========================================
      function switchTab(tab) {
        if (tab === 'design' && !state.designMode) {
          enableDesignMode();
          return;
        }
        state.activeTab = tab;
        elements.tabCode.classList.toggle('active', tab === 'code');
        elements.tabDesign.classList.toggle('active', tab === 'design');
        elements.tabSettings.classList.toggle('active', tab === 'settings');
        elements.codePanel.style.display = tab === 'code' ? '' : 'none';
        elements.designToolbar.style.display = tab === 'design' ? '' : 'none';
        elements.settingsPanel.style.display = tab === 'settings' ? '' : 'none';
        if (tab === 'code') elements.htmlEditor.refresh();
      }

      // ========================================
      // DESIGN MODE (Phase 4)
      // ========================================
      var EXCLUDED_TAGS = ['HTML', 'HEAD', 'BODY', 'SCRIPT', 'STYLE', 'LINK', 'META', 'TITLE', 'NOSCRIPT', 'BR'];

      function toggleDesignMode() {
        if (state.designMode) {
          disableDesignMode();
        } else {
          enableDesignMode();
        }
      }

      function enableDesignMode() {
        state.designMode = true;
        elements.designModeBtn.classList.add('active');
        elements.previewPanel.classList.add('design-active');
        switchTab('design');
        elements.dtHint.style.display = '';
        elements.dtControls.style.display = 'none';
        elements.dtActions.style.display = 'none';
        elements.dtElementTag.textContent = '--';

        // Inject design script into current iframe
        var iframeDoc = elements.previewContainer.contentDocument;
        if (iframeDoc && iframeDoc.body) {
          injectDesignScript(iframeDoc);
        }
        showTemporaryMessage('Design Mode ON');
      }

      function disableDesignMode() {
        clearDesignHighlights();
        // Final sync before disabling
        var iframeDoc = elements.previewContainer.contentDocument;
        if (iframeDoc && iframeDoc.body) {
          // Clean up selection state in iframe
          var selected = iframeDoc.querySelector('[data-designer-selected]');
          if (selected) selected.removeAttribute('data-designer-selected');
        }

        state.designMode = false;
        elements.designModeBtn.classList.remove('active');
        elements.previewPanel.classList.remove('design-active');
        switchTab('code');

        // Re-render preview from editor (clean state)
        updatePreview();
        showTemporaryMessage('Design Mode OFF');
      }

      function injectDesignScript(iframeDoc) {
        if (!iframeDoc || !iframeDoc.body) return;

        // Remove any existing injected elements
        var existing = iframeDoc.querySelectorAll('[data-designer-injected]');
        existing.forEach(function(el) { el.remove(); });

        // Inject CSS
        var style = iframeDoc.createElement('style');
        style.setAttribute('data-designer-injected', 'true');
        style.textContent =
          '[data-designer-selected]{outline:2px dashed #4a9eff!important;outline-offset:2px!important}' +
          '.designer-hover-overlay{position:fixed;pointer-events:none;background:rgba(74,158,255,0.08);border:1px solid rgba(74,158,255,0.4);z-index:99998;transition:all 50ms}' +
          '.designer-hover-label{position:fixed;pointer-events:none;background:#1e1f25;color:#e2e4ec;font:11px/1.3 "Noto Sans Mono",Consolas,monospace;padding:2px 6px;border-radius:3px;z-index:99999;white-space:nowrap}' +
          '[draggable="true"]{cursor:grab}' +
          '.designer-dragging{opacity:0.3!important}' +
          '.designer-drop-before{box-shadow:inset 0 3px 0 0 #4a9eff!important}' +
          '.designer-drop-after{box-shadow:inset 0 -3px 0 0 #4a9eff!important}' +
          '.designer-drop-inside{outline:2px solid #4a9eff!important;background:rgba(74,158,255,0.06)!important}' +
          '.designer-action-bar{position:fixed;display:flex;gap:2px;background:#1e1f25;border:1px solid #353842;border-radius:6px;padding:3px;z-index:99997;box-shadow:0 4px 12px rgba(0,0,0,0.3)}' +
          '.designer-action-bar button{background:none;border:none;color:#c4c8d6;cursor:pointer;padding:4px 6px;border-radius:4px;line-height:1;display:flex;align-items:center;justify-content:center;min-width:26px;min-height:26px}' +
          '.designer-action-bar button svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}' +
          '.designer-action-bar button:hover{background:#353842;color:#f0f1f5}';
        (iframeDoc.head || iframeDoc.documentElement).appendChild(style);

        // Inject interaction script
        var script = iframeDoc.createElement('script');
        script.setAttribute('data-designer-injected', 'true');
        script.textContent = getDesignModeScript();
        iframeDoc.body.appendChild(script);
      }

      function getDesignModeScript() {
        var token = state.designToken;
        return '(function(){' +
          'var TOKEN="' + token + '";' +
          'var EXCLUDED=new Set(["HTML","HEAD","BODY","SCRIPT","STYLE","LINK","META","TITLE","NOSCRIPT","BR"]);' +

          // Scope check - only active slide elements
          'function isInScope(el){' +
            'while(el){' +
              'if(el.classList&&el.classList.contains("slide")){' +
                'return el.hasAttribute("data-slide-active");' +
              '}' +
              'el=el.parentElement;' +
            '}' +
            'return false;' +
          '}' +

          // Create overlay elements
          'var hoverOverlay=document.createElement("div");' +
          'hoverOverlay.className="designer-hover-overlay";' +
          'hoverOverlay.setAttribute("data-designer-injected","true");' +
          'hoverOverlay.style.display="none";' +
          'document.body.appendChild(hoverOverlay);' +

          'var hoverLabel=document.createElement("div");' +
          'hoverLabel.className="designer-hover-label";' +
          'hoverLabel.setAttribute("data-designer-injected","true");' +
          'hoverLabel.style.display="none";' +
          'document.body.appendChild(hoverLabel);' +

          'var selected=null;' +

          // Helper: get tag info string
          'function tagInfo(el){' +
            'var s=el.tagName.toLowerCase();' +
            'if(el.id)s+="#"+el.id;' +
            'if(el.className&&typeof el.className==="string"){' +
              'var cls=el.className.split(/\\s+/).filter(function(c){return c&&c.indexOf("designer")===-1;});' +
              'if(cls.length)s+="."+cls.join(".");' +
            '}' +
            'return s;' +
          '}' +

          // Helper: check if element is injected
          'function isInjected(el){' +
            'while(el){' +
              'if(el.hasAttribute&&el.hasAttribute("data-designer-injected"))return true;' +
              'el=el.parentElement;' +
            '}' +
            'return false;' +
          '}' +

          // Helper: check if element should be excluded
          'function isExcluded(el){' +
            'return !el||!el.tagName||EXCLUDED.has(el.tagName)||isInjected(el)||(el.hasAttribute&&el.hasAttribute("data-slide-chrome"));' +
          '}' +

          // Hover handler
          'document.addEventListener("mouseover",function(e){' +
            'var el=e.target;' +
            'if(isExcluded(el)){hoverOverlay.style.display="none";hoverLabel.style.display="none";return;}' +
            'var inScope=isInScope(el);' +
            'if(!inScope&&!el.closest(".slide[data-slide-index]")){hoverOverlay.style.display="none";hoverLabel.style.display="none";return;}' +
            'var r=el.getBoundingClientRect();' +
            'hoverOverlay.style.display="block";' +
            'hoverOverlay.style.left=r.left+"px";' +
            'hoverOverlay.style.top=r.top+"px";' +
            'hoverOverlay.style.width=r.width+"px";' +
            'hoverOverlay.style.height=r.height+"px";' +
            'hoverOverlay.style.opacity=inScope?"1":"0.4";' +
            'hoverLabel.style.display="block";' +
            'hoverLabel.textContent=tagInfo(el)+(inScope?"":"  \\u2192 click");' +
            'var lTop=r.top-20;' +
            'if(lTop<2)lTop=r.bottom+4;' +
            'hoverLabel.style.left=Math.max(0,r.left)+"px";' +
            'hoverLabel.style.top=lTop+"px";' +
          '});' +

          'document.addEventListener("mouseout",function(e){' +
            'if(!e.relatedTarget||e.relatedTarget===document.documentElement){' +
              'hoverOverlay.style.display="none";hoverLabel.style.display="none";' +
            '}' +
          '});' +

          // Click handler - select element
          'document.addEventListener("click",function(e){' +
            'var el=e.target;' +
            'if(isInjected(el))return;' +
            'if(isExcluded(el))return;' +
            'e.preventDefault();e.stopPropagation();' +
            // Navigate to non-active slide on click
            'if(!isInScope(el)){' +
              'var slideEl=el.closest(".slide[data-slide-index]");' +
              'if(!slideEl)return;' +
              'var idx=parseInt(slideEl.getAttribute("data-slide-index"));' +
              'if(isNaN(idx))return;' +
              'var path=[];var cur=el;var pathValid=true;' +
              'while(cur&&cur!==slideEl){' +
                'var par=cur.parentElement;if(!par)break;' +
                'var ch=Array.from(par.children).filter(function(c){return !c.hasAttribute("data-designer-injected")&&!c.hasAttribute("data-slide-chrome");});' +
                'var ci=ch.indexOf(cur);if(ci===-1){pathValid=false;break;}' +
                'path.unshift(ci);cur=par;' +
              '}' +
              'if(!pathValid)return;' +
              'parent.postMessage({type:"__design_navigate__",token:TOKEN,slideIndex:idx,elementPath:path},"*");' +
              'return;' +
            '}' +
            // Deselect previous
            'if(selected)selected.removeAttribute("data-designer-selected");' +
            'selected=el;' +
            'el.setAttribute("data-designer-selected","true");' +
            // Get computed styles
            'var cs=window.getComputedStyle(el);' +
            'var styles={' +
              'backgroundColor:cs.backgroundColor,' +
              'color:cs.color,' +
              'borderColor:cs.borderColor,' +
              'fontSize:cs.fontSize,' +
              'fontWeight:cs.fontWeight,' +
              'textAlign:cs.textAlign,' +
              'lineHeight:cs.lineHeight,' +
              'paddingTop:cs.paddingTop,' +
              'paddingRight:cs.paddingRight,' +
              'paddingBottom:cs.paddingBottom,' +
              'paddingLeft:cs.paddingLeft,' +
              'marginTop:cs.marginTop,' +
              'marginRight:cs.marginRight,' +
              'marginBottom:cs.marginBottom,' +
              'marginLeft:cs.marginLeft,' +
              'width:cs.width,' +
              'height:cs.height,' +
              'borderRadius:cs.borderRadius,' +
              'opacity:cs.opacity,' +
              'display:cs.display,' +
              'overflow:cs.overflow' +
            '};' +
            // Build ancestors array
            'var ancestors=[];' +
            'var p=el.parentElement;' +
            'while(p&&p.tagName&&!EXCLUDED.has(p.tagName)){' +
              'ancestors.unshift(tagInfo(p));' +
              'p=p.parentElement;' +
            '}' +
            'parent.postMessage({type:"__design_click__",token:TOKEN,tag:tagInfo(el),styles:styles,ancestors:ancestors,outerHTML:el.outerHTML.substring(0,300),textContent:(el.textContent||"").substring(0,100)},"*");' +
            'showActionBar(el);' +
          '},true);' +

          // Double-click - enable contentEditable for text editing
          'document.addEventListener("dblclick",function(e){' +
            'var el=e.target;' +
            'if(isExcluded(el)||isInjected(el))return;' +
            'if(!isInScope(el))return;' +
            'e.preventDefault();' +
            'el.contentEditable="true";' +
            'el.focus();' +
            'el.addEventListener("paste",function onPaste(pe){' +
              'pe.preventDefault();' +
              'var text=(pe.clipboardData||window.clipboardData).getData("text/plain");' +
              'document.execCommand("insertText",false,text);' +
            '});' +
            'el.addEventListener("blur",function onBlur(){' +
              'el.contentEditable="false";' +
              'el.removeEventListener("blur",onBlur);' +
              'parent.postMessage({type:"__design_change__",token:TOKEN},"*");' +
            '});' +
          '});' +

          // Escape - deselect, Delete - remove
          'document.addEventListener("keydown",function(e){' +
            'if(e.key==="Escape"&&selected){' +
              'selected.removeAttribute("data-designer-selected");' +
              'selected=null;' +
              'parent.postMessage({type:"__design_deselect__",token:TOKEN},"*");' +
            '}' +
            'if(e.key==="Delete"&&selected&&!selected.isContentEditable){' +
              'e.preventDefault();' +
              'var toRemove=selected;' +
              'selected.removeAttribute("data-designer-selected");' +
              'selected=null;' +
              'toRemove.remove();' +
              'parent.postMessage({type:"__design_deselect__",token:TOKEN},"*");' +
              'parent.postMessage({type:"__design_change__",token:TOKEN},"*");' +
            '}' +
          '});' +

          // Floating action bar
          'var actionBar=document.createElement("div");' +
          'actionBar.className="designer-action-bar";' +
          'actionBar.setAttribute("data-designer-injected","true");' +
          'actionBar.style.display="none";' +
          'actionBar.innerHTML=' +
            '"<button data-action=\\"delete\\" title=\\"Delete\\"><svg viewBox=\\"0 0 24 24\\"><polyline points=\\"3 6 5 6 21 6\\"/><path d=\\"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2\\"/><line x1=\\"10\\" y1=\\"11\\" x2=\\"10\\" y2=\\"17\\"/><line x1=\\"14\\" y1=\\"11\\" x2=\\"14\\" y2=\\"17\\"/></svg></button>"' +
            '+"<button data-action=\\"duplicate\\" title=\\"Duplicate\\"><svg viewBox=\\"0 0 24 24\\"><rect x=\\"9\\" y=\\"9\\" width=\\"13\\" height=\\"13\\" rx=\\"2\\" ry=\\"2\\"/><path d=\\"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1\\"/></svg></button>"' +
            '+"<button data-action=\\"move-up\\" title=\\"Move Up\\"><svg viewBox=\\"0 0 24 24\\"><polyline points=\\"18 15 12 9 6 15\\"/></svg></button>"' +
            '+"<button data-action=\\"move-down\\" title=\\"Move Down\\"><svg viewBox=\\"0 0 24 24\\"><polyline points=\\"6 9 12 15 18 9\\"/></svg></button>";' +
          'document.body.appendChild(actionBar);' +

          'function showActionBar(el){' +
            'if(!el){actionBar.style.display="none";return;}' +
            'var r=el.getBoundingClientRect();' +
            'actionBar.style.display="flex";' +
            'var barTop=r.top-34;' +
            'if(barTop<4)barTop=r.bottom+4;' +
            'actionBar.style.left=Math.max(4,r.left)+"px";' +
            'actionBar.style.top=barTop+"px";' +
          '}' +

          'document.addEventListener("scroll",function(){' +
            'if(selected)showActionBar(selected);' +
          '},true);' +

          'actionBar.addEventListener("click",function(e){' +
            'var btn=e.target.closest("[data-action]");' +
            'if(!btn||!selected)return;' +
            'e.preventDefault();e.stopPropagation();' +
            'parent.postMessage({type:"__design_action__",token:TOKEN,action:btn.getAttribute("data-action")},"*");' +
          '});' +

          // Listen for select-ancestor from parent
          'window.addEventListener("message",function(e){' +
            'if(!e.data||e.data.token!==TOKEN)return;' +
            'if(e.data.type==="__design_select_ancestor__"){' +
              'var depth=e.data.depth;' +
              'if(!selected)return;' +
              'var target=selected;' +
              'for(var i=0;i<depth;i++){' +
                'if(target.parentElement&&!EXCLUDED.has(target.parentElement.tagName))target=target.parentElement;' +
                'else break;' +
              '}' +
              'if(isExcluded(target))return;' +
              'if(selected)selected.removeAttribute("data-designer-selected");' +
              'selected=target;' +
              'target.setAttribute("data-designer-selected","true");' +
              'var cs=window.getComputedStyle(target);' +
              'var styles={' +
                'backgroundColor:cs.backgroundColor,color:cs.color,borderColor:cs.borderColor,' +
                'fontSize:cs.fontSize,fontWeight:cs.fontWeight,textAlign:cs.textAlign,' +
                'lineHeight:cs.lineHeight,' +
                'paddingTop:cs.paddingTop,paddingRight:cs.paddingRight,paddingBottom:cs.paddingBottom,paddingLeft:cs.paddingLeft,' +
                'marginTop:cs.marginTop,marginRight:cs.marginRight,marginBottom:cs.marginBottom,marginLeft:cs.marginLeft,' +
                'width:cs.width,height:cs.height,borderRadius:cs.borderRadius,opacity:cs.opacity,display:cs.display,overflow:cs.overflow' +
              '};' +
              'var ancestors=[];' +
              'var p=target.parentElement;' +
              'while(p&&p.tagName&&!EXCLUDED.has(p.tagName)){ancestors.unshift(tagInfo(p));p=p.parentElement;}' +
              'parent.postMessage({type:"__design_click__",token:TOKEN,tag:tagInfo(target),styles:styles,ancestors:ancestors,outerHTML:target.outerHTML.substring(0,300),textContent:(target.textContent||"").substring(0,100)},"*");' +
              'showActionBar(target);' +
            '}' +
            // Navigate to element after slide switch
            'if(e.data.type==="__design_navigate_to__"){' +
              'var navPath=e.data.elementPath;' +
              'var navSlide=document.querySelector(".slide[data-slide-active=\\"true\\"]");' +
              'if(!navSlide||!navPath)return;' +
              'var navTarget=navSlide;' +
              'for(var ni=0;ni<navPath.length;ni++){' +
                'var navCh=Array.from(navTarget.children).filter(function(c){return !c.hasAttribute("data-designer-injected")&&!c.hasAttribute("data-slide-chrome");});' +
                'if(navPath[ni]>=0&&navPath[ni]<navCh.length){navTarget=navCh[navPath[ni]];}' +
                'else break;' +
              '}' +
              'if(navTarget!==navSlide&&!isExcluded(navTarget)){' +
                'if(selected)selected.removeAttribute("data-designer-selected");' +
                'selected=navTarget;' +
                'navTarget.setAttribute("data-designer-selected","true");' +
                'var ncs=window.getComputedStyle(navTarget);' +
                'var nstyles={backgroundColor:ncs.backgroundColor,color:ncs.color,borderColor:ncs.borderColor,' +
                  'fontSize:ncs.fontSize,fontWeight:ncs.fontWeight,textAlign:ncs.textAlign,lineHeight:ncs.lineHeight,' +
                  'paddingTop:ncs.paddingTop,paddingRight:ncs.paddingRight,paddingBottom:ncs.paddingBottom,paddingLeft:ncs.paddingLeft,' +
                  'marginTop:ncs.marginTop,marginRight:ncs.marginRight,marginBottom:ncs.marginBottom,marginLeft:ncs.marginLeft,' +
                  'width:ncs.width,height:ncs.height,borderRadius:ncs.borderRadius,opacity:ncs.opacity,display:ncs.display,overflow:ncs.overflow};' +
                'var nanc=[];var np=navTarget.parentElement;' +
                'while(np&&np.tagName&&!EXCLUDED.has(np.tagName)){nanc.unshift(tagInfo(np));np=np.parentElement;}' +
                'parent.postMessage({type:"__design_click__",token:TOKEN,tag:tagInfo(navTarget),styles:nstyles,ancestors:nanc,outerHTML:navTarget.outerHTML.substring(0,300),textContent:(navTarget.textContent||"").substring(0,100)},"*");' +
                'showActionBar(navTarget);' +
              '}' +
            '}' +
          '});' +

          // Drag and Drop
          'var dragEl=null;' +
          'var dropTarget=null;' +
          'var dropPosition=null;' +

          'document.addEventListener("mousedown",function(e){' +
            'var el=e.target;' +
            'if(isExcluded(el)||isInjected(el))return;' +
            'if(!isInScope(el))return;' +
            'if(el.isContentEditable)return;' +
            'el.setAttribute("draggable","true");' +
          '});' +

          'document.addEventListener("mouseup",function(e){' +
            'if(!dragEl){' +
              'var el=e.target;' +
              'if(el.hasAttribute&&el.hasAttribute("draggable"))el.removeAttribute("draggable");' +
            '}' +
          '});' +

          'document.addEventListener("dragstart",function(e){' +
            'var el=e.target;' +
            'if(isExcluded(el)||isInjected(el)){e.preventDefault();return;}' +
            'dragEl=el;' +
            'el.classList.add("designer-dragging");' +
            'e.dataTransfer.effectAllowed="move";' +
            'e.dataTransfer.setData("text/plain","");' +
          '});' +

          'var prevDropTarget=null;' +
          'function clearDropIndicators(){' +
            'if(prevDropTarget){prevDropTarget.classList.remove("designer-drop-before","designer-drop-after","designer-drop-inside");prevDropTarget=null;}' +
          '}' +

          'document.addEventListener("dragover",function(e){' +
            'if(!dragEl)return;' +
            'e.preventDefault();' +
            'e.dataTransfer.dropEffect="move";' +
            'var target=e.target;' +
            'if(isExcluded(target)||isInjected(target)||target===dragEl){clearDropIndicators();dropTarget=null;return;}' +
            'if(dragEl.contains(target)){clearDropIndicators();dropTarget=null;return;}' +
            'clearDropIndicators();' +
            'var r=target.getBoundingClientRect();' +
            'var y=e.clientY-r.top;' +
            'var third=r.height/3;' +
            'if(y<third){target.classList.add("designer-drop-before");dropPosition="before";}' +
            'else if(y>third*2){target.classList.add("designer-drop-after");dropPosition="after";}' +
            'else{target.classList.add("designer-drop-inside");dropPosition="inside";}' +
            'dropTarget=target;' +
            'prevDropTarget=target;' +
          '});' +

          'document.addEventListener("drop",function(e){' +
            'e.preventDefault();' +
            'if(!dragEl||!dropTarget)return;' +
            'if(dragEl.contains(dropTarget))return;' +
            'clearDropIndicators();' +
            'if(dropPosition==="before"){' +
              'dropTarget.parentNode.insertBefore(dragEl,dropTarget);' +
            '}else if(dropPosition==="after"){' +
              'dropTarget.parentNode.insertBefore(dragEl,dropTarget.nextSibling);' +
            '}else if(dropPosition==="inside"){' +
              'dropTarget.appendChild(dragEl);' +
            '}' +
            'parent.postMessage({type:"__design_change__",token:TOKEN},"*");' +
          '});' +

          'document.addEventListener("dragend",function(e){' +
            'clearDropIndicators();' +
            'if(dragEl){dragEl.classList.remove("designer-dragging");dragEl.removeAttribute("draggable");}' +
            'dragEl=null;dropTarget=null;dropPosition=null;' +
          '});' +

          // MutationObserver - detect real DOM changes
          'var observer=new MutationObserver(function(mutations){' +
            'var hasReal=mutations.some(function(m){' +
              'if(m.target&&m.target.hasAttribute&&m.target.hasAttribute("data-designer-injected"))return false;' +
              'if(m.type==="attributes"&&(m.attributeName==="data-designer-injected"||m.attributeName==="data-designer-selected"||m.attributeName==="contenteditable"||m.attributeName==="draggable"))return false;' +
              'if(m.type==="childList"){' +
                'var added=Array.from(m.addedNodes).some(function(n){return n.nodeType===1&&!n.hasAttribute("data-designer-injected");});' +
                'var removed=Array.from(m.removedNodes).some(function(n){return n.nodeType===1&&!n.hasAttribute("data-designer-injected");});' +
                'return added||removed;' +
              '}' +
              'return true;' +
            '});' +
            'if(hasReal)parent.postMessage({type:"__design_change__",token:TOKEN},"*");' +
          '});' +
          'observer.observe(document.body||document.documentElement,{' +
            'childList:true,subtree:true,' +
            'attributes:true,attributeFilter:["style","class","id","src","href"],' +
            'characterData:true' +
          '});' +

        '})();';
      }

      // ========================================
      // DESIGN MESSAGE HANDLER
      // ========================================
      function handleDesignMessage(e) {
        if (!e.data || e.data.token !== state.designToken) return;

        switch (e.data.type) {
          case '__design_click__':
            onDesignElementSelected(e.data.tag, e.data.styles, e.data.ancestors, e.data.outerHTML, e.data.textContent);
            break;
          case '__design_change__':
            debouncedDesignSync();
            break;
          case '__design_deselect__':
            onDesignElementDeselected();
            break;
          case '__design_action__':
            handleDesignAction(e.data.action);
            break;
          case '__design_navigate__':
            syncDesignToEditor();
            goToSlide(e.data.slideIndex);
            var navElementPath = e.data.elementPath;
            setTimeout(function() {
              var iframeWin = elements.previewContainer.contentWindow;
              if (iframeWin) {
                iframeWin.postMessage({
                  type: '__design_navigate_to__',
                  token: state.designToken,
                  elementPath: navElementPath
                }, '*');
              }
            }, 400);
            break;
        }
      }

      function handleDesignAction(action) {
        var el = getSelectedElement();
        if (!el) return;
        switch (action) {
          case 'delete':
            el.remove();
            onDesignElementDeselected();
            debouncedDesignSync();
            break;
          case 'duplicate':
            var clone = el.cloneNode(true);
            clone.removeAttribute('data-designer-selected');
            el.parentNode.insertBefore(clone, el.nextSibling);
            debouncedDesignSync();
            break;
          case 'move-up':
            var prev = el.previousElementSibling;
            while (prev && prev.hasAttribute('data-designer-injected')) prev = prev.previousElementSibling;
            if (!prev) return;
            el.parentNode.insertBefore(el, prev);
            debouncedDesignSync();
            break;
          case 'move-down':
            var next = el.nextElementSibling;
            while (next && next.hasAttribute('data-designer-injected')) next = next.nextElementSibling;
            if (!next) return;
            el.parentNode.insertBefore(next, el);
            debouncedDesignSync();
            break;
        }
      }

      function clearDesignHighlights() {
        var cm = elements.htmlEditor;
        for (var i = 0; i < state.designHighlightMarks.length; i++) {
          cm.removeLineClass(state.designHighlightMarks[i], 'wrap', 'cm-design-highlight');
        }
        state.designHighlightMarks = [];
      }

      function highlightDesignElementInEditor(outerHTML, textContent) {
        clearDesignHighlights();

        var slide = state.slides[state.currentSlide];
        if (!slide) return;

        var cm = elements.htmlEditor;
        var startLine = slide.startLine;
        var endLine = slide.endLine;

        // Extract opening tag from outerHTML
        var tagMatch = outerHTML ? outerHTML.match(/^<([a-zA-Z][a-zA-Z0-9]*)\b[^>]*>/) : null;
        var searchTag = tagMatch ? tagMatch[0] : null;
        var tagName = tagMatch ? tagMatch[1] : null;
        var foundLine = -1;

        // Strategy 1: Search for the opening tag in source lines
        if (searchTag) {
          // Clean the tag for search (remove designer attributes)
          var cleanTag = searchTag.replace(/\s*data-designer-[a-z]+="[^"]*"/g, '');
          for (var i = startLine; i <= endLine; i++) {
            var lineText = cm.getLine(i);
            if (lineText && lineText.indexOf(cleanTag) !== -1) {
              foundLine = i;
              break;
            }
          }
          // Fallback: search for just the tag name with attributes prefix
          if (foundLine === -1 && tagName) {
            var tagPrefix = '<' + tagName;
            for (var i = startLine; i <= endLine; i++) {
              var lineText = cm.getLine(i);
              if (lineText && lineText.indexOf(tagPrefix) !== -1) {
                foundLine = i;
                break;
              }
            }
          }
        }

        // Strategy 2: Search for text content in source (for markdown sources)
        if (foundLine === -1 && textContent) {
          var trimmedText = textContent.trim().substring(0, 50);
          if (trimmedText) {
            for (var i = startLine; i <= endLine; i++) {
              var lineText = cm.getLine(i);
              if (lineText && lineText.indexOf(trimmedText) !== -1) {
                foundLine = i;
                break;
              }
            }
          }
        }

        if (foundLine === -1) return;

        // Highlight the found line
        cm.addLineClass(foundLine, 'wrap', 'cm-design-highlight');
        state.designHighlightMarks.push(foundLine);

        // For multi-line elements, highlight until closing tag
        if (tagName) {
          var lineText = cm.getLine(foundLine);
          var closingTag = '</' + tagName;
          if (lineText && lineText.indexOf(closingTag) === -1) {
            for (var j = foundLine + 1; j <= endLine; j++) {
              var nextLine = cm.getLine(j);
              cm.addLineClass(j, 'wrap', 'cm-design-highlight');
              state.designHighlightMarks.push(j);
              if (nextLine && nextLine.indexOf(closingTag) !== -1) break;
            }
          }
        }

        // Scroll editor to show highlighted line
        cm.scrollIntoView({ line: foundLine, ch: 0 }, 80);
      }

      function onDesignElementSelected(tag, styles, ancestors, outerHTML, textContent) {
        elements.dtElementTag.textContent = tag;
        elements.dtHint.style.display = 'none';
        elements.dtControls.style.display = '';
        elements.dtActions.style.display = 'flex';

        // Render breadcrumb
        elements.dtBreadcrumb.innerHTML = '';
        if (ancestors && ancestors.length > 0) {
          ancestors.forEach(function(anc, idx) {
            var span = document.createElement('span');
            span.className = 'dt-breadcrumb-item';
            span.textContent = anc;
            span.title = anc;
            var depth = ancestors.length - idx;
            span.addEventListener('click', function() {
              var iframe = elements.previewContainer.contentWindow;
              if (iframe) iframe.postMessage({ type: '__design_select_ancestor__', token: state.designToken, depth: depth }, '*');
            });
            elements.dtBreadcrumb.appendChild(span);
            var sep = document.createElement('span');
            sep.className = 'dt-breadcrumb-sep';
            sep.textContent = '\u203A';
            elements.dtBreadcrumb.appendChild(sep);
          });
          var current = document.createElement('span');
          current.className = 'dt-breadcrumb-item active';
          current.textContent = tag;
          elements.dtBreadcrumb.appendChild(current);
        }

        // Fill color values
        var bgHex = colorToHex(styles.backgroundColor);
        elements.dtBgColor.value = bgHex || '#ffffff';
        elements.dtBgColorText.value = bgHex || 'transparent';

        var textHex = colorToHex(styles.color);
        elements.dtTextColor.value = textHex || '#000000';
        elements.dtTextColorText.value = textHex || '';

        var borderHex = colorToHex(styles.borderColor);
        elements.dtBorderColor.value = borderHex || '#000000';
        elements.dtBorderColorText.value = borderHex || '';

        // Typography
        var fs = parsePixelValue(styles.fontSize);
        elements.dtFontSizeSlider.value = fs;
        elements.dtFontSize.value = fs;

        var fw = parseInt(styles.fontWeight) || 400;
        elements.dtFontWeight.value = String(fw);

        // Text align
        var alignBtns = elements.dtTextAlignGroup.querySelectorAll('.dt-btn-sm');
        alignBtns.forEach(function(b) {
          b.classList.toggle('active', b.getAttribute('data-align') === styles.textAlign);
        });

        var lh = parseFloat(styles.lineHeight);
        if (isNaN(lh) || styles.lineHeight === 'normal') lh = 1.5;
        else lh = parseFloat((lh / fs).toFixed(2)) || 1.5;
        elements.dtLineHeightSlider.value = lh;
        elements.dtLineHeight.value = lh;

        // Spacing
        elements.dtPaddingTop.value = parsePixelValue(styles.paddingTop);
        elements.dtPaddingRight.value = parsePixelValue(styles.paddingRight);
        elements.dtPaddingBottom.value = parsePixelValue(styles.paddingBottom);
        elements.dtPaddingLeft.value = parsePixelValue(styles.paddingLeft);
        elements.dtMarginTop.value = parsePixelValue(styles.marginTop);
        elements.dtMarginRight.value = parsePixelValue(styles.marginRight);
        elements.dtMarginBottom.value = parsePixelValue(styles.marginBottom);
        elements.dtMarginLeft.value = parsePixelValue(styles.marginLeft);

        // Box
        elements.dtWidth.value = styles.width === 'auto' ? '' : styles.width;
        elements.dtHeight.value = styles.height === 'auto' ? '' : styles.height;
        var br = parsePixelValue(styles.borderRadius);
        elements.dtBorderRadiusSlider.value = Math.min(br, 50);
        elements.dtBorderRadius.value = br;
        var op = parseFloat(styles.opacity);
        elements.dtOpacitySlider.value = isNaN(op) ? 1 : op;
        elements.dtOpacityValue.textContent = isNaN(op) ? '1' : op.toFixed(2);
        elements.dtDisplay.value = styles.display || 'block';
        elements.dtOverflow.value = styles.overflow || 'visible';

        // Highlight corresponding source lines in editor
        if (outerHTML) {
          highlightDesignElementInEditor(outerHTML, textContent);
        }
      }

      function onDesignElementDeselected() {
        clearDesignHighlights();
        elements.dtHint.style.display = '';
        elements.dtControls.style.display = 'none';
        elements.dtActions.style.display = 'none';
        elements.dtElementTag.textContent = '--';
        elements.dtBreadcrumb.innerHTML = '';
      }

      // ========================================
      // GET SELECTED ELEMENT IN IFRAME
      // ========================================
      function getSelectedElement() {
        var iframeDoc = elements.previewContainer.contentDocument;
        if (!iframeDoc) return null;
        return iframeDoc.querySelector('[data-designer-selected]');
      }

      // ========================================
      // APPLY STYLE TO SELECTED ELEMENT
      // ========================================
      function applyStyle(prop, value) {
        var el = getSelectedElement();
        if (!el) return;
        el.style[prop] = value;
      }

      // ========================================
      // DESIGN TOOLBAR EVENT SETUP
      // ========================================
      function initDesignToolbarEvents() {
        // Section accordion (scoped to design toolbar only)
        var headers = elements.designToolbar.querySelectorAll('.dt-section-header');
        headers.forEach(function(header) {
          header.addEventListener('click', function() {
            var sectionId = header.getAttribute('data-section');
            var body = document.getElementById(sectionId);
            if (!body) return;
            var isCollapsed = header.classList.contains('collapsed');
            if (isCollapsed) {
              header.classList.remove('collapsed');
              body.classList.remove('collapsed');
            } else {
              header.classList.add('collapsed');
              body.classList.add('collapsed');
            }
          });
        });

        // --- Colors ---
        elements.dtBgColor.addEventListener('input', function() {
          elements.dtBgColorText.value = this.value;
          applyStyle('backgroundColor', this.value);
        });
        elements.dtBgColorText.addEventListener('change', function() {
          var v = this.value.trim();
          if (v) { elements.dtBgColor.value = v; applyStyle('backgroundColor', v); }
        });
        elements.dtBgTransparent.addEventListener('click', function() {
          elements.dtBgColorText.value = 'transparent';
          applyStyle('backgroundColor', 'transparent');
        });
        elements.dtTextColor.addEventListener('input', function() {
          elements.dtTextColorText.value = this.value;
          applyStyle('color', this.value);
        });
        elements.dtTextColorText.addEventListener('change', function() {
          var v = this.value.trim();
          if (v) { elements.dtTextColor.value = v; applyStyle('color', v); }
        });
        elements.dtBorderColor.addEventListener('input', function() {
          elements.dtBorderColorText.value = this.value;
          applyStyle('borderColor', this.value);
        });
        elements.dtBorderColorText.addEventListener('change', function() {
          var v = this.value.trim();
          if (v) { elements.dtBorderColor.value = v; applyStyle('borderColor', v); }
        });

        // --- Typography ---
        elements.dtFontSizeSlider.addEventListener('input', function() {
          elements.dtFontSize.value = this.value;
          applyStyle('fontSize', this.value + 'px');
        });
        elements.dtFontSize.addEventListener('change', function() {
          elements.dtFontSizeSlider.value = Math.min(Math.max(this.value, 8), 72);
          applyStyle('fontSize', this.value + 'px');
        });
        elements.dtFontWeight.addEventListener('change', function() {
          applyStyle('fontWeight', this.value);
        });
        elements.dtTextAlignGroup.addEventListener('click', function(e) {
          var btn = e.target.closest('[data-align]');
          if (!btn) return;
          var align = btn.getAttribute('data-align');
          elements.dtTextAlignGroup.querySelectorAll('.dt-btn-sm').forEach(function(b) { b.classList.remove('active'); });
          btn.classList.add('active');
          applyStyle('textAlign', align);
        });
        elements.dtLineHeightSlider.addEventListener('input', function() {
          elements.dtLineHeight.value = this.value;
          applyStyle('lineHeight', this.value);
        });
        elements.dtLineHeight.addEventListener('change', function() {
          elements.dtLineHeightSlider.value = this.value;
          applyStyle('lineHeight', this.value);
        });

        // --- Spacing ---
        var spacingInputs = [
          elements.dtPaddingTop, elements.dtPaddingRight, elements.dtPaddingBottom, elements.dtPaddingLeft,
          elements.dtMarginTop, elements.dtMarginRight, elements.dtMarginBottom, elements.dtMarginLeft
        ];
        spacingInputs.forEach(function(input) {
          input.addEventListener('change', function() {
            var prop = this.getAttribute('data-prop');
            if (!prop) {
              // Determine prop from id
              var id = this.id;
              if (id.indexOf('padding') !== -1) {
                if (id.indexOf('top') !== -1) prop = 'paddingTop';
                else if (id.indexOf('right') !== -1) prop = 'paddingRight';
                else if (id.indexOf('bottom') !== -1) prop = 'paddingBottom';
                else prop = 'paddingLeft';
              } else {
                if (id.indexOf('top') !== -1) prop = 'marginTop';
                else if (id.indexOf('right') !== -1) prop = 'marginRight';
                else if (id.indexOf('bottom') !== -1) prop = 'marginBottom';
                else prop = 'marginLeft';
              }
            }
            var val = (parseInt(this.value) || 0) + 'px';

            // Check linked mode
            if (prop.startsWith('padding') && state.paddingLinked) {
              applyStyle('padding', val);
              elements.dtPaddingTop.value = elements.dtPaddingRight.value =
                elements.dtPaddingBottom.value = elements.dtPaddingLeft.value = parseInt(this.value) || 0;
            } else if (prop.startsWith('margin') && state.marginLinked) {
              applyStyle('margin', val);
              elements.dtMarginTop.value = elements.dtMarginRight.value =
                elements.dtMarginBottom.value = elements.dtMarginLeft.value = parseInt(this.value) || 0;
            } else {
              applyStyle(prop, val);
            }
          });
        });

        elements.dtPaddingLink.addEventListener('click', function() {
          state.paddingLinked = !state.paddingLinked;
          this.classList.toggle('linked', state.paddingLinked);
        });
        elements.dtMarginLink.addEventListener('click', function() {
          state.marginLinked = !state.marginLinked;
          this.classList.toggle('linked', state.marginLinked);
        });

        // --- Box ---
        elements.dtWidth.addEventListener('change', function() {
          var v = this.value.trim();
          applyStyle('width', v || 'auto');
        });
        elements.dtHeight.addEventListener('change', function() {
          var v = this.value.trim();
          applyStyle('height', v || 'auto');
        });
        elements.dtBorderRadiusSlider.addEventListener('input', function() {
          elements.dtBorderRadius.value = this.value;
          applyStyle('borderRadius', this.value + 'px');
        });
        elements.dtBorderRadius.addEventListener('change', function() {
          elements.dtBorderRadiusSlider.value = Math.min(this.value, 50);
          applyStyle('borderRadius', this.value + 'px');
        });
        elements.dtOpacitySlider.addEventListener('input', function() {
          elements.dtOpacityValue.textContent = parseFloat(this.value).toFixed(2);
          applyStyle('opacity', this.value);
        });
        elements.dtDisplay.addEventListener('change', function() {
          applyStyle('display', this.value);
        });
        elements.dtOverflow.addEventListener('change', function() {
          applyStyle('overflow', this.value);
        });

        // --- Element operations ---
        document.getElementById('dt-move-up').addEventListener('click', function() {
          var el = getSelectedElement();
          if (!el) return;
          var prev = el.previousElementSibling;
          while (prev && prev.hasAttribute('data-designer-injected')) prev = prev.previousElementSibling;
          if (!prev) return;
          el.parentNode.insertBefore(el, prev);
          debouncedDesignSync();
        });
        document.getElementById('dt-move-down').addEventListener('click', function() {
          var el = getSelectedElement();
          if (!el || !el.nextElementSibling) return;
          // Filter out injected siblings
          var next = el.nextElementSibling;
          while (next && next.hasAttribute('data-designer-injected')) next = next.nextElementSibling;
          if (!next) return;
          el.parentNode.insertBefore(next, el);
          debouncedDesignSync();
        });
        document.getElementById('dt-duplicate').addEventListener('click', function() {
          var el = getSelectedElement();
          if (!el) return;
          var clone = el.cloneNode(true);
          clone.removeAttribute('data-designer-selected');
          el.parentNode.insertBefore(clone, el.nextSibling);
          debouncedDesignSync();
        });
        document.getElementById('dt-delete').addEventListener('click', function() {
          var el = getSelectedElement();
          if (!el) return;
          el.remove();
          onDesignElementDeselected();
          debouncedDesignSync();
        });

        // Add child
        document.getElementById('dt-add-child').addEventListener('click', function(e) {
          e.stopPropagation();
          state.addDropdownOpen = !state.addDropdownOpen;
          elements.dtAddDropdown.style.display = state.addDropdownOpen ? '' : 'none';
        });
        var INSERT_TEMPLATES = {
          'container': function(doc) {
            var d = doc.createElement('div');
            d.style.cssText = 'max-width:800px;margin:0 auto;padding:16px';
            d.textContent = 'Container';
            return d;
          },
          'section': function(doc) {
            var s = doc.createElement('section');
            s.style.cssText = 'padding:24px 0';
            s.textContent = 'Section';
            return s;
          },
          'flex-row': function(doc) {
            var d = doc.createElement('div');
            d.style.cssText = 'display:flex;gap:8px';
            for (var i = 1; i <= 3; i++) {
              var item = doc.createElement('div');
              item.style.cssText = 'flex:1;padding:12px;background:#f0f1f5;border-radius:4px;text-align:center';
              item.textContent = 'Item ' + i;
              d.appendChild(item);
            }
            return d;
          },
          'flex-col': function(doc) {
            var d = doc.createElement('div');
            d.style.cssText = 'display:flex;flex-direction:column;gap:8px';
            for (var i = 1; i <= 3; i++) {
              var item = doc.createElement('div');
              item.style.cssText = 'padding:12px;background:#f0f1f5;border-radius:4px';
              item.textContent = 'Item ' + i;
              d.appendChild(item);
            }
            return d;
          },
          'grid-2col': function(doc) {
            var d = doc.createElement('div');
            d.style.cssText = 'display:grid;grid-template-columns:1fr 1fr;gap:8px';
            for (var i = 1; i <= 4; i++) {
              var cell = doc.createElement('div');
              cell.style.cssText = 'padding:12px;background:#f0f1f5;border-radius:4px;text-align:center';
              cell.textContent = 'Cell ' + i;
              d.appendChild(cell);
            }
            return d;
          },
          'divider': function(doc) {
            return doc.createElement('hr');
          },
          'heading': function(doc) {
            var h = doc.createElement('h2');
            h.textContent = 'Heading';
            return h;
          },
          'text': function(doc) {
            var p = doc.createElement('p');
            p.textContent = 'Text block content goes here.';
            return p;
          },
          'list': function(doc) {
            var ul = doc.createElement('ul');
            for (var i = 1; i <= 3; i++) {
              var li = doc.createElement('li');
              li.textContent = 'List item ' + i;
              ul.appendChild(li);
            }
            return ul;
          },
          'image': function(doc) {
            var d = doc.createElement('div');
            d.style.cssText = 'width:200px;height:150px;border:2px dashed #ccc;display:flex;align-items:center;justify-content:center;color:#999;font-size:14px;border-radius:4px';
            d.textContent = 'Image';
            return d;
          },
          'button': function(doc) {
            var btn = doc.createElement('button');
            btn.textContent = 'Button';
            btn.style.cssText = 'background:#3b82f6;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font:inherit';
            return btn;
          },
          'link': function(doc) {
            var a = doc.createElement('a');
            a.href = '#';
            a.textContent = 'Link text';
            a.style.cssText = 'color:#3b82f6;text-decoration:underline';
            return a;
          }
        };

        elements.dtAddDropdown.addEventListener('click', function(e) {
          var btn = e.target.closest('[data-template]');
          if (!btn) return;
          var tmpl = btn.getAttribute('data-template');
          var el = getSelectedElement();
          if (!el) return;
          var iframeDoc = elements.previewContainer.contentDocument;
          var factory = INSERT_TEMPLATES[tmpl];
          if (!factory) return;
          var newEl = factory(iframeDoc);
          el.appendChild(newEl);
          elements.dtAddDropdown.style.display = 'none';
          state.addDropdownOpen = false;
          debouncedDesignSync();
        });

        // Style copy/paste
        var COPY_STYLE_PROPS = [
          'backgroundColor', 'color', 'borderColor', 'borderWidth', 'borderStyle',
          'fontSize', 'fontWeight', 'fontFamily', 'textAlign', 'lineHeight',
          'paddingTop', 'paddingRight', 'paddingBottom', 'paddingLeft',
          'borderRadius', 'opacity'
        ];

        document.getElementById('dt-copy-style').addEventListener('click', function() {
          var el = getSelectedElement();
          if (!el) return;
          var iframeWin = elements.previewContainer.contentWindow;
          if (!iframeWin) return;
          var cs = iframeWin.getComputedStyle(el);
          var copied = {};
          COPY_STYLE_PROPS.forEach(function(prop) {
            copied[prop] = cs[prop];
          });
          state.copiedStyles = copied;
          showTemporaryMessage('Style copied');
        });

        document.getElementById('dt-paste-style').addEventListener('click', function() {
          if (!state.copiedStyles) { showTemporaryMessage('No style copied', 'error'); return; }
          var el = getSelectedElement();
          if (!el) return;
          var styles = state.copiedStyles;
          Object.keys(styles).forEach(function(prop) {
            el.style[prop] = styles[prop];
          });
          debouncedDesignSync();
          showTemporaryMessage('Style pasted');
        });
      }

      // ========================================
      // SLIDE-SCOPED DOM -> SOURCE SYNC
      // ========================================
      function syncDesignToEditor() {
        if (!state.designMode) return;
        var iframeDoc = elements.previewContainer.contentDocument;
        if (!iframeDoc || !iframeDoc.body) return;

        // Find the active slide element in iframe
        var activeSlide = iframeDoc.querySelector('.slide[data-slide-active="true"]');
        if (!activeSlide) return;

        // Get the slide's innerHTML and clean it
        var clone = activeSlide.cloneNode(true);

        // Remove designer-injected elements and slide chrome
        clone.querySelectorAll('[data-designer-injected]').forEach(function(el) { el.remove(); });
        clone.querySelectorAll('[data-slide-chrome]').forEach(function(el) { el.remove(); });

        // Remove designer-selected attributes
        clone.querySelectorAll('[data-designer-selected]').forEach(function(el) {
          el.removeAttribute('data-designer-selected');
        });

        // Remove contenteditable and draggable attributes
        clone.querySelectorAll('[contenteditable]').forEach(function(el) {
          el.removeAttribute('contenteditable');
        });
        clone.querySelectorAll('[draggable]').forEach(function(el) {
          el.removeAttribute('draggable');
        });

        // Remove slide-specific attributes from the clone itself
        clone.removeAttribute('data-slide-active');
        clone.removeAttribute('data-slide-index');

        var cleanHtml = clone.innerHTML;
        cleanHtml = beautifyHtml(cleanHtml);

        // Get the current slide's line range
        var slide = state.slides[state.currentSlide];
        if (!slide) return;

        state.syncingFromDesign = true;
        // Safety reset: ensure flag clears even if change event is missed
        setTimeout(function() { state.syncingFromDesign = false; }, 100);

        elements.htmlEditor.operation(function() {
          var startLine = slide.startLine;
          var endLine = slide.endLine;
          var endLineText = elements.htmlEditor.getLine(endLine);
          var endCh = endLineText ? endLineText.length : 0;

          elements.htmlEditor.replaceRange(
            cleanHtml,
            { line: startLine, ch: 0 },
            { line: endLine, ch: endCh }
          );
        });

        // Re-parse slides after sync to update line ranges
        state.slides = parseSlides();
        debouncedSaveCode();
      }

      // ========================================
      // PRESENTATION MODE (Phase 5)
      // ========================================
      function enterPresentationMode() {
        if (state.slides.length === 0) return;
        state.presenting = true;
        state.presentationSlide = state.currentSlide;
        elements.presentationOverlay.style.display = 'flex';
        renderPresentationSlide();
        document.addEventListener('keydown', handlePresentationKeydown);
      }

      function exitPresentationMode() {
        state.presenting = false;
        elements.presentationOverlay.style.display = 'none';
        document.removeEventListener('keydown', handlePresentationKeydown);
      }

      function renderPresentationSlide() {
        var slide = state.slides[state.presentationSlide];
        if (!slide) return;
        var content = renderSlideContent(slide.content, slide.type);
        var ss = state.slideSettings;
        var isWide = state.aspectRatio === '16:9';
        var slideW = 960;
        var slideH = isWide ? 540 : 720;

        // Build chrome elements for presentation
        var presChrome = '';
        if (ss.header.show && ss.header.text) {
          var presHeaderFs = parseInt(ss.header.fontSize, 10) || 12;
          var presHeaderBg = ss.header.backgroundColor && ss.header.backgroundColor !== 'transparent'
            ? 'background:' + escCssValue(ss.header.backgroundColor) + ';padding:4px 12px;border-radius:4px;' : '';
          presChrome += '<div style="position:absolute;top:12px;left:64px;right:64px;text-align:center;font-size:' + presHeaderFs + 'px;color:' + escHtml(ss.textColor) + ';opacity:0.5;' + presHeaderBg + '">' + escHtml(ss.header.text) + '</div>';
        }
        if (ss.footer.show && ss.footer.text) {
          var presFooterBottom = 12;
          if (ss.showPageNumbers && ss.pageNumberPosition === 'bottom-center') {
            presFooterBottom = 28;
          }
          var presFooterFs = parseInt(ss.footer.fontSize, 10) || 12;
          var presFooterBg = ss.footer.backgroundColor && ss.footer.backgroundColor !== 'transparent'
            ? 'background:' + escCssValue(ss.footer.backgroundColor) + ';padding:4px 12px;border-radius:4px;' : '';
          presChrome += '<div style="position:absolute;bottom:' + presFooterBottom + 'px;left:64px;right:64px;text-align:center;font-size:' + presFooterFs + 'px;color:' + escHtml(ss.textColor) + ';opacity:0.5;' + presFooterBg + '">' + escHtml(ss.footer.text) + '</div>';
        }
        if (ss.showPageNumbers) {
          var pageText = ss.pageNumberFormat.replace('{n}', String(state.presentationSlide + 1)).replace('{total}', String(state.slides.length));
          var posStyle = 'position:absolute;bottom:12px;font-size:12px;color:' + escHtml(ss.textColor) + ';opacity:0.5;font-variant-numeric:tabular-nums;';
          if (ss.pageNumberPosition === 'bottom-left') posStyle += 'left:64px';
          else if (ss.pageNumberPosition === 'bottom-center') posStyle += 'left:50%;transform:translateX(-50%)';
          else posStyle += 'right:64px';
          presChrome += '<div style="' + posStyle + '">' + escHtml(pageText) + '</div>';
        }

        var iframeDoc = elements.presentationIframe.contentDocument;
        if (!iframeDoc) return;
        iframeDoc.open();
        iframeDoc.write(
          '<!DOCTYPE html><html><head>' +
          '<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">' +
          '<style>' +
          'html,body{margin:0;padding:0;width:100%;height:100%;overflow:hidden;background:#000;display:flex;align-items:center;justify-content:center}' +
          '.slide{width:' + slideW + 'px;height:' + slideH + 'px;background:' + escCssValue(ss.backgroundColor) + ';color:' + escCssValue(ss.textColor) + ';padding:48px 64px;box-sizing:border-box;position:relative;' +
          'font-family:' + safeFontFamily(ss.fontFamily) + ';font-size:20px;line-height:1.6;overflow:hidden}' +
          'h1{font-size:2em;margin-bottom:0.5em;color:' + escCssValue(ss.headingColor) + '}' +
          'h2{font-size:1.5em;margin-bottom:0.4em;color:' + escCssValue(ss.headingColor) + '}' +
          'h3{font-size:1.2em;margin-bottom:0.3em;color:' + escCssValue(ss.headingColor) + '}' +
          'ul,ol{margin-left:1.5em}li{margin-bottom:0.3em}' +
          'p{margin-bottom:0.6em}' +
          'code{background:#f0f1f5;padding:2px 6px;border-radius:3px;font-size:0.85em}' +
          'pre{background:#1e1f25;color:#f0f1f5;padding:16px;border-radius:8px;overflow-x:auto}' +
          'pre code{background:none;padding:0;color:inherit}' +
          'img{max-width:100%;height:auto}' +
          'blockquote{border-left:4px solid ' + escCssValue(ss.accentColor) + ';padding-left:16px;color:' + escCssValue(ss.textColor) + ';opacity:0.8;margin-bottom:0.6em}' +
          'table{border-collapse:collapse;width:100%;margin-bottom:0.6em}' +
          'th,td{border:1px solid #e2e4ec;padding:8px 12px;text-align:left}' +
          'th{background:#f0f1f5;font-weight:600}' +
          'a{color:' + escCssValue(ss.accentColor) + ';text-decoration:none}' +
          'strong{font-weight:700}em{font-style:italic}' +
          '</style></head><body><div class="slide">' + content + presChrome + '</div></body></html>'
        );
        iframeDoc.close();
        elements.presCounter.textContent = (state.presentationSlide + 1) + ' / ' + state.slides.length;
      }

      function navigatePresentationSlide(dir) {
        var newIdx = state.presentationSlide + dir;
        if (newIdx < 0 || newIdx >= state.slides.length) return;
        state.presentationSlide = newIdx;
        renderPresentationSlide();
      }

      function handlePresentationKeydown(e) {
        if (e.key === 'Escape') { exitPresentationMode(); return; }
        if (e.key === 'ArrowRight' || e.key === 'ArrowDown' || e.key === ' ' || e.key === 'PageDown') {
          e.preventDefault(); navigatePresentationSlide(1);
        }
        if (e.key === 'ArrowLeft' || e.key === 'ArrowUp' || e.key === 'PageUp') {
          e.preventDefault(); navigatePresentationSlide(-1);
        }
        if (e.key === 'Home') { e.preventDefault(); state.presentationSlide = 0; renderPresentationSlide(); }
        if (e.key === 'End') { e.preventDefault(); state.presentationSlide = state.slides.length - 1; renderPresentationSlide(); }
      }

      function handlePrint() {
        var iframeWin = elements.previewContainer.contentWindow;
        if (iframeWin) {
          iframeWin.focus();
          iframeWin.print();
        }
      }

      // ========================================
      // SLIDE SETTINGS
      // ========================================
      var SETTINGS_WHITELIST = ['theme','backgroundColor','fontFamily','textColor','headingColor','accentColor',
        'showPageNumbers','pageNumberPosition','pageNumberFormat','header','footer'];

      var debouncedSaveSettings = debounce(saveSlideSettings, CONFIG.debounceDelay);

      function loadSlideSettings() {
        try {
          var raw = localStorage.getItem(CONFIG.settingsStorageKey);
          if (!raw) return;
          var parsed = JSON.parse(raw);
          if (!parsed || typeof parsed !== 'object') return;
          var defaults = getDefaultSlideSettings();
          var validated = {};
          SETTINGS_WHITELIST.forEach(function(key) {
            if (Object.hasOwn(parsed, key)) {
              validated[key] = parsed[key];
            } else {
              validated[key] = defaults[key];
            }
          });
          // Validate sub-objects with property whitelisting
          function validateSubObj(obj, def) {
            if (typeof obj !== 'object' || obj === null) return def;
            return {
              text: typeof obj.text === 'string' ? obj.text : def.text,
              show: typeof obj.show === 'boolean' ? obj.show : def.show,
              backgroundColor: typeof obj.backgroundColor === 'string' ? obj.backgroundColor : def.backgroundColor,
              fontSize: typeof obj.fontSize === 'number' && obj.fontSize >= 8 && obj.fontSize <= 36 ? obj.fontSize : def.fontSize
            };
          }
          validated.header = validateSubObj(validated.header, defaults.header);
          validated.footer = validateSubObj(validated.footer, defaults.footer);
          // Validate enum values
          var validPositions = ['bottom-left', 'bottom-center', 'bottom-right'];
          if (validPositions.indexOf(validated.pageNumberPosition) === -1) validated.pageNumberPosition = defaults.pageNumberPosition;
          if (typeof validated.showPageNumbers !== 'boolean') validated.showPageNumbers = defaults.showPageNumbers;
          // Validate font family
          validated.fontFamily = ALLOWED_FONTS[validated.fontFamily] ? validated.fontFamily : defaults.fontFamily;
          state.slideSettings = validated;
        } catch(e) {
          ErrorHandler.log(e, 'loadSettings');
        }
        syncSettingsToUI();
      }

      function saveSlideSettings() {
        try {
          localStorage.setItem(CONFIG.settingsStorageKey, JSON.stringify(state.slideSettings));
        } catch(e) {
          if (e.name === 'QuotaExceededError') showTemporaryMessage('Storage full', 'error');
        }
      }

      function syncSettingsToUI() {
        var s = state.slideSettings;
        elements.stThemePreset.value = s.theme || 'default';
        elements.stBgColor.value = s.backgroundColor;
        elements.stBgColorText.value = s.backgroundColor;
        elements.stTextColor.value = s.textColor;
        elements.stTextColorText.value = s.textColor;
        elements.stHeadingColor.value = s.headingColor;
        elements.stHeadingColorText.value = s.headingColor;
        elements.stAccentColor.value = s.accentColor;
        elements.stAccentColorText.value = s.accentColor;
        // Find matching font option
        var fontOpts = elements.stFontFamily.options;
        var fontMatched = false;
        for (var fi = 0; fi < fontOpts.length; fi++) {
          if (fontOpts[fi].value === s.fontFamily) {
            elements.stFontFamily.selectedIndex = fi;
            fontMatched = true;
            break;
          }
        }
        if (!fontMatched) elements.stFontFamily.selectedIndex = 0;
        elements.stPageShow.checked = s.showPageNumbers;
        elements.stPagePosition.value = s.pageNumberPosition;
        elements.stPageFormat.value = s.pageNumberFormat;
        elements.stHeaderShow.checked = s.header.show;
        elements.stHeaderText.value = s.header.text;
        elements.stHeaderBgColor.value = s.header.backgroundColor && s.header.backgroundColor !== 'transparent' ? s.header.backgroundColor : '#ffffff';
        elements.stHeaderBgColorText.value = s.header.backgroundColor || 'transparent';
        elements.stHeaderFontSize.value = s.header.fontSize || 12;
        elements.stFooterShow.checked = s.footer.show;
        elements.stFooterText.value = s.footer.text;
        elements.stFooterBgColor.value = s.footer.backgroundColor && s.footer.backgroundColor !== 'transparent' ? s.footer.backgroundColor : '#ffffff';
        elements.stFooterBgColorText.value = s.footer.backgroundColor || 'transparent';
        elements.stFooterFontSize.value = s.footer.fontSize || 12;
      }

      function applySettingsChange() {
        debouncedSaveSettings();
        updatePreview();
      }

      function initSettingsEvents() {
        // Settings panel section accordion
        var stHeaders = elements.settingsPanel.querySelectorAll('.dt-section-header');
        stHeaders.forEach(function(header) {
          header.addEventListener('click', function() {
            var sectionId = header.getAttribute('data-section');
            var body = document.getElementById(sectionId);
            if (!body) return;
            var isCollapsed = header.classList.contains('collapsed');
            if (isCollapsed) {
              header.classList.remove('collapsed');
              body.classList.remove('collapsed');
            } else {
              header.classList.add('collapsed');
              body.classList.add('collapsed');
            }
          });
        });

        // Theme preset
        elements.stThemePreset.addEventListener('change', function() {
          var preset = THEME_PRESETS[this.value];
          if (!preset) return;
          state.slideSettings.theme = this.value;
          state.slideSettings.backgroundColor = preset.backgroundColor;
          state.slideSettings.textColor = preset.textColor;
          state.slideSettings.headingColor = preset.headingColor;
          state.slideSettings.accentColor = preset.accentColor;
          syncSettingsToUI();
          applySettingsChange();
          showTemporaryMessage('Theme: ' + this.value);
        });

        // Color pickers
        function bindColorPicker(picker, textInput, settingsKey) {
          picker.addEventListener('input', function() {
            textInput.value = this.value;
            state.slideSettings[settingsKey] = this.value;
            applySettingsChange();
          });
          textInput.addEventListener('change', function() {
            var v = this.value.trim();
            if (v) {
              picker.value = v;
              state.slideSettings[settingsKey] = v;
              state.slideSettings.theme = 'default';
              elements.stThemePreset.value = 'default';
              applySettingsChange();
            }
          });
        }
        bindColorPicker(elements.stBgColor, elements.stBgColorText, 'backgroundColor');
        bindColorPicker(elements.stTextColor, elements.stTextColorText, 'textColor');
        bindColorPicker(elements.stHeadingColor, elements.stHeadingColorText, 'headingColor');
        bindColorPicker(elements.stAccentColor, elements.stAccentColorText, 'accentColor');

        // Font family
        elements.stFontFamily.addEventListener('change', function() {
          state.slideSettings.fontFamily = this.value;
          applySettingsChange();
        });

        // Page numbers
        elements.stPageShow.addEventListener('change', function() {
          state.slideSettings.showPageNumbers = this.checked;
          applySettingsChange();
        });
        elements.stPagePosition.addEventListener('change', function() {
          state.slideSettings.pageNumberPosition = this.value;
          applySettingsChange();
        });
        elements.stPageFormat.addEventListener('change', function() {
          state.slideSettings.pageNumberFormat = this.value;
          applySettingsChange();
        });

        // Header
        elements.stHeaderShow.addEventListener('change', function() {
          state.slideSettings.header.show = this.checked;
          applySettingsChange();
        });
        elements.stHeaderText.addEventListener('input', function() {
          state.slideSettings.header.text = this.value;
          applySettingsChange();
        });
        elements.stHeaderBgColor.addEventListener('input', function() {
          elements.stHeaderBgColorText.value = this.value;
          state.slideSettings.header.backgroundColor = this.value;
          applySettingsChange();
        });
        elements.stHeaderBgColorText.addEventListener('change', function() {
          var v = this.value.trim();
          if (v === '' || v === 'transparent') {
            state.slideSettings.header.backgroundColor = 'transparent';
            elements.stHeaderBgColor.value = '#ffffff';
          } else {
            elements.stHeaderBgColor.value = v;
            state.slideSettings.header.backgroundColor = v;
          }
          applySettingsChange();
        });
        elements.stHeaderFontSize.addEventListener('input', function() {
          var val = parseInt(this.value, 10);
          if (val >= 8 && val <= 36) {
            state.slideSettings.header.fontSize = val;
            applySettingsChange();
          }
        });

        // Footer
        elements.stFooterShow.addEventListener('change', function() {
          state.slideSettings.footer.show = this.checked;
          applySettingsChange();
        });
        elements.stFooterText.addEventListener('input', function() {
          state.slideSettings.footer.text = this.value;
          applySettingsChange();
        });
        elements.stFooterBgColor.addEventListener('input', function() {
          elements.stFooterBgColorText.value = this.value;
          state.slideSettings.footer.backgroundColor = this.value;
          applySettingsChange();
        });
        elements.stFooterBgColorText.addEventListener('change', function() {
          var v = this.value.trim();
          if (v === '' || v === 'transparent') {
            state.slideSettings.footer.backgroundColor = 'transparent';
            elements.stFooterBgColor.value = '#ffffff';
          } else {
            elements.stFooterBgColor.value = v;
            state.slideSettings.footer.backgroundColor = v;
          }
          applySettingsChange();
        });
        elements.stFooterFontSize.addEventListener('input', function() {
          var val = parseInt(this.value, 10);
          if (val >= 8 && val <= 36) {
            state.slideSettings.footer.fontSize = val;
            applySettingsChange();
          }
        });
      }

      // ========================================
      // RUN
      // ========================================
      initialize();
      if (typeof feather !== 'undefined') feather.replace();

    })();
    </script>
  </body>
</html>
