<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nexus - Cross-Domain Workspace</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/codemirror.min.css"
      integrity="sha512-uf06llspW44/LZpHzHT6qBOIVODjWtv4MxCricRxkzvopAlSWnTf6hpZTFxuuZcuNE9CBQhqE0Seu1CoRk84nQ=="
      crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://unpkg.com/feather-icons@4.29.1/dist/feather.min.js"></script>
    <script src="https://unpkg.com/lodash@4.17.21/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/codemirror.min.js"
      integrity="sha512-3S64QagKiTlNjSfuh3UYtYSkP494WHoWc96YvbmB2BReHpNtxlrMNY6MbJLDpavcgD8Pj5p44F/PY586uVO5iA=="
      crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/mode/markdown/markdown.min.js"
      integrity="sha512-DmMao0nRIbyDjbaHc8fNd3kxGsZj9PCU6Iu/CeidLQT9Py8nYVA5n0PqXYmvqNdU+lCiTHOM/4E7bM/G8BttJg=="
      crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/edit/continuelist.min.js"
      integrity="sha512-eAuQaBSvlaYxR3d+ow+tm+393cV1VanYI4j7GWHEpjuKhxaIUPbHzADL6qxJa0/7ECIKcQzPxat9o6rvIyGxhA=="
      crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
      :root {
        --da-ink: #1e1f25;
        --da-charcoal: #282a32;
        --da-graphite: #353842;
        --da-slate: #4a4e5c;
        --da-ash: #6b7085;
        --da-stone: #9498ab;
        --da-cloud: #c4c8d6;
        --da-mist: #e2e4ec;
        --da-frost: #f0f1f5;
        --da-snow: #f8f9fb;
        --da-secondary: #5b8fcc;
        --da-secondary-hover: #4a7db8;
        --da-accent-muted: #5b8fcc26;
        --da-accent-glow: #5b8fcc12;
        --da-success: #4aba8a;
        --da-warning: #d4943a;
        --da-error: #d45a5a;
        --ease-out-expo: cubic-bezier(0.22, 1, 0.36, 1);
        --duration-fast: 100ms;
        --duration-normal: 200ms;
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.15);
        --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.2);
        --app-text-primary: var(--da-ink);
        --app-text-secondary: var(--da-slate);
        --app-text-on-dark: var(--da-snow);
        --app-text-muted: var(--da-ash);
        --app-bg-primary: var(--da-snow);
        --app-bg-secondary: var(--da-frost);
        --app-bg-dark: var(--da-charcoal);
        --app-border-default: var(--da-mist);
        --app-border-focus: var(--da-secondary);
        --app-border-hover: var(--da-cloud);
        --app-toolbar-bg: var(--da-charcoal);
        --app-toolbar-text: var(--da-snow);
        --app-toolbar-border: var(--da-graphite);
        --app-editor-bg: var(--da-snow);
        --app-editor-text: var(--da-ink);
        --app-editor-placeholder: var(--da-ash);
        --app-accent: var(--da-secondary);
        --app-accent-hover: var(--da-secondary-hover);
      }
      :root[data-theme="dark"] {
        --app-text-primary: var(--da-frost);
        --app-text-secondary: var(--da-stone);
        --app-text-muted: var(--da-ash);
        --app-bg-primary: var(--da-charcoal);
        --app-bg-secondary: var(--da-ink);
        --app-bg-dark: var(--da-ink);
        --app-border-default: var(--da-graphite);
        --app-border-hover: var(--da-slate);
        --app-toolbar-bg: var(--da-ink);
        --app-toolbar-text: var(--da-frost);
        --app-toolbar-border: var(--da-graphite);
        --app-editor-bg: var(--da-charcoal);
        --app-editor-text: var(--da-frost);
        --app-editor-placeholder: var(--da-ash);
      }
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body {
        font-family: "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
        font-size: 16px; line-height: 1.5; font-weight: 400;
        height: 100vh; overflow: hidden; display: flex; flex-direction: column;
        background-color: var(--app-bg-primary); color: var(--app-text-primary);
      }

      /* ===== Toolbar ===== */
      .toolbar {
        background-color: var(--app-toolbar-bg); color: var(--app-toolbar-text);
        padding: 8px 16px; border-bottom: 1px solid var(--app-toolbar-border);
        box-shadow: inset 0 -2px 0 0 var(--da-secondary);
        display: flex; align-items: center; gap: 12px; flex-shrink: 0; min-height: 48px;
      }
      .toolbar-title {
        font-weight: 500; font-size: 15px; line-height: 1.4;
        margin-right: auto; color: var(--app-toolbar-text); letter-spacing: 0.05em;
      }
      .toolbar-menu { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
      .btn-group {
        display: flex; gap: 2px; background: rgba(255,255,255,0.04);
        border-radius: 8px; padding: 2px;
      }
      .toolbar-button {
        background: none; border: 1px solid transparent; padding: 6px; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        border-radius: 6px; min-width: 34px; min-height: 34px;
        transition: all var(--duration-normal) var(--ease-out-expo);
      }
      .toolbar-button svg { width: 17px; height: 17px; color: var(--da-cloud); transition: all var(--duration-normal) var(--ease-out-expo); }
      .toolbar-button:hover { background-color: var(--da-graphite); }
      .toolbar-button:hover svg { color: var(--da-snow); }
      .toolbar-button:active { transform: scale(0.93); }
      .toolbar-button.active { background: var(--da-accent-muted); border-color: var(--da-secondary); }
      .toolbar-button.active svg { color: var(--da-snow); }
      .toolbar-button:focus-visible { outline: 2px solid var(--da-secondary); outline-offset: 2px; box-shadow: 0 0 0 4px var(--da-accent-muted); }
      .toolbar-search {
        background: var(--da-graphite); border: 1px solid var(--da-slate); border-radius: 6px;
        padding: 5px 10px 5px 30px; font-size: 13px; color: var(--da-snow); outline: none;
        width: 180px; font-family: inherit;
        transition: border-color var(--duration-normal) var(--ease-out-expo), box-shadow var(--duration-normal) var(--ease-out-expo);
      }
      .toolbar-search::placeholder { color: var(--da-ash); }
      .toolbar-search:focus { border-color: var(--da-secondary); box-shadow: 0 0 0 3px var(--da-accent-muted); }
      .search-wrapper { position: relative; display: flex; align-items: center; }
      .search-wrapper svg { position: absolute; left: 8px; width: 14px; height: 14px; color: var(--da-ash); pointer-events: none; }
      .toolbar-nav { display: flex; align-items: center; gap: 2px; margin-left: 4px; }
      .toolbar-nav a {
        color: var(--da-cloud); text-decoration: none; font-size: 12px; padding: 4px 8px;
        border-radius: 4px; transition: all var(--duration-normal) var(--ease-out-expo); white-space: nowrap;
      }
      .toolbar-nav a:hover { color: var(--da-snow); background-color: var(--da-graphite); }
      .toolbar-nav a.nav-active { color: var(--da-secondary); background: var(--da-accent-muted); }

      /* ===== Toast ===== */
      @keyframes toast-slide-in { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
      @keyframes toast-fade-out { from { transform: translateY(0); opacity: 1; } to { transform: translateY(-8px); opacity: 0; } }
      .temp-message {
        position: fixed; top: 60px; right: 20px; padding: 10px 16px; border-radius: 8px;
        font-size: 13px; z-index: 10000; pointer-events: none;
        background-color: var(--da-charcoal); color: var(--da-snow);
        border: 1px solid var(--da-graphite); box-shadow: var(--shadow-md);
        animation: toast-slide-in 300ms var(--ease-out-expo);
      }
      .temp-message[role="status"] { border-left: 3px solid var(--da-success); }
      .temp-message.toast-warning[role="status"] { border-left: 3px solid var(--da-warning); }
      .temp-message.toast-error[role="status"] { border-left: 3px solid var(--da-error); }
      .temp-message.toast-out { animation: toast-fade-out 300ms var(--ease-out-expo) forwards; }
      .theme-icon-spin svg { animation: theme-spin 400ms var(--ease-out-expo); }
      @keyframes theme-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

      /* ===== Workspace Grid ===== */
      .nexus-workspace {
        flex: 1; display: grid; gap: 6px; padding: 6px;
        overflow: hidden; min-height: 0;
      }
      .resize-overlay {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        z-index: 500; cursor: col-resize;
      }

      /* ===== Domain Pane ===== */
      .domain-pane {
        background: var(--app-bg-primary); border: 1px solid var(--app-border-default);
        border-radius: 8px; display: flex; flex-direction: column;
        overflow: hidden; min-width: 0; min-height: 0;
        transition: box-shadow var(--duration-normal) var(--ease-out-expo);
      }
      .domain-pane:hover { box-shadow: var(--shadow-sm); }
      .domain-pane-header {
        display: flex; align-items: center; gap: 8px; padding: 8px 12px;
        border-bottom: 1px solid var(--app-border-default); flex-shrink: 0;
      }
      .domain-color-bar { width: 4px; height: 24px; border-radius: 2px; flex-shrink: 0; }
      .domain-name {
        font-weight: 600; font-size: 14px; flex: 1; min-width: 0;
        overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        cursor: default;
      }
      .domain-actions { display: flex; gap: 2px; flex-shrink: 0; }
      .pane-btn {
        background: none; border: none; cursor: pointer; padding: 5px; border-radius: 4px;
        display: flex; align-items: center; color: var(--app-text-muted);
        transition: all var(--duration-fast) var(--ease-out-expo);
      }
      .pane-btn:hover { background: var(--app-bg-secondary); color: var(--app-text-primary); }
      .pane-btn svg { width: 16px; height: 16px; }
      .pane-btn.active { color: var(--da-secondary); }

      /* ===== Summary Area ===== */
      .domain-summary-area {
        border-bottom: 1px solid var(--app-border-default); flex-shrink: 0;
      }
      .summary-toggle {
        display: flex; align-items: center; gap: 6px; padding: 6px 12px;
        cursor: pointer; font-size: 11px; font-weight: 600; text-transform: uppercase;
        letter-spacing: 0.05em; color: var(--app-text-muted); background: none; border: none;
        width: 100%; text-align: left;
        transition: background var(--duration-fast) var(--ease-out-expo);
      }
      .summary-toggle:hover { background: var(--app-bg-secondary); }
      .summary-toggle svg { width: 12px; height: 12px; transition: transform var(--duration-fast); }
      .summary-toggle.collapsed svg { transform: rotate(-90deg); }
      .summary-content {
        padding: 8px 12px; font-size: 13px; line-height: 1.6;
        max-height: 200px; overflow-y: auto;
      }
      .summary-content.hidden { display: none; }
      .summary-edit-area { padding: 8px 12px; }
      .summary-edit-area textarea {
        width: 100%; min-height: 80px; padding: 8px; font-size: 13px; font-family: inherit;
        border: 1px solid var(--app-border-default); border-radius: 6px; resize: vertical;
        background: var(--app-editor-bg); color: var(--app-editor-text); outline: none;
      }
      .summary-edit-area textarea:focus { border-color: var(--app-border-focus); }
      .summary-edit-btns { display: flex; gap: 4px; margin-top: 4px; justify-content: flex-end; }

      /* ===== Editor / Preview Area ===== */
      .domain-editor-area {
        flex: 1; overflow: hidden; display: flex; flex-direction: column; min-height: 0;
      }
      .domain-editor-area .CodeMirror {
        width: 100%; height: 100%; flex: 1;
        font-size: 13px; line-height: 1.6;
        font-family: Consolas, "Courier New", monospace;
      }
      .CodeMirror-activeline-background { background: var(--da-accent-glow) !important; }
      .CodeMirror-selected { background: var(--da-accent-muted) !important; }
      .CodeMirror-focused .CodeMirror-selected { background: var(--da-accent-muted) !important; }
      .domain-editor-area .cm-search-highlight .CodeMirror-selectedtext {
        background: rgba(255, 200, 50, 0.35) !important;
      }
      .domain-preview-area {
        flex: 1; overflow-y: auto; padding: 12px; font-size: 13px; line-height: 1.6;
      }
      .domain-fallback-textarea {
        width: 100%; height: 100%; flex: 1; padding: 12px;
        font-size: 13px; line-height: 1.6; font-family: Consolas, "Courier New", monospace;
        border: none; outline: none; resize: none;
        background: var(--app-editor-bg); color: var(--app-editor-text);
      }

      /* ===== Preview Markdown ===== */
      .preview-content p { margin-bottom: 8px; }
      .preview-content p:last-child { margin-bottom: 0; }
      .preview-content h1, .preview-content h2, .preview-content h3,
      .preview-content h4, .preview-content h5, .preview-content h6 {
        margin: 12px 0 6px; font-weight: 600; line-height: 1.3;
      }
      .preview-content h1 { font-size: 18px; } .preview-content h2 { font-size: 16px; }
      .preview-content h3 { font-size: 15px; } .preview-content h4 { font-size: 14px; }
      .preview-content h5 { font-size: 13px; } .preview-content h6 { font-size: 12px; }
      .preview-content ul, .preview-content ol { padding-left: 20px; margin-bottom: 8px; }
      .preview-content li { margin-bottom: 2px; }
      .preview-content code {
        background: var(--app-bg-secondary); padding: 2px 5px; border-radius: 3px;
        font-size: 12px; font-family: Consolas, Monaco, monospace;
      }
      .preview-content pre {
        background: var(--app-bg-secondary); padding: 10px; border-radius: 6px;
        margin-bottom: 8px; overflow-x: auto;
      }
      .preview-content pre code { background: none; padding: 0; }
      .preview-content blockquote {
        border-left: 3px solid var(--da-secondary); padding: 4px 12px;
        margin: 8px 0; color: var(--app-text-secondary);
      }
      .preview-content a { color: var(--da-secondary); text-decoration: underline; }
      .preview-content a:hover { color: var(--da-secondary-hover); }
      .preview-content hr { border: none; border-top: 1px solid var(--app-border-default); margin: 12px 0; }
      .preview-content table { border-collapse: collapse; width: 100%; margin-bottom: 8px; font-size: 12px; }
      .preview-content th, .preview-content td { border: 1px solid var(--app-border-default); padding: 4px 8px; text-align: left; }
      .preview-content th { background: var(--app-bg-secondary); font-weight: 600; }
      .preview-content del { text-decoration: line-through; color: var(--app-text-muted); }

      /* ===== Outline Dropdown ===== */
      .outline-dropdown {
        position: absolute; top: 100%; left: 0; z-index: 600;
        background: var(--app-bg-primary); border: 1px solid var(--app-border-default);
        border-radius: 8px; box-shadow: var(--shadow-md); min-width: 200px; max-width: 300px;
        max-height: 300px; overflow-y: auto; padding: 4px; margin-top: 4px;
      }
      .outline-item {
        display: block; width: 100%; text-align: left; padding: 5px 10px;
        border: none; background: none; cursor: pointer; font-size: 12px;
        color: var(--app-text-primary); font-family: inherit; border-radius: 4px;
        overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        transition: background var(--duration-fast);
      }
      .outline-item:hover { background: var(--app-bg-secondary); }
      .outline-item[data-level="3"],
      .outline-item[data-level="4"],
      .outline-item[data-level="5"],
      .outline-item[data-level="6"] { padding-left: 24px; }

      /* ===== Modals ===== */
      .modal-overlay {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 1000;
        align-items: center; justify-content: center;
      }
      .modal-overlay.open { display: flex; }
      .modal {
        background: var(--app-bg-primary); border-radius: 12px;
        box-shadow: var(--shadow-md); width: 480px; max-width: 90vw; max-height: 85vh;
        display: flex; flex-direction: column; overflow: hidden;
        border: 1px solid var(--app-border-default);
      }
      .modal-sm { width: 380px; }
      .modal-header {
        display: flex; align-items: center; justify-content: space-between;
        padding: 16px 20px; border-bottom: 1px solid var(--app-border-default); flex-shrink: 0;
      }
      .modal-title { font-size: 16px; font-weight: 600; }
      .modal-close-btn {
        background: none; border: none; cursor: pointer; padding: 4px; border-radius: 4px;
        display: flex; color: var(--app-text-muted);
      }
      .modal-close-btn:hover { background: var(--app-bg-secondary); color: var(--app-text-primary); }
      .modal-close-btn svg { width: 18px; height: 18px; }
      .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
      .modal-footer {
        padding: 12px 20px; border-top: 1px solid var(--app-border-default);
        display: flex; align-items: center; justify-content: flex-end; gap: 8px; flex-shrink: 0;
      }
      .form-group { margin-bottom: 16px; }
      .form-group:last-child { margin-bottom: 0; }
      .form-label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px; color: var(--app-text-secondary); }
      .form-input {
        width: 100%; padding: 8px 12px; font-size: 14px; font-family: inherit;
        border: 1px solid var(--app-border-default); border-radius: 6px;
        background: var(--app-editor-bg); color: var(--app-editor-text); outline: none;
      }
      .form-input:focus { border-color: var(--app-border-focus); box-shadow: 0 0 0 3px var(--da-accent-muted); }
      .form-textarea { min-height: 120px; resize: vertical; line-height: 1.5; }
      select.form-input { cursor: pointer; }

      /* ===== Buttons ===== */
      .btn {
        padding: 8px 16px; font-size: 13px; font-weight: 500; font-family: inherit;
        border: 1px solid transparent; border-radius: 6px; cursor: pointer;
        transition: all var(--duration-fast); display: inline-flex; align-items: center; gap: 4px;
      }
      .btn-primary { background: var(--da-secondary); color: #fff; }
      .btn-primary:hover { background: var(--da-secondary-hover); }
      .btn-secondary { background: var(--app-bg-secondary); color: var(--app-text-primary); border-color: var(--app-border-default); }
      .btn-secondary:hover { background: var(--app-border-default); }
      .btn-danger { background: var(--da-error); color: #fff; }
      .btn-danger:hover { background: #c04a4a; }
      .btn-sm { padding: 4px 10px; font-size: 11px; }

      /* ===== Color Picker ===== */
      .color-picker { display: flex; gap: 8px; flex-wrap: wrap; }
      .color-swatch {
        width: 32px; height: 32px; border-radius: 50%; cursor: pointer;
        border: 3px solid transparent; transition: all var(--duration-fast);
      }
      .color-swatch:hover { transform: scale(1.15); }
      .color-swatch.selected { border-color: var(--app-text-primary); box-shadow: var(--shadow-sm); }

      /* ===== CDN Error Banner ===== */
      .cdn-error-banner {
        background: var(--da-warning); color: #fff; padding: 8px 16px; font-size: 13px;
        text-align: center; flex-shrink: 0;
      }

      /* ===== Scrollbar ===== */
      .domain-preview-area::-webkit-scrollbar, .summary-content::-webkit-scrollbar,
      .outline-dropdown::-webkit-scrollbar { width: 6px; }
      .domain-preview-area::-webkit-scrollbar-track, .summary-content::-webkit-scrollbar-track,
      .outline-dropdown::-webkit-scrollbar-track { background: transparent; }
      .domain-preview-area::-webkit-scrollbar-thumb, .summary-content::-webkit-scrollbar-thumb,
      .outline-dropdown::-webkit-scrollbar-thumb { background: var(--da-ash); border-radius: 3px; }
      .domain-preview-area::-webkit-scrollbar-thumb:hover, .summary-content::-webkit-scrollbar-thumb:hover,
      .outline-dropdown::-webkit-scrollbar-thumb:hover { background: var(--da-stone); }

      @media (prefers-reduced-motion: reduce) {
        *, *::before, *::after { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; }
      }
      /* ===== Layout Domain Picker ===== */
      .layout-domain-picker {
        position: absolute; top: 100%; left: 0; z-index: 600;
        background: var(--app-bg-primary); border: 1px solid var(--app-border-default);
        border-radius: 8px; box-shadow: var(--shadow-md); min-width: 180px;
        padding: 4px; margin-top: 4px;
      }
      .layout-domain-picker-item {
        display: flex; align-items: center; gap: 8px; padding: 6px 10px;
        border-radius: 6px; cursor: pointer; font-size: 13px;
        color: var(--app-text-primary); border: none; background: none;
        width: 100%; text-align: left; font-family: inherit;
        transition: background var(--duration-fast);
      }
      .layout-domain-picker-item:hover { background: var(--app-bg-secondary); }
      .layout-domain-picker-dot {
        width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0;
      }
      .hidden-input { display: none; }
      i[data-feather] {
        display: inline-block;
        width: 1em;
        height: 1em;
        font-style: normal;
        text-align: center;
        line-height: 1;
        vertical-align: middle;
      }
    </style>
  </head>
  <body>
    <div class="toolbar">
      <span class="toolbar-title">Nexus</span>
      <div class="toolbar-menu">
        <div class="search-wrapper">
          <i data-feather="search">&#128269;</i>
          <input type="text" class="toolbar-search" id="global-search" placeholder="検索... ( / )" aria-label="グローバル検索" />
        </div>
        <div class="btn-group" role="group" aria-label="レイアウト切替">
          <button class="toolbar-button" id="layout-grid-btn" title="グリッド (Alt+Shift+1)"><i data-feather="grid">&#8862;</i></button>
          <button class="toolbar-button" id="layout-horizontal-btn" title="横並び (Alt+Shift+2)"><i data-feather="columns">&#9637;</i></button>
          <button class="toolbar-button" id="layout-focus-btn" title="フォーカス (Alt+Shift+3)"><i data-feather="sidebar">&#9703;</i></button>
          <button class="toolbar-button" id="layout-single-btn" title="シングル (Alt+Shift+4)"><i data-feather="square">&#9633;</i></button>
        </div>
        <div class="btn-group" role="group" aria-label="操作">
          <button class="toolbar-button" id="add-domain-btn" title="ドメイン追加"><i data-feather="plus-circle">&#8853;</i></button>
        </div>
        <button class="toolbar-button" id="theme-toggle-btn" title="テーマ切り替え"><i data-feather="moon" id="theme-icon">&#9789;</i></button>
        <div class="btn-group" role="group" aria-label="データ操作">
          <button class="toolbar-button" id="export-json-btn" title="JSONエクスポート"><i data-feather="download">&#8595;</i></button>
          <button class="toolbar-button" id="export-md-btn" title="Markdownエクスポート"><i data-feather="file-text">&#128196;</i></button>
          <button class="toolbar-button" id="import-btn" title="インポート"><i data-feather="upload">&#8593;</i></button>
        </div>
        <nav class="toolbar-nav" role="navigation" aria-label="ツール切り替え">
          <a href="index.html">HTML</a>
          <a href="markdown_preview.html">MD</a>
          <a href="loom.html">Loom</a>
          <a href="shelf.html">Shelf</a>
          <a href="tangle.html">Tangle</a>
          <a href="nexus.html" class="nav-active">Nexus</a>
        </nav>
      </div>
    </div>

    <div id="cdn-error-banner" class="cdn-error-banner" style="display:none"></div>
    <div class="nexus-workspace" id="workspace"></div>
    <div class="resize-overlay" id="resize-overlay"></div>

    <!-- Quick Capture Modal -->
    <div class="modal-overlay" id="quick-capture-overlay">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="qc-modal-title">
        <div class="modal-header">
          <span class="modal-title" id="qc-modal-title">クイックキャプチャ</span>
          <button class="modal-close-btn" id="qc-close-btn" aria-label="閉じる"><i data-feather="x">&#10005;</i></button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label" for="qc-domain-select">ドメイン</label>
            <select class="form-input" id="qc-domain-select"></select>
          </div>
          <div class="form-group">
            <label class="form-label" for="qc-content-input">内容 (Markdown)</label>
            <textarea class="form-input form-textarea" id="qc-content-input" placeholder="メモ内容..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="qc-cancel-btn">キャンセル</button>
          <button class="btn btn-primary" id="qc-save-btn">追記</button>
        </div>
      </div>
    </div>

    <!-- Domain Settings Modal -->
    <div class="modal-overlay" id="domain-settings-overlay">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="ds-modal-title">
        <div class="modal-header">
          <span class="modal-title" id="ds-modal-title">ドメイン設定</span>
          <button class="modal-close-btn" id="ds-close-btn" aria-label="閉じる"><i data-feather="x">&#10005;</i></button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label" for="ds-name-input">ドメイン名</label>
            <input type="text" class="form-input" id="ds-name-input" placeholder="ドメイン名" maxlength="100" />
          </div>
          <div class="form-group">
            <label class="form-label">カラー</label>
            <div class="color-picker" id="ds-color-picker"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-danger btn-sm" id="ds-delete-btn" style="margin-right:auto">削除</button>
          <button class="btn btn-secondary" id="ds-cancel-btn">キャンセル</button>
          <button class="btn btn-primary" id="ds-save-btn">保存</button>
        </div>
      </div>
    </div>

    <!-- Confirm Modal -->
    <div class="modal-overlay" id="confirm-overlay">
      <div class="modal modal-sm" role="dialog" aria-modal="true">
        <div class="modal-header">
          <span class="modal-title" id="confirm-title">確認</span>
        </div>
        <div class="modal-body"><p id="confirm-message"></p></div>
        <div class="modal-footer" id="confirm-footer"></div>
      </div>
    </div>

    <input type="file" id="import-file-input" accept=".json,application/json" class="hidden-input" />

    <script>
    (function() {
      'use strict';
      // ===== Config =====
      const CONFIG = {
        storageKey: 'nexus_data', backupKey: 'nexus_data_backup', themeKey: 'nexusTheme',
        v1BackupKey: 'nexus_data_v1_backup',
        debounceDelay: 300, searchDebounceDelay: 200,
        minDomains: 2, maxDomains: 8,
        maxDomainContentLen: 200000, maxSummaryLen: 50000,
        maxFileSize: 5 * 1024 * 1024,
        storageSizeWarning: 4 * 1024 * 1024,
        domainColors: ['#5b8fcc','#4aaa9a','#c7a04e','#c76b7e','#8b6fc0','#5aab6b','#c78856','#4a9ec7'],
        defaultDomains: ['アプリ','インフラ','PMO','マイグレーション'],
      };
      const DOMAIN_ALLOWED_KEYS = ['id','name','color','summary','summaryCollapsed','content'];

      // ===== CDN Checks =====
      const hasMarked = typeof window.marked !== 'undefined';
      const hasDOMPurify = typeof window.DOMPurify !== 'undefined';
      const hasFeather = typeof window.feather !== 'undefined';
      const hasCodeMirror = typeof window.CodeMirror !== 'undefined';
      function safeReplaceIcons(root) {
        try { if (hasFeather) feather.replace(root ? { root: root } : undefined); } catch(_) {}
      }
      const canRenderMarkdown = hasMarked && hasDOMPurify;
      const debounce = window._ ? _.debounce : function(fn, delay) {
        let tid; return function(...a) { clearTimeout(tid); tid = setTimeout(() => fn.apply(this, a), delay); };
      };
      const SANITIZE_CONFIG = canRenderMarkdown ? {
        ALLOWED_TAGS: ['p','h1','h2','h3','h4','h5','h6','ul','ol','li','strong','em','code','pre','blockquote','a','br','hr','table','thead','tbody','tr','th','td','del'],
        ALLOWED_ATTR: ['href','src','alt','title','class','target'],
        ALLOWED_URI_REGEXP: /^(?:(?:https?|mailto):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i,
        ADD_ATTR: ['target'],
      } : null;

      // ===== Utilities =====
      function escHtml(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
      function genId() { return Date.now().toString(36) + Math.random().toString(36).slice(2, 9); }
      function deepClone(o) { return JSON.parse(JSON.stringify(o)); }
      function renderMarkdown(text) {
        if (!canRenderMarkdown || !text) return text ? '<p>' + escHtml(text) + '</p>' : '';
        try {
          const raw = marked.parse(text, { breaks: true, gfm: true });
          let html = DOMPurify.sanitize(raw, SANITIZE_CONFIG);
          const tmp = document.createElement('div'); tmp.innerHTML = html;
          tmp.querySelectorAll('a').forEach(a => {
            const h = a.getAttribute('href') || '';
            if (/^https?:\/\//i.test(h)) a.setAttribute('target', '_blank');
            else a.removeAttribute('target');
            a.setAttribute('rel', 'noopener noreferrer');
          });
          return tmp.innerHTML;
        } catch(_) { return '<p>' + escHtml(text) + '</p>'; }
      }

      // ===== DOM Refs =====
      const el = {
        workspace: document.getElementById('workspace'),
        resizeOverlay: document.getElementById('resize-overlay'),
        globalSearch: document.getElementById('global-search'),
        themeBtn: document.getElementById('theme-toggle-btn'),
        themeIcon: document.getElementById('theme-icon'),
        cdnBanner: document.getElementById('cdn-error-banner'),
        importFileInput: document.getElementById('import-file-input'),
        // Quick capture
        qcOverlay: document.getElementById('quick-capture-overlay'),
        qcDomainSelect: document.getElementById('qc-domain-select'),
        qcContent: document.getElementById('qc-content-input'),
        // Domain settings
        dsOverlay: document.getElementById('domain-settings-overlay'),
        dsName: document.getElementById('ds-name-input'),
        dsColorPicker: document.getElementById('ds-color-picker'),
        // Confirm
        confirmOverlay: document.getElementById('confirm-overlay'),
        confirmTitle: document.getElementById('confirm-title'),
        confirmMessage: document.getElementById('confirm-message'),
        confirmFooter: document.getElementById('confirm-footer'),
        // Layout buttons
        layoutBtns: {
          grid: document.getElementById('layout-grid-btn'),
          horizontal: document.getElementById('layout-horizontal-btn'),
          focus: document.getElementById('layout-focus-btn'),
          single: document.getElementById('layout-single-btn'),
        },
      };

      // ===== State =====
      const state = {
        data: null, theme: 'light',
        editingSummary: null, // domainId
        searchQuery: '',
        confirmResolve: null,
        dsDomainId: null,
        cmInstances: {},  // domainId -> CodeMirror instance
        paneMode: {},     // domainId -> 'edit' | 'preview'
        searchMarks: {},  // domainId -> [TextMarker]
      };

      // ===== Storage =====
      function createDefaultState() {
        return {
          version: 2,
          domains: CONFIG.defaultDomains.map((name, i) => ({
            id: genId(), name, color: CONFIG.domainColors[i], summary: '', summaryCollapsed: false, content: '',
          })),
          layout: 'grid', focusDomainId: null, gridSizes: null,
        };
      }

      // ===== Migration v1 -> v2 =====
      function migrateV1toV2(data) {
        if (!data || data.version === 2) return data;
        let migrated = false;
        for (const d of data.domains) {
          if (!Array.isArray(d.entries)) continue;
          const parts = [];
          for (const raw of d.entries) {
            const e = (raw && typeof raw === 'object') ? raw : {};
            const title = (typeof e.title === 'string' ? e.title : '').replace(/[\r\n]/g, ' ').trim() || 'Untitled';
            let block = '## ' + title;
            const tags = Array.isArray(e.tags) ? e.tags : (typeof e.tags === 'string' ? e.tags.split(',').map(t => t.trim()).filter(Boolean) : []);
            if (tags.length) {
              block += '\n\nTags: ' + tags.join(', ');
            }
            if (typeof e.content === 'string' && e.content) {
              block += '\n\n' + e.content;
            }
            parts.push(block);
          }
          d.content = parts.join('\n\n---\n\n');
          delete d.entries;
          migrated = true;
        }
        data.version = 2;
        return data;
      }

      function validateData(data) {
        if (!data || typeof data !== 'object' || Array.isArray(data)) return false;
        if (!Array.isArray(data.domains)) return false;
        if (data.domains.length < CONFIG.minDomains || data.domains.length > CONFIG.maxDomains) return false;
        for (const d of data.domains) {
          if (!d || typeof d !== 'object') return false;
          if (typeof d.id !== 'string' || typeof d.name !== 'string') return false;
          if (typeof d.color !== 'string' || !/^#[0-9a-fA-F]{6}$/.test(d.color)) return false;
          if (d.summary == null) d.summary = '';
          if (typeof d.summary !== 'string' || d.summary.length > CONFIG.maxSummaryLen) return false;
          if (d.summaryCollapsed == null) d.summaryCollapsed = false;
          if (typeof d.summaryCollapsed !== 'boolean') d.summaryCollapsed = false;
          if (d.content == null) d.content = '';
          if (typeof d.content !== 'string') return false;
          if (d.content.length > CONFIG.maxDomainContentLen) d.content = d.content.slice(0, CONFIG.maxDomainContentLen);
        }
        if (!['grid','horizontal','focus','single'].includes(data.layout)) data.layout = 'grid';
        return true;
      }

      function loadData() {
        try {
          const raw = localStorage.getItem(CONFIG.storageKey);
          if (raw) {
            try {
              let data = JSON.parse(raw);
              // v1 -> v2 migration
              if (data && data.version !== 2 && Array.isArray(data.domains) && data.domains.some(d => Array.isArray(d.entries))) {
                safeSetItem(CONFIG.v1BackupKey, raw);
                data = migrateV1toV2(data);
                if (validateData(data)) {
                  safeSetItem(CONFIG.storageKey, JSON.stringify(data));
                  showToast('データをv2に移行しました。タグはテキストとして保持されています');
                  return data;
                }
              }
              if (validateData(data)) return data;
            } catch(_) {}
            try {
              const backup = localStorage.getItem(CONFIG.backupKey);
              if (backup) {
                const bd = JSON.parse(backup);
                if (bd.version !== 2 && Array.isArray(bd.domains)) {
                  const migrated = migrateV1toV2(deepClone(bd));
                  if (validateData(migrated)) { showToast('バックアップデータをv2に移行しました', 'warning'); return migrated; }
                }
                if (validateData(bd)) { showToast('データを自動復元しました', 'warning'); return bd; }
              }
            } catch(_) {}
            showToast('データ破損により初期化しました', 'error');
          }
        } catch(_) {
          // localStorage access denied (e.g. SecurityError in privacy mode)
        }
        return createDefaultState();
      }

      function safeSetItem(key, value) {
        try { localStorage.setItem(key, value); return true; }
        catch(e) {
          if (e.name === 'QuotaExceededError') showToast('保存容量超過。不要なコンテンツを削除してください', 'error');
          return false;
        }
      }
      function saveData() {
        const json = JSON.stringify(state.data);
        if (json.length > CONFIG.storageSizeWarning) {
          showToast('データサイズが大きくなっています（' + Math.round(json.length / 1024) + 'KB）', 'warning');
        }
        safeSetItem(CONFIG.storageKey, json);
      }
      const debouncedSave = debounce(saveData, CONFIG.debounceDelay);

      // ===== Theme =====
      function applyTheme(theme) {
        state.theme = theme;
        document.documentElement.setAttribute('data-theme', theme);
        safeSetItem(CONFIG.themeKey, theme);
        const iconName = theme === 'dark' ? 'sun' : 'moon';
        el.themeIcon.setAttribute('data-feather', iconName);
        el.themeIcon.textContent = iconName === 'sun' ? '\u2600' : '\u263D';
        safeReplaceIcons();
        el.themeBtn.classList.add('theme-icon-spin');
        setTimeout(() => el.themeBtn.classList.remove('theme-icon-spin'), 400);
      }
      function loadTheme() {
        try { return localStorage.getItem(CONFIG.themeKey) || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'); }
        catch(_) { return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'; }
      }

      // ===== Toast =====
      function showToast(msg, type) {
        const old = document.querySelector('.temp-message'); if (old) old.remove();
        const div = document.createElement('div');
        div.className = 'temp-message' + (type === 'error' ? ' toast-error' : type === 'warning' ? ' toast-warning' : '');
        div.setAttribute('role', 'status'); div.textContent = msg;
        document.body.appendChild(div);
        setTimeout(() => { div.classList.add('toast-out'); setTimeout(() => div.remove(), 300); }, 2500);
      }

      // ===== Layout =====
      function applyLayout(layout, keepSizes) {
        state.data.layout = layout;
        if (!keepSizes) state.data.gridSizes = null;
        Object.entries(el.layoutBtns).forEach(([k, btn]) => btn.classList.toggle('active', k === layout));
        debouncedSave();
        renderWorkspace();
      }

      function setGridTemplate() {
        const ws = el.workspace;
        const n = state.data.domains.length;
        const layout = state.data.layout;
        const gs = state.data.gridSizes;
        if (layout === 'single') {
          ws.style.gridTemplateColumns = '1fr';
          ws.style.gridTemplateRows = '1fr';
        } else if (layout === 'horizontal') {
          ws.style.gridTemplateColumns = gs?.cols || 'repeat(' + n + ', 1fr)';
          ws.style.gridTemplateRows = gs?.rows || '1fr';
        } else if (layout === 'focus') {
          const others = state.data.domains.filter(d => d.id !== getFocusDomainId());
          if (n <= 2) {
            ws.style.gridTemplateColumns = gs?.cols || '1fr 1fr';
            ws.style.gridTemplateRows = gs?.rows || '1fr';
          } else {
            ws.style.gridTemplateColumns = gs?.cols || '1fr 1fr';
            ws.style.gridTemplateRows = gs?.rows || 'repeat(' + others.length + ', 1fr)';
          }
        } else {
          const cols = Math.ceil(n / 2);
          const rows = n > cols ? 2 : 1;
          ws.style.gridTemplateColumns = gs?.cols || 'repeat(' + cols + ', 1fr)';
          ws.style.gridTemplateRows = gs?.rows || (rows === 2 ? '1fr 1fr' : '1fr');
        }
      }

      function getFocusDomainId() {
        const fid = state.data.focusDomainId;
        if (fid && state.data.domains.some(d => d.id === fid)) return fid;
        return state.data.domains[0]?.id || null;
      }

      // ===== Gutter Resize =====
      let gutterState = null;
      function setupGutterResize() {
        const ws = el.workspace;
        function getTrackSizes() {
          const cs = getComputedStyle(ws);
          return {
            cols: cs.gridTemplateColumns.split(' ').map(parseFloat),
            rows: cs.gridTemplateRows.split(' ').map(parseFloat),
          };
        }
        function gapCenters(sizes, gap) {
          const c = []; let pos = 0;
          for (let i = 0; i < sizes.length - 1; i++) { pos += sizes[i]; c.push({ center: pos + gap/2, index: i }); pos += gap; }
          return c;
        }
        function findGap(mousePos, centers, threshold) {
          for (const g of centers) { if (Math.abs(mousePos - g.center) <= threshold) return g; }
          return null;
        }
        ws.onmousemove = function(e) {
          if (gutterState) return;
          const rect = ws.getBoundingClientRect();
          const { cols, rows } = getTrackSizes();
          const ch = findGap(e.clientX - rect.left, gapCenters(cols, 6), 7);
          const rh = findGap(e.clientY - rect.top, gapCenters(rows, 6), 7);
          ws.style.cursor = ch && !rh ? 'col-resize' : rh && !ch ? 'row-resize' : '';
        };
        ws.onmousedown = function(e) {
          if (e.target !== ws && !e.target.classList.contains('nexus-workspace')) return;
          const rect = ws.getBoundingClientRect();
          const { cols, rows } = getTrackSizes();
          const ch = findGap(e.clientX - rect.left, gapCenters(cols, 6), 7);
          const rh = findGap(e.clientY - rect.top, gapCenters(rows, 6), 7);
          if (!ch && !rh) return;
          const type = ch ? 'col' : 'row';
          const idx = ch ? ch.index : rh.index;
          const sizes = ch ? [...cols] : [...rows];
          gutterState = { type, index: idx, sizes, startMouse: type === 'col' ? e.clientX : e.clientY };
          el.resizeOverlay.style.display = 'block';
          el.resizeOverlay.style.cursor = type === 'col' ? 'col-resize' : 'row-resize';
          e.preventDefault();
        };
      }
      document.addEventListener('mousemove', function(e) {
        if (!gutterState) return;
        const { type, index, sizes, startMouse } = gutterState;
        const delta = (type === 'col' ? e.clientX : e.clientY) - startMouse;
        const ns = [...sizes]; const min = 80;
        let a = sizes[index] + delta, b = sizes[index + 1] - delta;
        if (a < min) { a = min; b = sizes[index] + sizes[index + 1] - min; }
        if (b < min) { b = min; a = sizes[index] + sizes[index + 1] - min; }
        ns[index] = a; ns[index + 1] = b;
        const total = ns.reduce((s, v) => s + v, 0);
        const fr = ns.map(s => (s / total * ns.length).toFixed(4) + 'fr').join(' ');
        if (type === 'col') el.workspace.style.gridTemplateColumns = fr;
        else el.workspace.style.gridTemplateRows = fr;
      });
      document.addEventListener('mouseup', function() {
        if (!gutterState) return;
        el.resizeOverlay.style.display = 'none';
        state.data.gridSizes = {
          cols: el.workspace.style.gridTemplateColumns, rows: el.workspace.style.gridTemplateRows,
        };
        gutterState = null;
        // Refresh all CodeMirror instances after resize
        Object.values(state.cmInstances).forEach(cm => { try { cm.refresh(); } catch(_) {} });
        debouncedSave();
      });

      // ===== Domain CRUD =====
      function addDomain(name, color) {
        if (state.data.domains.length >= CONFIG.maxDomains) { showToast('ドメイン数の上限(' + CONFIG.maxDomains + ')に達しています', 'error'); return; }
        state.data.domains.push({ id: genId(), name: name.slice(0, 100), color, summary: '', summaryCollapsed: false, content: '' });
        saveData(); renderWorkspace();
      }
      function updateDomain(id, name, color) {
        const d = state.data.domains.find(d => d.id === id); if (!d) return;
        d.name = name.slice(0, 100); d.color = color;
        saveData(); renderWorkspace();
      }
      function deleteDomain(id) {
        if (state.data.domains.length <= CONFIG.minDomains) { showToast('ドメインは最低' + CONFIG.minDomains + 'つ必要です', 'error'); return; }
        destroyCmInstance(id);
        state.data.domains = state.data.domains.filter(d => d.id !== id);
        if (state.data.focusDomainId === id) state.data.focusDomainId = null;
        delete state.paneMode[id];
        saveData(); renderWorkspace();
      }

      // ===== CodeMirror Instance Management =====
      function destroyCmInstance(domainId) {
        if (state.cmInstances[domainId]) {
          try { state.cmInstances[domainId].toTextArea(); } catch(_) {}
          delete state.cmInstances[domainId];
        }
        if (state.searchMarks[domainId]) {
          state.searchMarks[domainId].forEach(m => { try { m.clear(); } catch(_) {} });
          delete state.searchMarks[domainId];
        }
      }
      function destroyAllCmInstances() {
        Object.keys(state.cmInstances).forEach(destroyCmInstance);
      }

      function createCmInstance(textarea, domainId) {
        if (!hasCodeMirror) return null;
        const cm = CodeMirror.fromTextArea(textarea, {
          lineNumbers: false,
          mode: 'markdown',
          lineWrapping: true,
          extraKeys: { Enter: 'newlineAndIndentContinueMarkdownList' },
        });
        cm.on('change', () => {
          const d = state.data.domains.find(d => d.id === domainId);
          if (d) {
            d.content = cm.getValue().slice(0, CONFIG.maxDomainContentLen);
            debouncedSave();
          }
        });
        state.cmInstances[domainId] = cm;
        // Apply search highlights if active
        if (state.searchQuery) applySearchHighlight(domainId);
        return cm;
      }

      // ===== Summary =====
      function updateSummary(domainId, text) {
        const d = state.data.domains.find(d => d.id === domainId); if (!d) return;
        d.summary = (text || '').slice(0, CONFIG.maxSummaryLen);
        debouncedSave();
      }

      // ===== Search =====
      const debouncedSearch = debounce(function(query) {
        state.searchQuery = query.toLowerCase().trim();
        // Apply/clear highlights on all CM instances
        state.data.domains.forEach(d => {
          if (state.cmInstances[d.id]) applySearchHighlight(d.id);
        });
        renderWorkspace();
      }, CONFIG.searchDebounceDelay);

      function applySearchHighlight(domainId) {
        // Clear old marks
        if (state.searchMarks[domainId]) {
          state.searchMarks[domainId].forEach(m => { try { m.clear(); } catch(_) {} });
        }
        state.searchMarks[domainId] = [];
        const cm = state.cmInstances[domainId];
        if (!cm || !state.searchQuery) return;
        const query = state.searchQuery;
        const text = cm.getValue().toLowerCase();
        let idx = 0;
        while ((idx = text.indexOf(query, idx)) >= 0) {
          const from = cm.posFromIndex(idx);
          const to = cm.posFromIndex(idx + query.length);
          const mark = cm.markText(from, to, { className: 'cm-search-highlight' });
          state.searchMarks[domainId].push(mark);
          idx += query.length;
        }
      }

      function domainMatchesSearch(domain) {
        if (!state.searchQuery) return true;
        const haystack = (domain.name + ' ' + domain.content + ' ' + (domain.summary || '')).toLowerCase();
        return haystack.includes(state.searchQuery);
      }

      // ===== Heading Outline =====
      function extractHeadings(content) {
        const lines = (content || '').split('\n');
        const headings = [];
        for (let i = 0; i < lines.length; i++) {
          const match = lines[i].match(/^(#{1,6})\s+(.+)$/);
          if (match) {
            const text = match[2].replace(/[\x00-\x1f]/g, '').slice(0, 200);
            headings.push({ level: match[1].length, text, line: i });
          }
        }
        return headings;
      }

      // ===== Rendering =====
      function renderWorkspace() {
        // Save CM cursors before destroying
        const cursors = {};
        const scrolls = {};
        Object.entries(state.cmInstances).forEach(([id, cm]) => {
          try {
            cursors[id] = cm.getCursor();
            scrolls[id] = cm.getScrollInfo();
          } catch(_) {}
        });
        destroyAllCmInstances();

        const ws = el.workspace;
        ws.innerHTML = '';
        const domains = state.data.domains;
        const layout = state.data.layout;
        const n = domains.length;
        if (layout === 'single') {
          const fid = getFocusDomainId();
          const dom = domains.find(d => d.id === fid) || domains[0];
          if (dom) ws.appendChild(renderPane(dom));
        } else if (layout === 'focus') {
          const fid = getFocusDomainId();
          const focusDom = domains.find(d => d.id === fid) || domains[0];
          const others = domains.filter(d => d.id !== focusDom.id);
          const fp = renderPane(focusDom);
          if (n > 2) { fp.style.gridColumn = '1'; fp.style.gridRow = '1 / ' + (others.length + 1); }
          ws.appendChild(fp);
          others.forEach((d, i) => {
            const p = renderPane(d);
            if (n > 2) { p.style.gridColumn = '2'; p.style.gridRow = String(i + 1); }
            ws.appendChild(p);
          });
        } else {
          domains.forEach(d => ws.appendChild(renderPane(d)));
        }
        setGridTemplate();
        safeReplaceIcons();

        // Initialize CodeMirror instances
        state.data.domains.forEach(d => {
          const mode = state.paneMode[d.id] || 'edit';
          if (mode === 'edit') {
            const paneEl = ws.querySelector('[data-domain-id="' + d.id + '"]');
            if (!paneEl) return;
            const ta = paneEl.querySelector('.domain-cm-textarea');
            if (ta) {
              const cm = createCmInstance(ta, d.id);
              if (cm) {
                // Restore cursor and scroll
                if (cursors[d.id]) {
                  try { cm.setCursor(cursors[d.id]); } catch(_) {}
                }
                if (scrolls[d.id]) {
                  try { cm.scrollTo(scrolls[d.id].left, scrolls[d.id].top); } catch(_) {}
                }
                setTimeout(() => { try { cm.refresh(); } catch(_) {} }, 0);
              }
            }
          }
        });
      }

      function renderPane(domain) {
        const pane = document.createElement('div');
        pane.className = 'domain-pane'; pane.dataset.domainId = domain.id;
        const mode = state.paneMode[domain.id] || 'edit';

        // Header
        const header = document.createElement('div'); header.className = 'domain-pane-header';
        const colorBar = document.createElement('div'); colorBar.className = 'domain-color-bar';
        colorBar.style.backgroundColor = domain.color;
        const nameEl = document.createElement('div'); nameEl.className = 'domain-name';
        nameEl.textContent = domain.name;
        const actions = document.createElement('div'); actions.className = 'domain-actions';

        // Outline button
        const outlineBtn = document.createElement('button');
        outlineBtn.className = 'pane-btn'; outlineBtn.title = 'アウトライン';
        outlineBtn.innerHTML = '<i data-feather="list">&#9776;</i>';
        outlineBtn.style.position = 'relative';
        outlineBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleOutlineDropdown(outlineBtn, domain);
        });

        // Edit/Preview toggle
        const toggleBtn = document.createElement('button');
        toggleBtn.className = 'pane-btn' + (mode === 'preview' ? ' active' : '');
        toggleBtn.title = mode === 'edit' ? 'プレビュー' : '編集';
        toggleBtn.innerHTML = mode === 'edit'
          ? '<i data-feather="eye">&#128065;</i>'
          : '<i data-feather="edit-2">&#9998;</i>';
        toggleBtn.addEventListener('click', () => {
          // Save CM content before switching
          const cm = state.cmInstances[domain.id];
          if (cm) {
            domain.content = cm.getValue().slice(0, CONFIG.maxDomainContentLen);
            debouncedSave();
          }
          state.paneMode[domain.id] = mode === 'edit' ? 'preview' : 'edit';
          renderWorkspace();
        });

        // Focus button
        const focusBtn = document.createElement('button');
        focusBtn.className = 'pane-btn'; focusBtn.title = 'フォーカス';
        focusBtn.innerHTML = '<i data-feather="maximize-2">&#10530;</i>';
        focusBtn.addEventListener('click', () => {
          state.data.focusDomainId = domain.id; debouncedSave();
          if (state.data.layout !== 'focus' && state.data.layout !== 'single') applyLayout('focus');
          else renderWorkspace();
        });

        // Settings button
        const settingsBtn = document.createElement('button');
        settingsBtn.className = 'pane-btn'; settingsBtn.title = 'ドメイン設定';
        settingsBtn.innerHTML = '<i data-feather="settings">&#9881;</i>';
        settingsBtn.addEventListener('click', () => openDomainSettings(domain.id));

        actions.append(outlineBtn, toggleBtn, focusBtn, settingsBtn);
        header.append(colorBar, nameEl, actions);
        pane.appendChild(header);

        // Summary area
        const summaryArea = document.createElement('div'); summaryArea.className = 'domain-summary-area';
        if (state.editingSummary === domain.id) {
          const editArea = document.createElement('div'); editArea.className = 'summary-edit-area';
          const ta = document.createElement('textarea'); ta.value = domain.summary;
          ta.placeholder = 'AI要約をMarkdownで入力...';
          const btns = document.createElement('div'); btns.className = 'summary-edit-btns';
          btns.innerHTML = '<button class="btn btn-sm btn-secondary">キャンセル</button><button class="btn btn-sm btn-primary">保存</button>';
          btns.children[0].addEventListener('click', () => { state.editingSummary = null; renderWorkspace(); });
          btns.children[1].addEventListener('click', () => { updateSummary(domain.id, ta.value); state.editingSummary = null; renderWorkspace(); });
          editArea.append(ta, btns); summaryArea.appendChild(editArea);
        } else {
          const toggle = document.createElement('button'); toggle.className = 'summary-toggle' + (domain.summaryCollapsed ? ' collapsed' : '');
          toggle.innerHTML = '<i data-feather="chevron-down">&#9660;</i><span>AI Summary</span>';
          const editBtn = document.createElement('button');
          editBtn.className = 'pane-btn'; editBtn.style.marginLeft = 'auto';
          editBtn.innerHTML = '<i data-feather="edit-2">&#9998;</i>'; editBtn.title = '要約編集';
          editBtn.addEventListener('click', (e) => { e.stopPropagation(); state.editingSummary = domain.id; renderWorkspace(); });
          toggle.appendChild(editBtn);
          toggle.addEventListener('click', (e) => {
            if (e.target.closest('.pane-btn')) return;
            domain.summaryCollapsed = !domain.summaryCollapsed; debouncedSave(); renderWorkspace();
          });
          summaryArea.appendChild(toggle);
          if (!domain.summaryCollapsed) {
            const content = document.createElement('div'); content.className = 'summary-content preview-content';
            content.innerHTML = domain.summary ? renderMarkdown(domain.summary) : '<em style="color:var(--app-text-muted);font-size:12px">要約なし</em>';
            summaryArea.appendChild(content);
          }
        }
        pane.appendChild(summaryArea);

        // Editor / Preview area
        const editorArea = document.createElement('div'); editorArea.className = 'domain-editor-area';
        if (mode === 'preview') {
          const previewDiv = document.createElement('div');
          previewDiv.className = 'domain-preview-area preview-content';
          previewDiv.innerHTML = renderMarkdown(domain.content) || '<em style="color:var(--app-text-muted);font-size:12px">コンテンツなし</em>';
          editorArea.appendChild(previewDiv);
        } else {
          if (hasCodeMirror) {
            const ta = document.createElement('textarea');
            ta.className = 'domain-cm-textarea';
            ta.value = domain.content;
            editorArea.appendChild(ta);
          } else {
            // Fallback: plain textarea
            const ta = document.createElement('textarea');
            ta.className = 'domain-fallback-textarea';
            ta.value = domain.content;
            ta.placeholder = 'Markdownでメモを入力...';
            ta.addEventListener('input', () => {
              domain.content = ta.value.slice(0, CONFIG.maxDomainContentLen);
              debouncedSave();
            });
            editorArea.appendChild(ta);
          }
        }
        pane.appendChild(editorArea);

        return pane;
      }

      // ===== Outline Dropdown =====
      let activeOutline = null;
      let outlineClickOutHandler = null;
      function closeOutlineDropdown() {
        if (activeOutline) {
          activeOutline.remove(); activeOutline = null;
        }
        if (outlineClickOutHandler) {
          document.removeEventListener('click', outlineClickOutHandler, true);
          outlineClickOutHandler = null;
        }
      }
      function toggleOutlineDropdown(btnEl, domain) {
        if (activeOutline) { closeOutlineDropdown(); return; }
        const headings = extractHeadings(domain.content);
        if (headings.length === 0) { showToast('見出し（## ...）がありません'); return; }
        const dropdown = document.createElement('div');
        dropdown.className = 'outline-dropdown';
        headings.forEach(h => {
          const item = document.createElement('button');
          item.className = 'outline-item';
          item.textContent = h.text;
          item.dataset.level = h.level;
          item.addEventListener('click', (e) => {
            e.stopPropagation();
            closeOutlineDropdown();
            const cm = state.cmInstances[domain.id];
            if (cm) {
              cm.setCursor({ line: h.line, ch: 0 });
              cm.scrollIntoView({ line: h.line, ch: 0 }, 100);
              cm.focus();
            }
          });
          dropdown.appendChild(item);
        });
        btnEl.style.position = 'relative';
        btnEl.appendChild(dropdown);
        activeOutline = dropdown;
        outlineClickOutHandler = (e) => {
          if (!dropdown.contains(e.target) && e.target !== btnEl) closeOutlineDropdown();
        };
        setTimeout(() => document.addEventListener('click', outlineClickOutHandler, true), 0);
      }

      // ===== Confirm Modal =====
      function showConfirm(msg) {
        return new Promise(resolve => {
          state.confirmResolve = resolve;
          el.confirmTitle.textContent = '確認';
          el.confirmMessage.textContent = msg;
          el.confirmFooter.innerHTML = '<button class="btn btn-secondary" id="confirm-no">キャンセル</button><button class="btn btn-danger" id="confirm-yes">削除</button>';
          el.confirmFooter.querySelector('#confirm-no').addEventListener('click', () => { closeConfirm(false); });
          el.confirmFooter.querySelector('#confirm-yes').addEventListener('click', () => { closeConfirm(true); });
          el.confirmOverlay.classList.add('open');
          safeReplaceIcons();
        });
      }
      function showChoice(title, msg, options) {
        return new Promise(resolve => {
          state.confirmResolve = resolve;
          el.confirmTitle.textContent = title;
          el.confirmMessage.textContent = msg;
          el.confirmFooter.innerHTML = '';
          options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'btn ' + (opt.cls || 'btn-secondary');
            btn.textContent = opt.label;
            btn.addEventListener('click', () => closeConfirm(opt.value));
            el.confirmFooter.appendChild(btn);
          });
          el.confirmOverlay.classList.add('open');
        });
      }
      function closeConfirm(val) {
        el.confirmOverlay.classList.remove('open');
        if (state.confirmResolve) { const r = state.confirmResolve; state.confirmResolve = null; r(val); }
      }

      // ===== Quick Capture Modal =====
      function openQuickCapture() {
        el.qcDomainSelect.innerHTML = '';
        state.data.domains.forEach(d => {
          const opt = document.createElement('option'); opt.value = d.id; opt.textContent = d.name;
          el.qcDomainSelect.appendChild(opt);
        });
        el.qcContent.value = '';
        el.qcOverlay.classList.add('open');
        setTimeout(() => el.qcContent.focus(), 50);
      }
      function closeQuickCapture() { el.qcOverlay.classList.remove('open'); }
      function saveQuickCapture() {
        const domId = el.qcDomainSelect.value;
        const content = el.qcContent.value.trim();
        if (!content) { showToast('内容を入力してください', 'error'); return; }
        const d = state.data.domains.find(d => d.id === domId);
        if (!d) return;
        // Append to domain content
        const separator = d.content.trim() ? '\n\n' : '';
        d.content = (d.content + separator + content).slice(0, CONFIG.maxDomainContentLen);
        // Update CM if active
        const cm = state.cmInstances[domId];
        if (cm) cm.setValue(d.content);
        saveData();
        closeQuickCapture();
        showToast('メモを追記しました');
      }

      // ===== Domain Settings Modal =====
      function openDomainSettings(domainId) {
        state.dsDomainId = domainId;
        const d = domainId ? state.data.domains.find(d => d.id === domainId) : null;
        document.getElementById('ds-modal-title').textContent = d ? 'ドメイン設定' : '新規ドメイン';
        el.dsName.value = d ? d.name : '';
        const delBtn = document.getElementById('ds-delete-btn');
        delBtn.style.display = d ? '' : 'none';
        el.dsColorPicker.innerHTML = '';
        const selColor = d ? d.color : CONFIG.domainColors[state.data.domains.length % CONFIG.domainColors.length];
        CONFIG.domainColors.forEach(c => {
          const swatch = document.createElement('div'); swatch.className = 'color-swatch' + (c === selColor ? ' selected' : '');
          swatch.style.backgroundColor = c; swatch.dataset.color = c;
          swatch.addEventListener('click', () => {
            el.dsColorPicker.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
            swatch.classList.add('selected');
          });
          el.dsColorPicker.appendChild(swatch);
        });
        el.dsOverlay.classList.add('open');
        setTimeout(() => el.dsName.focus(), 50);
      }
      function closeDomainSettings() { el.dsOverlay.classList.remove('open'); state.dsDomainId = null; }
      function saveDomainSettings() {
        const name = el.dsName.value.trim();
        if (!name) { showToast('ドメイン名を入力してください', 'error'); return; }
        const sel = el.dsColorPicker.querySelector('.selected');
        const color = sel ? sel.dataset.color : CONFIG.domainColors[0];
        if (state.dsDomainId) { updateDomain(state.dsDomainId, name, color); showToast('ドメインを更新しました'); }
        else { addDomain(name, color); showToast('ドメインを追加しました'); }
        closeDomainSettings();
      }
      function deleteDomainFromSettings() {
        if (!state.dsDomainId) return;
        const d = state.data.domains.find(d => d.id === state.dsDomainId);
        showConfirm('ドメイン「' + (d ? d.name : '') + '」を削除しますか？\nすべてのコンテンツも削除されます。').then(ok => {
          if (ok) { deleteDomain(state.dsDomainId); closeDomainSettings(); showToast('ドメインを削除しました'); }
        });
      }

      // ===== Export =====
      function exportJSON() {
        const data = { version: 2, domains: state.data.domains, exportedAt: new Date().toISOString() };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'nexus_export_' + new Date().toISOString().slice(0, 10) + '.json';
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        showToast('JSONをエクスポートしました');
      }
      function exportMarkdown() {
        let md = '# Nexus Report - ' + new Date().toISOString().slice(0, 10) + '\n\n';
        state.data.domains.forEach(d => {
          md += '## ' + d.name + '\n\n';
          if (d.summary) md += '### AI Summary\n\n> ' + d.summary.replace(/\n/g, '\n> ') + '\n\n';
          if (d.content) md += d.content + '\n\n';
          md += '---\n\n';
        });
        const blob = new Blob([md], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'nexus_report_' + new Date().toISOString().slice(0, 10) + '.md';
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        showToast('Markdownをエクスポートしました');
      }

      // ===== Import =====
      function triggerImport() { el.importFileInput.value = ''; el.importFileInput.click(); }
      async function handleImportFile(file) {
        if (!file) return;
        if (file.size > CONFIG.maxFileSize) { showToast('ファイルサイズが5MBを超えています', 'error'); return; }
        const text = await new Promise((res, rej) => {
          const r = new FileReader(); r.onload = () => res(r.result); r.onerror = () => rej(); r.readAsText(file);
        }).catch(() => null);
        if (!text) { showToast('ファイルの読み込みに失敗しました', 'error'); return; }
        let data;
        try { data = JSON.parse(text); } catch(_) { showToast('JSONの解析に失敗しました', 'error'); return; }
        // Migrate v1 imports
        if (data && data.version !== 2 && Array.isArray(data.domains) && data.domains.some(d => Array.isArray(d.entries))) {
          try { data = migrateV1toV2(deepClone(data)); } catch(_) { showToast('v1データの変換に失敗しました', 'error'); return; }
        }
        const err = validateImport(data);
        if (err) { showToast('インポートエラー: ' + err, 'error'); return; }
        safeSetItem(CONFIG.backupKey, JSON.stringify(state.data));
        const choice = await showChoice('インポート方法', data.domains.length + ' ドメインをインポートします', [
          { label: 'キャンセル', value: null, cls: 'btn-secondary' },
          { label: '既存データに統合', value: 'merge', cls: 'btn-secondary' },
          { label: '完全置換', value: 'replace', cls: 'btn-primary' },
        ]);
        if (!choice) return;
        if (choice === 'replace') {
          if (data.domains.length < CONFIG.minDomains) { showToast('ドメイン数が最低' + CONFIG.minDomains + 'つ必要です', 'error'); return; }
          state.data = { version: 2, domains: data.domains, layout: state.data.layout, focusDomainId: null, gridSizes: null };
          saveData(); renderWorkspace(); showToast('データを置換しました');
        } else {
          const result = mergeImport(state.data, data);
          if (result.error) { showToast(result.error, 'error'); return; }
          state.data = result.data; saveData(); renderWorkspace(); showToast('データを統合しました');
        }
      }

      function validateImport(data) {
        if (!data || typeof data !== 'object' || Array.isArray(data)) return '無効なデータ形式';
        if (typeof data.version !== 'number') return 'versionが不正';
        if (!Array.isArray(data.domains)) return 'domainsが不正';
        if (data.domains.length > CONFIG.maxDomains) return 'ドメイン数が上限(' + CONFIG.maxDomains + ')を超えています';
        const domainIds = new Set(), domainNames = new Set();
        for (let di = 0; di < data.domains.length; di++) {
          const raw = data.domains[di];
          if (!raw || typeof raw !== 'object' || Array.isArray(raw)) return 'ドメイン[' + di + ']が不正';
          const d = {}; for (const k of DOMAIN_ALLOWED_KEYS) { if (Object.prototype.hasOwnProperty.call(raw, k)) d[k] = raw[k]; }
          data.domains[di] = d;
          if (typeof d.id !== 'string' || d.id.length > 20) return 'ドメイン[' + di + ']のidが不正';
          if (domainIds.has(d.id)) return 'ドメインIDが重複: ' + d.id;
          domainIds.add(d.id);
          if (typeof d.name !== 'string' || d.name.length > 100) return 'ドメイン[' + di + ']のnameが不正';
          const nameLower = d.name.toLowerCase();
          if (domainNames.has(nameLower)) return 'ドメイン名 "' + d.name + '" が重複しています';
          domainNames.add(nameLower);
          if (typeof d.color !== 'string' || !/^#[0-9a-fA-F]{6}$/.test(d.color)) return 'ドメイン[' + di + ']のcolorが不正';
          if (d.summary == null) d.summary = '';
          if (typeof d.summary !== 'string' || d.summary.length > CONFIG.maxSummaryLen) return 'ドメイン "' + d.name + '" のsummaryが長さ上限を超えています';
          if (d.summaryCollapsed == null) d.summaryCollapsed = false;
          if (typeof d.summaryCollapsed !== 'boolean') d.summaryCollapsed = false;
          if (d.content == null) d.content = '';
          if (typeof d.content !== 'string') return 'ドメイン "' + d.name + '" のcontentが不正';
          if (d.content.length > CONFIG.maxDomainContentLen) return 'ドメイン "' + d.name + '" のcontent長が上限を超えています';
        }
        return null;
      }

      function mergeImport(existing, imported) {
        const result = deepClone(existing);
        for (const impDom of imported.domains) {
          const match = result.domains.find(d => d.name.toLowerCase() === impDom.name.toLowerCase());
          if (match) {
            match.color = impDom.color;
            match.summary = impDom.summary || match.summary;
            // Append imported content
            if (impDom.content) {
              const separator = match.content.trim() ? '\n\n---\n\n' : '';
              match.content = (match.content + separator + impDom.content).slice(0, CONFIG.maxDomainContentLen);
            }
          } else {
            const newDom = deepClone(impDom); newDom.id = genId();
            result.domains.push(newDom);
          }
        }
        if (result.domains.length > CONFIG.maxDomains) return { error: 'ドメイン数が上限(' + CONFIG.maxDomains + ')を超えます' };
        return { data: result };
      }

      // ===== Layout Domain Picker =====
      let activePicker = null;
      let pickerClickOutHandler = null;
      function closeLayoutDomainPicker() {
        if (activePicker) {
          const parent = activePicker.parentElement;
          activePicker.remove(); activePicker = null;
          if (parent) parent.style.position = '';
        }
        if (pickerClickOutHandler) { document.removeEventListener('click', pickerClickOutHandler, true); pickerClickOutHandler = null; }
      }
      function showLayoutDomainPicker(btnEl, layout) {
        if (state.data.domains.length === 0) return;
        closeLayoutDomainPicker();
        const picker = document.createElement('div');
        picker.className = 'layout-domain-picker';
        state.data.domains.forEach(d => {
          const item = document.createElement('button'); item.className = 'layout-domain-picker-item';
          const dot = document.createElement('span'); dot.className = 'layout-domain-picker-dot';
          dot.style.backgroundColor = d.color;
          const label = document.createElement('span'); label.textContent = d.name;
          item.append(dot, label);
          item.addEventListener('click', (e) => {
            e.stopPropagation();
            state.data.focusDomainId = d.id;
            closeLayoutDomainPicker();
            applyLayout(layout);
          });
          picker.appendChild(item);
        });
        const parent = btnEl.parentElement; parent.style.position = 'relative';
        parent.appendChild(picker);
        activePicker = picker;
        pickerClickOutHandler = (e) => {
          if (!picker.contains(e.target) && e.target !== btnEl) closeLayoutDomainPicker();
        };
        setTimeout(() => document.addEventListener('click', pickerClickOutHandler, true), 0);
      }

      // ===== Keyboard Shortcuts =====
      document.addEventListener('keydown', function(e) {
        // Ctrl+Shift+N: Quick capture
        if (e.ctrlKey && e.shiftKey && e.key === 'N') { e.preventDefault(); openQuickCapture(); return; }
        // Escape: close modals / clear
        if (e.key === 'Escape') {
          if (activeOutline) { closeOutlineDropdown(); return; }
          if (activePicker) { closeLayoutDomainPicker(); return; }
          if (el.confirmOverlay.classList.contains('open')) { closeConfirm(false); return; }
          if (el.qcOverlay.classList.contains('open')) { closeQuickCapture(); return; }
          if (el.dsOverlay.classList.contains('open')) { closeDomainSettings(); return; }
          if (state.editingSummary) { state.editingSummary = null; renderWorkspace(); return; }
          if (state.searchQuery) { state.searchQuery = ''; el.globalSearch.value = ''; renderWorkspace(); return; }
          return;
        }
        // Skip shortcuts when typing in CodeMirror or input/textarea
        const active = document.activeElement;
        if (active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.tagName === 'SELECT')) return;
        if (active && active.closest('.CodeMirror')) return;
        // /: focus search
        if (e.key === '/') { e.preventDefault(); el.globalSearch.focus(); return; }
        // Alt+1~8: focus domain pane CM
        if (e.altKey && !e.shiftKey && e.key >= '1' && e.key <= '8') {
          const idx = parseInt(e.key) - 1;
          if (idx < state.data.domains.length) {
            e.preventDefault();
            const domId = state.data.domains[idx].id;
            const cm = state.cmInstances[domId];
            if (cm) cm.focus();
          }
          return;
        }
        // Alt+Shift+1~4: layout switch
        if (e.altKey && e.shiftKey) {
          const layouts = ['grid', 'horizontal', 'focus', 'single'];
          const idx = parseInt(e.key) - 1;
          if (idx >= 0 && idx < layouts.length) { e.preventDefault(); applyLayout(layouts[idx]); }
          return;
        }
      });

      // ===== Event Bindings =====
      function bindEvents() {
        el.globalSearch.addEventListener('input', (e) => debouncedSearch(e.target.value));
        el.layoutBtns.grid.addEventListener('click', () => applyLayout('grid'));
        el.layoutBtns.horizontal.addEventListener('click', () => applyLayout('horizontal'));
        el.layoutBtns.focus.addEventListener('click', (e) => showLayoutDomainPicker(e.currentTarget, 'focus'));
        el.layoutBtns.single.addEventListener('click', (e) => showLayoutDomainPicker(e.currentTarget, 'single'));
        document.getElementById('add-domain-btn').addEventListener('click', () => openDomainSettings(null));
        el.themeBtn.addEventListener('click', () => applyTheme(state.theme === 'dark' ? 'light' : 'dark'));
        document.getElementById('export-json-btn').addEventListener('click', exportJSON);
        document.getElementById('export-md-btn').addEventListener('click', exportMarkdown);
        document.getElementById('import-btn').addEventListener('click', triggerImport);
        el.importFileInput.addEventListener('change', (e) => { if (e.target.files[0]) handleImportFile(e.target.files[0]); });
        // Quick capture modal
        document.getElementById('qc-close-btn').addEventListener('click', closeQuickCapture);
        document.getElementById('qc-cancel-btn').addEventListener('click', closeQuickCapture);
        document.getElementById('qc-save-btn').addEventListener('click', saveQuickCapture);
        el.qcContent.addEventListener('keydown', (e) => { if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) { saveQuickCapture(); e.preventDefault(); } });
        // Domain settings modal
        document.getElementById('ds-close-btn').addEventListener('click', closeDomainSettings);
        document.getElementById('ds-cancel-btn').addEventListener('click', closeDomainSettings);
        document.getElementById('ds-save-btn').addEventListener('click', saveDomainSettings);
        document.getElementById('ds-delete-btn').addEventListener('click', deleteDomainFromSettings);
        el.dsName.addEventListener('keydown', (e) => { if (e.key === 'Enter') saveDomainSettings(); });
        // Modal overlay click-to-close
        [el.qcOverlay, el.dsOverlay, el.confirmOverlay].forEach(ov => {
          ov.addEventListener('click', (e) => {
            if (e.target === ov) {
              if (ov === el.confirmOverlay) closeConfirm(false);
              else if (ov === el.qcOverlay) closeQuickCapture();
              else closeDomainSettings();
            }
          });
        });
      }

      // ===== Init =====
      function init() {
        // CDN error banner
        const cdnErrors = [];
        if (!canRenderMarkdown) {
          cdnErrors.push(hasDOMPurify ? 'marked.js' : 'DOMPurify');
        }
        if (!hasCodeMirror) cdnErrors.push('CodeMirror');
        if (cdnErrors.length) {
          el.cdnBanner.style.display = 'block';
          el.cdnBanner.textContent = cdnErrors.join(', ') + ' の読み込みに失敗しました。一部機能が制限されます。';
        }
        // Private browsing detection
        try { localStorage.setItem('__nexus_test__', '1'); localStorage.removeItem('__nexus_test__'); }
        catch(_) { showToast('プライベートモードではデータが保存されません', 'warning'); }

        state.data = loadData();
        applyTheme(loadTheme());
        bindEvents();
        setupGutterResize();
        Object.entries(el.layoutBtns).forEach(([k, btn]) => btn.classList.toggle('active', k === state.data.layout));
        renderWorkspace();
        safeReplaceIcons();
      }
      init();
    })();
    </script>
  </body>
</html>
