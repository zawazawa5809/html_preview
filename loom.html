<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Loom ‚Äî AI Output Workbench</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&family=Noto+Sans+JP:wght@300;400;500;700&display=swap");

      :root {
        --bg-primary: #0f1114;
        --bg-secondary: #161920;
        --bg-tertiary: #1c2028;
        --bg-hover: #222730;
        --border: #2a2f3a;
        --border-light: #363c4a;
        --text-primary: #e0e4ec;
        --text-secondary: #8891a0;
        --text-muted: #5a6270;
        --accent-system: #c79a5e;
        --accent-reference: #5e8fc7;
        --accent-previous: #7e5ec7;
        --accent-instruction: #5ec78a;
        --accent-code: #c7c15e;
        --accent-text: #5ec7c1;
        --accent-config: #c75e8f;
        --accent-data: #c7885e;
        --accent-system-bg: #c79a5e40;
        --accent-reference-bg: #5e8fc740;
        --accent-previous-bg: #7e5ec740;
        --accent-instruction-bg: #5ec78a40;
        --accent-code-bg: #c7c15e40;
        --accent-text-bg: #5ec7c140;
        --accent-config-bg: #c75e8f40;
        --accent-data-bg: #c7885e40;
        --danger: #c75e5e;
        --success: #5ec78a;
        --font-mono: "JetBrains Mono", monospace;
        --font-sans: "Noto Sans JP", sans-serif;
        --radius: 6px;
        --transition: 150ms ease;
        --ease-out-expo: cubic-bezier(0.22, 1, 0.36, 1);
        --duration-fast: 100ms;
        --duration-normal: 200ms;
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.15);
        --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: var(--font-sans);
        background: var(--bg-primary);
        color: var(--text-primary);
        height: 100vh;
        overflow: hidden;
        font-size: 13px;
        line-height: 1.6;
      }

      /* ===== HEADER ===== */
      .header {
        height: 48px;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        flex-shrink: 0;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .logo {
        font-family: var(--font-mono);
        font-size: 16px;
        font-weight: 600;
        letter-spacing: 3px;
        color: var(--text-primary);
      }

      .logo span {
        color: var(--text-muted);
        font-weight: 300;
        font-size: 11px;
        letter-spacing: 1px;
        margin-left: 8px;
      }

      .header-actions {
        display: flex;
        gap: 8px;
      }

      .btn {
        font-family: var(--font-mono);
        font-size: 11px;
        padding: 6px 12px;
        border: 1px solid var(--border);
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        border-radius: var(--radius);
        cursor: pointer;
        transition: all var(--transition);
        white-space: nowrap;
      }

      .btn:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
        border-color: var(--border-light);
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      }

      .btn:active {
        transform: translateY(0);
        box-shadow: none;
      }

      .btn-accent {
        border-color: var(--accent-instruction);
        color: var(--accent-instruction);
      }

      .btn-accent:hover {
        background: var(--accent-instruction);
        color: var(--bg-primary);
        box-shadow: 0 2px 12px rgba(94, 199, 138, 0.3);
      }

      .btn-danger {
        border-color: var(--danger);
        color: var(--danger);
      }

      .btn-danger:hover {
        background: var(--danger);
        color: var(--bg-primary);
      }

      /* Add button accent hover colors */
      #addSystemBtn:hover { border-color: var(--accent-system); color: var(--accent-system); }
      #addReferenceBtn:hover { border-color: var(--accent-reference); color: var(--accent-reference); }
      #addPreviousBtn:hover { border-color: var(--accent-previous); color: var(--accent-previous); }
      #addInstructionBtn:hover { border-color: var(--accent-instruction); color: var(--accent-instruction); }
      #addCodeBtn:hover { border-color: var(--accent-code); color: var(--accent-code); }
      #addTextBtn:hover { border-color: var(--accent-text); color: var(--accent-text); }
      #addConfigBtn:hover { border-color: var(--accent-config); color: var(--accent-config); }
      #addDataBtn:hover { border-color: var(--accent-data); color: var(--accent-data); }

      /* ===== MAIN LAYOUT ===== */
      .main {
        display: flex;
        height: calc(100vh - 48px);
      }

      .panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
      }

      .panel-left {
        border-right: 1px solid var(--border);
      }

      .divider {
        width: 1px;
        background: var(--border);
        cursor: col-resize;
        position: relative;
      }

      .divider::before {
        content: '';
        position: absolute;
        top: 0;
        bottom: 0;
        left: -6px;
        right: -6px;
        z-index: 10;
      }

      .divider::after {
        content: '¬∑¬∑¬∑';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: var(--text-muted);
        font-size: 10px;
        letter-spacing: 2px;
        opacity: 0;
        transition: opacity var(--duration-normal) ease;
        pointer-events: none;
        writing-mode: vertical-lr;
      }

      .divider:hover,
      .divider.dragging {
        background: var(--accent-instruction);
        width: 3px;
        box-shadow: 0 0 8px rgba(94, 199, 138, 0.3);
      }

      .divider:hover::after,
      .divider.dragging::after {
        opacity: 1;
      }

      /* ===== PANEL HEADER ===== */
      .panel-header {
        height: 42px;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
        flex-shrink: 0;
      }

      .panel-title {
        font-family: var(--font-mono);
        font-size: 11px;
        font-weight: 500;
        letter-spacing: 2px;
        text-transform: uppercase;
        color: var(--text-secondary);
      }

      .panel-actions {
        display: flex;
        gap: 6px;
      }

      /* ===== TOKEN BUDGET BAR ===== */
      .token-bar {
        height: 32px;
        background: var(--bg-tertiary);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        padding: 0 16px;
        gap: 12px;
        flex-shrink: 0;
      }

      .token-bar label {
        font-family: var(--font-mono);
        font-size: 10px;
        color: var(--text-muted);
        letter-spacing: 1px;
      }

      .token-track {
        flex: 1;
        height: 6px;
        background: var(--bg-primary);
        border-radius: 3px;
        overflow: hidden;
        position: relative;
      }

      .token-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--accent-instruction), #7ee8aa);
        border-radius: 3px;
        transition:
          width 300ms var(--ease-out-expo),
          background 300ms var(--ease-out-expo);
        box-shadow: 0 0 8px rgba(94, 199, 138, 0.3);
      }

      .token-fill.warning {
        background: linear-gradient(90deg, var(--accent-system), #e0b96e);
        box-shadow: 0 0 8px rgba(199, 154, 94, 0.3);
      }
      .token-fill.danger {
        background: linear-gradient(90deg, var(--danger), #e87070);
        box-shadow: 0 0 8px rgba(199, 94, 94, 0.3);
        animation: danger-pulse 1.5s ease-in-out infinite;
      }

      @keyframes danger-pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
      }

      .token-count {
        font-family: var(--font-mono);
        font-size: 10px;
        color: var(--text-secondary);
        min-width: 100px;
        text-align: right;
        font-variant-numeric: tabular-nums;
      }

      .token-budget-input {
        width: 60px;
        background: var(--bg-primary);
        border: 1px solid var(--border);
        color: var(--text-primary);
        font-family: var(--font-mono);
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 3px;
        text-align: right;
      }

      /* ===== BLOCK LIST ===== */
      .block-list {
        flex: 1;
        overflow-y: auto;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        scrollbar-width: thin;
        scrollbar-color: var(--border) transparent;
      }

      .block-list::-webkit-scrollbar {
        width: 6px;
      }
      .block-list::-webkit-scrollbar-track {
        background: transparent;
      }
      .block-list::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 3px;
      }

      /* ===== BLOCK ===== */
      .block {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        overflow: visible;
        transition: all var(--duration-normal) var(--ease-out-expo);
        position: relative;
        box-shadow: var(--shadow-sm);
      }

      .block::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 3px;
        border-radius: 3px 0 0 3px;
        background: var(--border);
      }

      .block[data-type="system"]::before { background: var(--accent-system); }
      .block[data-type="reference"]::before { background: var(--accent-reference); }
      .block[data-type="previous"]::before { background: var(--accent-previous); }
      .block[data-type="instruction"]::before { background: var(--accent-instruction); }
      .block[data-type="code"]::before { background: var(--accent-code); }
      .block[data-type="text"]::before { background: var(--accent-text); }
      .block[data-type="config"]::before { background: var(--accent-config); }
      .block[data-type="data"]::before { background: var(--accent-data); }

      .block:hover {
        border-color: var(--border-light);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
        transform: translateY(-1px);
      }

      .block.dragging {
        opacity: 0.5;
        transform: scale(0.96) rotate(-1deg);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.35);
      }

      .block.drag-over {
        border-color: var(--accent-instruction);
        box-shadow: 0 0 0 1px var(--accent-instruction);
      }

      .block-head {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        gap: 10px;
        cursor: grab;
        user-select: none;
      }

      .block-head:active {
        cursor: grabbing;
      }

      .block-drag-handle {
        color: var(--text-muted);
        font-size: 10px;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        gap: 2px;
        line-height: 1;
      }

      .block-drag-handle::before,
      .block-drag-handle::after {
        content: "¬∑¬∑";
        letter-spacing: 2px;
      }

      .block-type-badge {
        font-family: var(--font-mono);
        font-size: 9px;
        font-weight: 600;
        letter-spacing: 1.5px;
        text-transform: uppercase;
        padding: 2px 8px;
        border-radius: 3px;
        flex-shrink: 0;
        transition: all var(--duration-fast) ease;
        cursor: pointer;
      }

      .block-type-badge:hover {
        filter: brightness(1.2);
        transform: scale(1.05);
      }

      .block-type-badge.system {
        background: var(--accent-system-bg);
        color: var(--accent-system);
        border: 1px solid #c79a5e66;
      }
      .block-type-badge.reference {
        background: var(--accent-reference-bg);
        color: var(--accent-reference);
        border: 1px solid #5e8fc766;
      }
      .block-type-badge.previous {
        background: var(--accent-previous-bg);
        color: var(--accent-previous);
        border: 1px solid #7e5ec766;
      }
      .block-type-badge.instruction {
        background: var(--accent-instruction-bg);
        color: var(--accent-instruction);
        border: 1px solid #5ec78a66;
      }
      .block-type-badge.code {
        background: var(--accent-code-bg);
        color: var(--accent-code);
        border: 1px solid #c7c15e66;
      }
      .block-type-badge.text {
        background: var(--accent-text-bg);
        color: var(--accent-text);
        border: 1px solid #5ec7c166;
      }
      .block-type-badge.config {
        background: var(--accent-config-bg);
        color: var(--accent-config);
        border: 1px solid #c75e8f66;
      }
      .block-type-badge.data {
        background: var(--accent-data-bg);
        color: var(--accent-data);
        border: 1px solid #c7885e66;
      }

      .block-label {
        flex: 1;
        font-size: 12px;
        font-weight: 500;
        color: var(--text-primary);
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .block-label-input {
        flex: 1;
        background: transparent;
        border: none;
        color: var(--text-primary);
        font-family: var(--font-sans);
        font-size: 12px;
        font-weight: 500;
        outline: none;
        min-width: 0;
      }

      .block-tokens {
        font-family: var(--font-mono);
        font-size: 10px;
        color: var(--text-muted);
        flex-shrink: 0;
      }

      .block-actions {
        display: flex;
        gap: 4px;
        flex-shrink: 0;
      }

      .block-btn {
        width: 22px;
        height: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        background: transparent;
        color: var(--text-muted);
        cursor: pointer;
        border-radius: 3px;
        font-size: 12px;
        transition: all var(--transition);
      }

      .block-btn:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
      }

      .block-btn.delete:hover {
        background: #c75e5e22;
        color: var(--danger);
      }

      .block-body {
        padding: 0 12px 10px 12px;
      }

      .block-textarea {
        width: 100%;
        min-height: 80px;
        background: var(--bg-primary);
        border: 1px solid var(--border);
        border-radius: 4px;
        color: var(--text-primary);
        font-family: var(--font-mono);
        font-size: 12px;
        line-height: 1.7;
        padding: 10px;
        resize: vertical;
        outline: none;
        transition: border-color var(--transition);
      }

      .block-textarea:focus {
        border-color: var(--border-light);
      }

      .block-textarea::placeholder {
        color: var(--text-muted);
      }

      /* ===== COMPOSE AREA ===== */
      .compose-area {
        border-top: 1px solid var(--border);
        background: var(--bg-secondary);
        flex-shrink: 0;
      }

      .compose-toolbar {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        gap: 6px;
      }

      /* ===== OUTPUT PANEL SPECIFICS ===== */
      .output-stats {
        height: 32px;
        background: var(--bg-tertiary);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        padding: 0 16px;
        gap: 16px;
        flex-shrink: 0;
      }

      .stat {
        font-family: var(--font-mono);
        font-size: 10px;
        color: var(--text-muted);
        letter-spacing: 0.5px;
      }

      .stat strong {
        color: var(--text-secondary);
        font-weight: 500;
      }

      /* ===== SNAPSHOT BAR ===== */
      .snapshot-bar {
        height: 36px;
        background: var(--bg-tertiary);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        padding: 0 12px;
        gap: 6px;
        flex-shrink: 0;
        overflow-x: auto;
      }

      .snapshot-chip {
        font-family: var(--font-mono);
        font-size: 10px;
        padding: 3px 10px;
        border: 1px solid var(--border);
        background: var(--bg-secondary);
        color: var(--text-secondary);
        border-radius: 12px;
        cursor: pointer;
        transition: all var(--transition);
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .snapshot-chip:hover {
        border-color: var(--border-light);
        color: var(--text-primary);
      }

      .snapshot-chip.active {
        border-color: var(--accent-instruction);
        color: var(--accent-instruction);
      }

      .snapshot-delete {
        font-size: 10px;
        opacity: 0.5;
        cursor: pointer;
      }

      .snapshot-delete:hover {
        opacity: 1;
        color: var(--danger);
      }

      /* ===== MODAL ===== */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 200ms ease;
      }

      .modal-overlay.active {
        opacity: 1;
        pointer-events: all;
      }

      .modal {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 8px;
        width: 600px;
        max-width: 90vw;
        max-height: 80vh;
        overflow: auto;
        padding: 24px;
      }

      .modal h3 {
        font-family: var(--font-mono);
        font-size: 13px;
        font-weight: 500;
        letter-spacing: 1px;
        margin-bottom: 16px;
        color: var(--text-primary);
      }

      .modal-output {
        width: 100%;
        min-height: 300px;
        background: var(--bg-primary);
        border: 1px solid var(--border);
        border-radius: 4px;
        color: var(--text-primary);
        font-family: var(--font-mono);
        font-size: 12px;
        line-height: 1.7;
        padding: 14px;
        resize: vertical;
        outline: none;
        margin-bottom: 12px;
      }

      .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
      }

      /* ===== TEMPLATE LIST IN MODAL ===== */
      .template-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 16px;
      }

      .template-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 14px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        cursor: pointer;
        transition: all var(--transition);
      }

      .template-item:hover {
        border-color: var(--border-light);
        background: var(--bg-hover);
      }

      .template-name {
        font-size: 12px;
        font-weight: 500;
      }

      .template-meta {
        font-family: var(--font-mono);
        font-size: 10px;
        color: var(--text-muted);
      }

      /* ===== EMPTY STATE ===== */
      .empty-state {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        gap: 8px;
        padding: 60px;
        text-align: center;
      }

      .empty-state-icon {
        font-size: 48px;
        opacity: 0.15;
        margin-bottom: 8px;
        animation: empty-pulse 3s ease-in-out infinite;
      }

      @keyframes empty-pulse {
        0%, 100% { opacity: 0.15; transform: scale(1); }
        50% { opacity: 0.25; transform: scale(1.05); }
      }

      .empty-state-text {
        font-size: 12px;
        line-height: 1.8;
      }

      .empty-state-hint {
        font-family: var(--font-mono);
        font-size: 10px;
        color: var(--text-muted);
        opacity: 0.6;
        margin-top: 4px;
      }

      /* ===== TOAST ===== */
      .toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(20px);
        background: var(--bg-tertiary);
        border: 1px solid var(--border-light);
        border-left: 3px solid var(--accent-instruction);
        color: var(--text-primary);
        font-family: var(--font-mono);
        font-size: 11px;
        padding: 8px 20px;
        border-radius: 8px;
        opacity: 0;
        transition: all 300ms var(--ease-out-expo);
        z-index: 2000;
        pointer-events: none;
        backdrop-filter: blur(8px);
        box-shadow: var(--shadow-md);
      }

      .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }

      /* ===== COLLAPSED BLOCK ===== */
      .block.collapsed .block-body {
        display: none;
      }

      .block.collapsed .block-head {
        padding: 6px 12px;
      }

      /* ===== TYPE SELECTOR DROPDOWN ===== */
      .type-dropdown {
        position: absolute;
        top: 100%;
        left: 40px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-light);
        border-radius: var(--radius);
        padding: 4px;
        z-index: 100;
        display: none;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      }

      .type-dropdown.show {
        display: block;
      }

      .type-dropdown-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        cursor: pointer;
        border-radius: 3px;
        font-size: 11px;
        transition: background var(--transition);
      }

      .type-dropdown-item:hover {
        background: var(--bg-hover);
      }

      /* ===== LIGHT THEME ===== */
      :root[data-theme="light"] {
        --bg-primary: #f8f8fb;
        --bg-secondary: #ffffff;
        --bg-tertiary: #f0f1f5;
        --bg-hover: #e8e9ee;
        --border: #d8dae0;
        --border-light: #c8cad0;
        --text-primary: #1a1a2e;
        --text-secondary: #5a5d6b;
        --text-muted: #8e919e;
        --accent-system-bg: #c79a5e30;
        --accent-reference-bg: #5e8fc730;
        --accent-previous-bg: #7e5ec730;
        --accent-instruction-bg: #5ec78a30;
        --accent-code-bg: #c7c15e30;
        --accent-text-bg: #5ec7c130;
        --accent-config-bg: #c75e8f30;
        --accent-data-bg: #c7885e30;
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.06);
        --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
      }

      /* ===== TOOL NAVIGATION ===== */
      .header-nav {
        display: flex;
        align-items: center;
        gap: 2px;
        margin-left: 16px;
      }
      .header-nav a {
        color: var(--text-secondary);
        text-decoration: none;
        font-family: var(--font-mono);
        font-size: 11px;
        padding: 5px 10px;
        border-radius: var(--radius);
        transition: all var(--transition);
        white-space: nowrap;
      }
      .header-nav a:hover {
        color: var(--text-primary);
        background: var(--bg-hover);
      }
      .header-nav a.nav-active {
        color: var(--accent-instruction);
        background: var(--accent-instruction-bg);
      }

      /* ===== FOCUS VISIBLE ===== */
      :focus-visible {
        outline: 2px solid var(--accent-instruction);
        outline-offset: 2px;
      }

      /* ===== REDUCED MOTION ===== */
      @media (prefers-reduced-motion: reduce) {
        *, *::before, *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }
      }

      /* responsive */
      @media (max-width: 800px) {
        .main {
          flex-direction: column;
        }
        .panel-left {
          border-right: none;
          border-bottom: 1px solid var(--border);
        }
        .divider {
          width: 100%;
          height: 1px;
          cursor: row-resize;
        }
      }
    </style>
  </head>
  <body>
    <!-- HEADER -->
    <div class="header">
      <div class="header-left">
        <div class="logo">LOOM<span>AI Output Workbench</span></div>
        <nav class="header-nav" role="navigation" aria-label="„ÉÑ„Éº„É´Âàá„ÇäÊõø„Åà">
          <a href="index.html">HTML</a>
          <a href="designer.html">Designer</a>
          <a href="markdown_preview.html">MD</a>
          <a href="slides.html">Slides</a>
          <a href="loom.html" class="nav-active">Loom</a>
          <a href="shelf.html">Shelf</a>
          <a href="tangle.html">Tangle</a>
          <a href="nexus.html">Nexus</a>
          <a href="diffuse.html">Diffuse</a>
        </nav>
      </div>
      <div class="header-actions">
        <button class="btn" id="themeToggleBtn" aria-label="„ÉÜ„Éº„ÉûÂàáÊõø">‚òÄ Light</button>
        <button class="btn" id="exportBtn" aria-label="„Ç®„ÇØ„Çπ„Éù„Éº„Éà">‚Üì Export</button>
        <button class="btn" id="importBtn" aria-label="„Ç§„É≥„Éù„Éº„Éà">‚Üë Import</button>
        <input
          type="file"
          id="importFile"
          accept=".json"
          style="display: none"
        />
        <button class="btn btn-danger" id="clearAllBtn" aria-label="„Åô„Åπ„Å¶„ÇØ„É™„Ç¢">Clear All</button>
      </div>
    </div>

    <!-- MAIN -->
    <div class="main">
      <!-- LEFT: CONTEXT BUILDER -->
      <div class="panel panel-left" id="panelLeft">
        <div class="panel-header">
          <div class="panel-title">‚ü® Context Builder ‚ü©</div>
          <div class="panel-actions">
            <button class="btn" id="saveTemplateBtn" aria-label="„ÉÜ„É≥„Éó„É¨„Éº„Éà‰øùÂ≠ò">Save Template</button>
            <button class="btn" id="showTemplatesBtn" aria-label="„ÉÜ„É≥„Éó„É¨„Éº„Éà‰∏ÄË¶ß">Templates</button>
          </div>
        </div>
        <div class="token-bar">
          <label>TOKEN BUDGET</label>
          <div class="token-track">
            <div class="token-fill" id="tokenFill"></div>
          </div>
          <div class="token-count" id="tokenCount">0 / 8,000</div>
          <input
            type="number"
            class="token-budget-input"
            id="tokenBudget"
            value="8000"
            min="100"
            step="1000"
          />
        </div>
        <div class="block-list" id="contextBlocks">
          <div class="empty-state" id="contextEmpty">
            <div class="empty-state-icon">‚ü®‚ü©</div>
            <div class="empty-state-text">
              „Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„Éñ„É≠„ÉÉ„ÇØ„Åå„Åæ„Å†„Å™„ÅÑ„Çì<br />‰∏ã„ÅÆÔºã„Éú„Çø„É≥„Åß„Éñ„É≠„ÉÉ„ÇØ„ÇíËøΩÂä†„Åô„Çã„Çì
            </div>
            <div class="empty-state-hint">
              System / Reference / Previous / Instruction
            </div>
          </div>
        </div>
        <div class="compose-area">
          <div class="compose-toolbar">
            <button class="btn" id="addSystemBtn">
              + System
            </button>
            <button class="btn" id="addReferenceBtn">
              + Reference
            </button>
            <button class="btn" id="addPreviousBtn">
              + Previous
            </button>
            <button class="btn" id="addInstructionBtn">
              + Instruction
            </button>
            <div style="flex: 1"></div>
            <button class="btn btn-accent" id="composeBtn" aria-label="„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„Çí„Ç≥„É≥„Éù„Éº„Ç∫„Åó„Å¶„Ç≥„Éî„Éº">
              ‚ü©‚ü© Compose & Copy
            </button>
          </div>
        </div>
      </div>

      <!-- DIVIDER -->
      <div class="divider" id="divider"></div>

      <!-- RIGHT: OUTPUT ASSEMBLER -->
      <div class="panel panel-right" id="panelRight">
        <div class="panel-header">
          <div class="panel-title">‚ü® Output Assembler ‚ü©</div>
          <div class="panel-actions">
            <button class="btn" id="snapshotBtn" aria-label="„Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„Éà">üì∏ Snapshot</button>
          </div>
        </div>
        <div class="output-stats" id="outputStats">
          <div class="stat">Fragments: <strong id="fragCount">0</strong></div>
          <div class="stat">Total chars: <strong id="fragChars">0</strong></div>
          <div class="stat">
            Est. tokens: <strong id="fragTokens">0</strong>
          </div>
        </div>
        <div class="snapshot-bar" id="snapshotBar" style="display: none"></div>
        <div class="block-list" id="outputBlocks">
          <div class="empty-state" id="outputEmpty">
            <div class="empty-state-icon">‚óá</div>
            <div class="empty-state-text">
              AI„ÅÆÂá∫Âäõ„Çí„Åì„Åì„Å´ÈõÜ„ÇÅ„Çã„Çì<br />Êñ≠Áâá„ÇíËìÑÁ©ç„Åó„Å¶„ÄÅ‰∏Ä„Å§„ÅÆÊàêÊûúÁâ©„Å´Áπî„Çä‰∏ä„Åí„Çã„Çì
            </div>
            <div class="empty-state-hint">Code / Text / Config / Data</div>
          </div>
        </div>
        <div class="compose-area">
          <div class="compose-toolbar">
            <button class="btn" id="addCodeBtn">+ Code</button>
            <button class="btn" id="addTextBtn">+ Text</button>
            <button class="btn" id="addConfigBtn">
              + Config
            </button>
            <button class="btn" id="addDataBtn">+ Data</button>
            <div style="flex: 1"></div>
            <button class="btn btn-accent" id="buildBtn" aria-label="Âá∫Âäõ„Çí„Éì„É´„Éâ„Åó„Å¶„Ç≥„Éî„Éº">
              ‚ü©‚ü© Build & Copy
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL -->
    <div class="modal-overlay" id="modalOverlay">
      <div class="modal" id="modalContent">
        <h3 id="modalTitle">Output</h3>
        <div id="modalBody"></div>
        <div class="modal-actions" id="modalActions"></div>
      </div>
    </div>

    <!-- TOAST -->
    <div class="toast" id="toast" role="status" aria-live="polite"></div>

    <script>
    (function() {
      'use strict';

      // ===== STATE =====
      var state = {
        contextBlocks: [],
        outputBlocks: [],
        templates: [],
        snapshots: [],
        tokenBudget: 8000,
      };

      var dragState = { panel: null, dragIndex: null };

      // ===== PERSISTENCE =====
      var _saveTimer = null;
      function _commitSave() {
        state.tokenBudget =
          parseInt(document.getElementById("tokenBudget").value) || 8000;
        try {
          localStorage.setItem("loom_state", JSON.stringify(state));
        } catch (error) {
          if (error.name === 'QuotaExceededError') {
            toast('„Çπ„Éà„É¨„Éº„Ç∏„ÅÆÂÆπÈáè„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô');
          }
          console.error('[Loom] Save failed:', error);
        }
      }

      function save() {
        clearTimeout(_saveTimer);
        _saveTimer = setTimeout(_commitSave, 300);
      }

      function saveImmediate() {
        clearTimeout(_saveTimer);
        _commitSave();
      }

      function load() {
        try {
          var saved = localStorage.getItem("loom_state");
          if (saved) {
            var parsed = JSON.parse(saved);
            state = { ...state, ...parsed };
            document.getElementById("tokenBudget").value = state.tokenBudget;
          }
        } catch (e) {
          console.error('[Loom] Failed to load state:', e);
        }
      }

      // ===== TOKEN ESTIMATION =====
      function estimateTokens(text) {
        if (!text) return 0;
        // Rough estimation: ~4 chars per token for English, ~2 for Japanese
        var jpChars = (text.match(/[\u3000-\u9fff\uff00-\uffef]/g) || [])
          .length;
        var otherChars = text.length - jpChars;
        return Math.ceil(jpChars / 1.5 + otherChars / 4);
      }

      function updateTokenBar() {
        var budget =
          parseInt(document.getElementById("tokenBudget").value) || 8000;
        state.tokenBudget = budget;
        var total = 0;
        state.contextBlocks.forEach(function(b) {
          total += estimateTokens(b.content);
        });
        var pct = Math.min((total / budget) * 100, 100);
        var fill = document.getElementById("tokenFill");
        fill.style.width = pct + "%";
        fill.className =
          "token-fill" + (pct > 90 ? " danger" : pct > 70 ? " warning" : "");
        document.getElementById("tokenCount").textContent =
          total.toLocaleString() + " / " + budget.toLocaleString();
        save();
      }

      function updateOutputStats() {
        var count = state.outputBlocks.length;
        var chars = 0,
          tokens = 0;
        state.outputBlocks.forEach(function(b) {
          chars += (b.content || "").length;
          tokens += estimateTokens(b.content);
        });
        document.getElementById("fragCount").textContent = count;
        document.getElementById("fragChars").textContent =
          chars.toLocaleString();
        document.getElementById("fragTokens").textContent =
          tokens.toLocaleString();
      }

      // ===== RENDER =====
      // Cache empty-state elements so they survive innerHTML = ""
      var contextEmptyEl = document.getElementById("contextEmpty");
      var outputEmptyEl = document.getElementById("outputEmpty");

      function renderContextBlocks() {
        var container = document.getElementById("contextBlocks");
        container.innerHTML = "";
        if (state.contextBlocks.length === 0) {
          contextEmptyEl.style.display = "flex";
          container.appendChild(contextEmptyEl);
          updateTokenBar();
          return;
        }
        contextEmptyEl.style.display = "none";
        state.contextBlocks.forEach(function(block, i) {
          container.appendChild(createBlockElement(block, i, "context"));
        });
        updateTokenBar();
      }

      function renderOutputBlocks() {
        var container = document.getElementById("outputBlocks");
        container.innerHTML = "";
        if (state.outputBlocks.length === 0) {
          outputEmptyEl.style.display = "flex";
          container.appendChild(outputEmptyEl);
          updateOutputStats();
          return;
        }
        outputEmptyEl.style.display = "none";
        state.outputBlocks.forEach(function(block, i) {
          container.appendChild(createBlockElement(block, i, "output"));
        });
        updateOutputStats();
      }

      function createBlockElement(block, index, panel) {
        var el = document.createElement("div");
        el.className = "block" + (block.collapsed ? " collapsed" : "");
        el.draggable = true;
        el.dataset.index = index;
        el.dataset.panel = panel;
        el.dataset.type = block.type;
        el.tabIndex = 0;

        var tokens = estimateTokens(block.content);

        el.innerHTML = '\
    <div class="block-head">\
      <div class="block-drag-handle" role="img" aria-label="\u30C9\u30E9\u30C3\u30B0\u3067\u4E26\u3079\u66FF\u3048"></div>\
      <span class="block-type-badge ' + block.type + '" title="Click to change type" aria-label="\u30BF\u30A4\u30D7\u5909\u66F4">' + block.type + '</span>\
      <input class="block-label-input" value="' + escHtml(block.label) + '"\
        placeholder="label...">\
      <span class="block-tokens">' + tokens + 't</span>\
      <div class="block-actions">\
        <button class="block-btn" title="Toggle" aria-label="\u6298\u308A\u305F\u305F\u307F\u5207\u66FF">' + (block.collapsed ? "\u25B8" : "\u25BE") + '</button>\
        <button class="block-btn" title="Duplicate" aria-label="\u8907\u88FD">\u29C9</button>\
        <button class="block-btn" title="Move to ' + (panel === "context" ? "Output" : "Context") + '" aria-label="\u30D1\u30CD\u30EB\u9593\u79FB\u52D5">\u21C4</button>\
        <button class="block-btn delete" title="Delete" aria-label="\u524A\u9664">\u2715</button>\
      </div>\
    </div>\
    <div class="block-body">\
      <textarea class="block-textarea"\
        placeholder="Paste content here..."\
      >' + escHtml(block.content) + '</textarea>\
    </div>';

        // Bind event listeners (replacing inline handlers)
        el.querySelector('.block-type-badge').addEventListener('click', function() { cycleType(index, panel); });
        var labelInput = el.querySelector('.block-label-input');
        labelInput.addEventListener('change', function() { updateBlockLabel(index, panel, this.value); });
        labelInput.addEventListener('click', function(e) { e.stopPropagation(); });
        var textarea = el.querySelector('.block-textarea');
        textarea.addEventListener('input', function() { updateBlockContent(index, panel, this.value); });
        var btns = el.querySelectorAll('.block-btn');
        btns[0].addEventListener('click', function() { toggleCollapse(index, panel); });
        btns[1].addEventListener('click', function() { duplicateBlock(index, panel); });
        btns[2].addEventListener('click', function() { moveToOtherPanel(index, panel); });
        btns[3].addEventListener('click', function() { deleteBlock(index, panel); });

        // Keyboard navigation
        el.addEventListener('keydown', function(e) {
          if (e.altKey && e.key === 'ArrowUp') {
            e.preventDefault();
            moveBlockUp(index, panel);
          } else if (e.altKey && e.key === 'ArrowDown') {
            e.preventDefault();
            moveBlockDown(index, panel);
          } else if (e.key === 'Delete' && e.target === el) {
            e.preventDefault();
            deleteBlock(index, panel);
          }
        });

        // Drag events
        el.addEventListener("dragstart", function(e) {
          var tag = e.target.tagName;
          if (tag === "TEXTAREA" || tag === "INPUT") {
            e.preventDefault();
            return;
          }
          dragState = { panel: panel, dragIndex: index };
          el.classList.add("dragging");
          e.dataTransfer.effectAllowed = "move";
        });
        el.addEventListener("dragend", function() {
          el.classList.remove("dragging");
          document
            .querySelectorAll(".drag-over")
            .forEach(function(x) { x.classList.remove("drag-over"); });
        });
        el.addEventListener("dragover", function(e) {
          e.preventDefault();
          if (dragState.panel === panel) {
            el.classList.add("drag-over");
          }
        });
        el.addEventListener("dragleave", function() {
          el.classList.remove("drag-over");
        });
        el.addEventListener("drop", function(e) {
          e.preventDefault();
          el.classList.remove("drag-over");
          if (dragState.panel === panel && dragState.dragIndex !== index) {
            var blocks =
              panel === "context" ? state.contextBlocks : state.outputBlocks;
            var moved = blocks.splice(dragState.dragIndex, 1)[0];
            blocks.splice(index, 0, moved);
            saveImmediate();
            panel === "context" ? renderContextBlocks() : renderOutputBlocks();
          }
        });

        return el;
      }

      // ===== BLOCK OPERATIONS =====
      function addContextBlock(type) {
        state.contextBlocks.push({
          type: type,
          label: "",
          content: "",
          collapsed: false,
          id: genId(),
        });
        saveImmediate();
        renderContextBlocks();
        focusLastTextarea("contextBlocks");
      }

      function addOutputBlock(type) {
        state.outputBlocks.push({
          type: type,
          label: "",
          content: "",
          collapsed: false,
          id: genId(),
        });
        saveImmediate();
        renderOutputBlocks();
        focusLastTextarea("outputBlocks");
      }

      function updateBlockContent(index, panel, value) {
        var blocks =
          panel === "context" ? state.contextBlocks : state.outputBlocks;
        blocks[index].content = value;
        // Update token display for this block
        var blockEl = document.querySelectorAll("#" + panel + "Blocks .block")[
          index
        ];
        if (blockEl) {
          var tokenSpan = blockEl.querySelector(".block-tokens");
          if (tokenSpan) tokenSpan.textContent = estimateTokens(value) + "t";
        }
        if (panel === "context") updateTokenBar();
        else updateOutputStats();
        save();
      }

      function updateBlockLabel(index, panel, value) {
        var blocks =
          panel === "context" ? state.contextBlocks : state.outputBlocks;
        blocks[index].label = value;
        save();
      }

      function deleteBlock(index, panel) {
        var blocks =
          panel === "context" ? state.contextBlocks : state.outputBlocks;
        blocks.splice(index, 1);
        saveImmediate();
        panel === "context" ? renderContextBlocks() : renderOutputBlocks();
      }

      function duplicateBlock(index, panel) {
        var blocks =
          panel === "context" ? state.contextBlocks : state.outputBlocks;
        var copy = {
          ...blocks[index],
          id: genId(),
          label: blocks[index].label + " (copy)",
        };
        blocks.splice(index + 1, 0, copy);
        saveImmediate();
        panel === "context" ? renderContextBlocks() : renderOutputBlocks();
      }

      function toggleCollapse(index, panel) {
        var blocks =
          panel === "context" ? state.contextBlocks : state.outputBlocks;
        blocks[index].collapsed = !blocks[index].collapsed;
        saveImmediate();
        panel === "context" ? renderContextBlocks() : renderOutputBlocks();
      }

      function moveToOtherPanel(index, panel) {
        var from =
          panel === "context" ? state.contextBlocks : state.outputBlocks;
        var to =
          panel === "context" ? state.outputBlocks : state.contextBlocks;
        var block = from.splice(index, 1)[0];
        // Map types if needed
        var typeMap = {
          system: "text",
          reference: "text",
          previous: "text",
          instruction: "text",
          code: "previous",
          text: "reference",
          config: "reference",
          data: "reference",
        };
        if (panel === "context") {
          block.type = typeMap[block.type] || "text";
        } else {
          block.type = typeMap[block.type] || "reference";
        }
        to.push(block);
        saveImmediate();
        renderContextBlocks();
        renderOutputBlocks();
        toast("Moved to " + (panel === "context" ? "Output" : "Context"));
      }

      var contextTypes = ["system", "reference", "previous", "instruction"];
      var outputTypes = ["code", "text", "config", "data"];

      function cycleType(index, panel) {
        var blocks =
          panel === "context" ? state.contextBlocks : state.outputBlocks;
        var types = panel === "context" ? contextTypes : outputTypes;
        var current = types.indexOf(blocks[index].type);
        blocks[index].type = types[(current + 1) % types.length];
        saveImmediate();
        panel === "context" ? renderContextBlocks() : renderOutputBlocks();
      }

      // ===== KEYBOARD BLOCK MOVE =====
      function moveBlockUp(index, panel) {
        if (index === 0) return;
        var blocks = panel === 'context' ? state.contextBlocks : state.outputBlocks;
        var temp = blocks[index - 1];
        blocks[index - 1] = blocks[index];
        blocks[index] = temp;
        saveImmediate();
        panel === 'context' ? renderContextBlocks() : renderOutputBlocks();
        // Re-focus the moved block
        setTimeout(function() {
          var container = document.getElementById(panel === 'context' ? 'contextBlocks' : 'outputBlocks');
          var movedBlock = container.querySelectorAll('.block')[index - 1];
          if (movedBlock) movedBlock.focus();
        }, 50);
      }

      function moveBlockDown(index, panel) {
        var blocks = panel === 'context' ? state.contextBlocks : state.outputBlocks;
        if (index >= blocks.length - 1) return;
        var temp = blocks[index];
        blocks[index] = blocks[index + 1];
        blocks[index + 1] = temp;
        saveImmediate();
        panel === 'context' ? renderContextBlocks() : renderOutputBlocks();
        setTimeout(function() {
          var container = document.getElementById(panel === 'context' ? 'contextBlocks' : 'outputBlocks');
          var movedBlock = container.querySelectorAll('.block')[index + 1];
          if (movedBlock) movedBlock.focus();
        }, 50);
      }

      // ===== COMPOSE / BUILD =====
      function composeContext() {
        if (state.contextBlocks.length === 0) {
          toast("No context blocks to compose");
          return;
        }

        var composed = "";
        var separators = {
          system: "--- SYSTEM ---",
          reference: "--- REFERENCE ---",
          previous: "--- PREVIOUS OUTPUT ---",
          instruction: "--- INSTRUCTION ---",
        };

        state.contextBlocks.forEach(function(block) {
          if (!block.content.trim()) return;
          var label = block.label ? " [" + block.label + "]" : "";
          composed += (separators[block.type] || "---") + label + "\n" + block.content.trim() + "\n\n";
        });

        composed = composed.trim();
        showModal(
          "Composed Context",
          '<textarea class="modal-output" id="composedOutput" readonly>' + escHtml(composed) + '</textarea>',
          [
            {
              label: "Copy to Clipboard",
              accent: true,
              action: function() {
                copyText(composed);
                toast("Copied to clipboard");
                closeModalDirect();
              },
            },
            { label: "Close", action: closeModalDirect },
          ],
        );
      }

      function buildOutput() {
        if (state.outputBlocks.length === 0) {
          toast("No output fragments to build");
          return;
        }

        var built = "";
        state.outputBlocks.forEach(function(block) {
          if (!block.content.trim()) return;
          var label = block.label ? "[" + block.label + "] " : "";
          if (block.type === "code") {
            built += label + "\n```\n" + block.content.trim() + "\n```\n\n";
          } else {
            built += label + "\n" + block.content.trim() + "\n\n";
          }
        });

        built = built.trim();
        showModal(
          "Built Output",
          '<textarea class="modal-output" id="builtOutput" readonly>' + escHtml(built) + '</textarea>',
          [
            {
              label: "Copy to Clipboard",
              accent: true,
              action: function() {
                copyText(built);
                toast("Copied to clipboard");
                closeModalDirect();
              },
            },
            { label: "Close", action: closeModalDirect },
          ],
        );
      }

      // ===== SNAPSHOTS =====
      async function takeSnapshot() {
        var name = await showPromptModal('„Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„ÉàÂêç:', 'snap_' + (state.snapshots.length + 1));
        if (!name) return;
        state.snapshots.push({
          name: name,
          blocks: structuredClone(state.outputBlocks),
          time: Date.now(),
        });
        saveImmediate();
        renderSnapshots();
        toast("Snapshot saved: " + name);
      }

      function renderSnapshots() {
        var bar = document.getElementById("snapshotBar");
        if (state.snapshots.length === 0) {
          bar.style.display = "none";
          return;
        }
        bar.style.display = "flex";
        bar.innerHTML =
          '<span style="font-family:var(--font-mono);font-size:10px;color:var(--text-muted);flex-shrink:0;">SNAPSHOTS</span>';
        state.snapshots.forEach(function(snap, i) {
          var chip = document.createElement("span");
          chip.className = "snapshot-chip";
          chip.innerHTML = escHtml(snap.name) + ' <span class="snapshot-delete">\u2715</span>';
          var deleteBtn = chip.querySelector('.snapshot-delete');
          deleteBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            deleteSnapshot(i);
          });
          chip.addEventListener('click', function() { restoreSnapshot(i); });
          bar.appendChild(chip);
        });
      }

      function restoreSnapshot(index) {
        if (
          !confirm(
            "„Åì„ÅÆ„Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„Éà„ÇíÂæ©ÂÖÉ„Åô„Çã„ÅÆ„ÇìÔºü ÁèæÂú®„ÅÆÂá∫Âäõ„Éñ„É≠„ÉÉ„ÇØ„ÅØÁΩÆ„ÅçÊèõ„Åà„Çâ„Çå„Çã„Çì„ÄÇ",
          )
        )
          return;
        state.outputBlocks = structuredClone(state.snapshots[index].blocks);
        saveImmediate();
        renderOutputBlocks();
        toast("Restored: " + state.snapshots[index].name);
      }

      function deleteSnapshot(index) {
        if (!confirm('„Åì„ÅÆ„Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„Éà„ÇíÂâäÈô§„Åô„Çã„ÅÆ„ÇìÔºü')) return;
        state.snapshots.splice(index, 1);
        saveImmediate();
        renderSnapshots();
      }

      // ===== TEMPLATES =====
      async function saveTemplate() {
        if (state.contextBlocks.length === 0) {
          toast("No blocks to save as template");
          return;
        }
        var name = await showPromptModal('„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂêç:', '');
        if (!name) return;
        state.templates.push({
          name: name,
          blocks: structuredClone(state.contextBlocks),
          time: Date.now(),
        });
        saveImmediate();
        toast("Template saved: " + name);
      }

      function showTemplates() {
        if (state.templates.length === 0) {
          toast("No templates saved yet");
          return;
        }

        var listHtml = '<div class="template-list">';
        state.templates.forEach(function(t, i) {
          var blockCount = t.blocks.length;
          var date = new Date(t.time).toLocaleDateString();
          listHtml +=
            '<div class="template-item" data-template-index="' + i + '">' +
              '<span class="template-name">' + escHtml(t.name) + '</span>' +
              '<span class="template-meta">' + blockCount + ' blocks \u00B7 ' + date +
                ' <span class="template-delete-btn" data-template-index="' + i + '" style="cursor:pointer;margin-left:8px;color:var(--danger)">\u2715</span>' +
              '</span>' +
            '</div>';
        });
        listHtml += "</div>";

        showModal("Templates", listHtml, [
          { label: "Close", action: closeModalDirect },
        ]);

        // Bind template item click listeners
        document.querySelectorAll('.template-item').forEach(function(item) {
          item.addEventListener('click', function() {
            loadTemplate(parseInt(this.dataset.templateIndex));
          });
        });
        document.querySelectorAll('.template-delete-btn').forEach(function(btn) {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            deleteTemplate(parseInt(this.dataset.templateIndex));
          });
        });
      }

      function loadTemplate(index) {
        state.contextBlocks = structuredClone(state.templates[index].blocks);
        // Regenerate IDs
        state.contextBlocks.forEach(function(b) { b.id = genId(); });
        saveImmediate();
        renderContextBlocks();
        closeModalDirect();
        toast("Loaded: " + state.templates[index].name);
      }

      function deleteTemplate(index) {
        if (!confirm('„Åì„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÂâäÈô§„Åô„Çã„ÅÆ„ÇìÔºü')) return;
        state.templates.splice(index, 1);
        saveImmediate();
        closeModalDirect();
        showTemplates();
      }

      // ===== IMPORT / EXPORT =====
      function exportAll() {
        var data = JSON.stringify(state, null, 2);
        var blob = new Blob([data], { type: "application/json" });
        var url = URL.createObjectURL(blob);
        var a = document.createElement("a");
        a.href = url;
        a.download = "loom_" + new Date().toISOString().slice(0, 10) + ".json";
        a.click();
        URL.revokeObjectURL(url);
        toast("Exported");
      }

      function importAll(event) {
        var file = event.target.files[0];
        if (!file) return;
        var reader = new FileReader();
        reader.onload = function(e) {
          try {
            var imported = JSON.parse(e.target.result);
            // Validate imported data types
            var arrayKeys = ['contextBlocks', 'outputBlocks', 'templates', 'snapshots'];
            for (var k = 0; k < arrayKeys.length; k++) {
              var key = arrayKeys[k];
              if (key in imported && !Array.isArray(imported[key])) {
                toast('Import failed: invalid data format');
                return;
              }
            }
            if ('tokenBudget' in imported && typeof imported.tokenBudget !== 'number') {
              toast('Import failed: invalid token budget');
              return;
            }
            // Validate block structure
            var validateBlock = function(b) { return b && typeof b === 'object' && typeof b.type === 'string' && typeof b.content === 'string'; };
            var blockKeys = ['contextBlocks', 'outputBlocks'];
            for (var j = 0; j < blockKeys.length; j++) {
              var bKey = blockKeys[j];
              if (bKey in imported && !imported[bKey].every(validateBlock)) {
                toast('Import failed: invalid block structure');
                return;
              }
            }
            var allowedKeys = ["contextBlocks", "outputBlocks", "templates", "snapshots", "tokenBudget"];
            allowedKeys.forEach(function(aKey) {
              if (aKey in imported) state[aKey] = imported[aKey];
            });
            document.getElementById("tokenBudget").value = state.tokenBudget;
            saveImmediate();
            renderContextBlocks();
            renderOutputBlocks();
            renderSnapshots();
            toast("Imported successfully");
          } catch (err) {
            toast("Import failed: invalid file");
          }
        };
        reader.onerror = function() { toast('„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'); };
        reader.onabort = function() { toast('„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Åå‰∏≠Êñ≠„Åï„Çå„Åæ„Åó„Åü'); };
        reader.readAsText(file);
        event.target.value = "";
      }

      function clearAll() {
        if (!confirm("Êú¨ÂΩì„Å´ÂÖ®ÈÉ®Ê∂à„Åô„ÅÆ„ÇìÔºü „Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Å™„ÅÑ„Çì„ÄÇ")) return;
        state.contextBlocks = [];
        state.outputBlocks = [];
        saveImmediate();
        renderContextBlocks();
        renderOutputBlocks();
        toast("Cleared all blocks");
      }

      // ===== MODAL =====
      function showModal(title, bodyHtml, buttons) {
        document.getElementById("modalTitle").textContent = title;
        document.getElementById("modalBody").innerHTML = bodyHtml;
        var actions = document.getElementById("modalActions");
        actions.innerHTML = "";
        (buttons || []).forEach(function(b) {
          var btn = document.createElement("button");
          btn.className = "btn" + (b.accent ? " btn-accent" : "");
          btn.textContent = b.label;
          btn.onclick = b.action;
          actions.appendChild(btn);
        });
        document.getElementById("modalOverlay").classList.add("active");
      }

      function closeModal(e) {
        if (e.target === e.currentTarget) closeModalDirect();
      }

      function closeModalDirect() {
        document.getElementById("modalOverlay").classList.remove("active");
      }

      function showPromptModal(title, defaultValue) {
        return new Promise(function(resolve) {
          var inputId = 'promptModalInput';
          showModal(title, '<input type="text" id="' + inputId + '" class="modal-output" style="min-height:auto;padding:10px;margin-bottom:0" value="' + escHtml(defaultValue || '') + '">', [
            {
              label: 'OK',
              accent: true,
              action: function() {
                var val = document.getElementById(inputId).value;
                closeModalDirect();
                resolve(val || null);
              }
            },
            {
              label: 'Cancel',
              action: function() {
                closeModalDirect();
                resolve(null);
              }
            }
          ]);
          // Focus the input after modal is shown
          setTimeout(function() {
            var input = document.getElementById(inputId);
            if (input) { input.focus(); input.select(); }
          }, 100);
        });
      }

      // ===== TOAST =====
      function toast(msg) {
        var el = document.getElementById("toast");
        el.textContent = msg;
        el.classList.add("show");
        clearTimeout(el._timeout);
        el._timeout = setTimeout(function() { el.classList.remove("show"); }, 2000);
      }

      // ===== UTILS =====
      function genId() {
        return "b_" + Math.random().toString(36).slice(2, 9);
      }

      function escHtml(str) {
        return (str || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function copyText(text) {
        navigator.clipboard.writeText(text).catch(function() {
          var ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
        });
      }

      function focusLastTextarea(containerId) {
        setTimeout(function() {
          var textareas = document.querySelectorAll(
            "#" + containerId + " .block-textarea",
          );
          if (textareas.length) textareas[textareas.length - 1].focus();
        }, 50);
      }

      // ===== DIVIDER RESIZE =====
      (function () {
        var divider = document.getElementById("divider");
        var left = document.getElementById("panelLeft");
        var dragging = false;

        divider.addEventListener("mousedown", function(e) {
          dragging = true;
          divider.classList.add("dragging");
          document.body.style.cursor = "col-resize";
          document.body.style.userSelect = "none";
        });

        document.addEventListener("mousemove", function(e) {
          if (!dragging) return;
          var mainRect = document
            .querySelector(".main")
            .getBoundingClientRect();
          var pct = ((e.clientX - mainRect.left) / mainRect.width) * 100;
          if (pct > 20 && pct < 80) {
            left.style.flex = "none";
            left.style.width = pct + "%";
          }
        });

        document.addEventListener("mouseup", function() {
          dragging = false;
          divider.classList.remove("dragging");
          document.body.style.cursor = "";
          document.body.style.userSelect = "";
        });
      })();

      // ===== KEYBOARD SHORTCUTS =====
      document.addEventListener("keydown", function(e) {
        if (e.key === "Escape") closeModalDirect();
      });

      // ===== EVENT LISTENERS (migrated from inline handlers) =====
      document.getElementById('exportBtn').addEventListener('click', exportAll);
      document.getElementById('importBtn').addEventListener('click', function() {
        document.getElementById('importFile').click();
      });
      document.getElementById('importFile').addEventListener('change', importAll);
      document.getElementById('clearAllBtn').addEventListener('click', clearAll);
      document.getElementById('saveTemplateBtn').addEventListener('click', saveTemplate);
      document.getElementById('showTemplatesBtn').addEventListener('click', showTemplates);
      document.getElementById('tokenBudget').addEventListener('change', updateTokenBar);
      document.getElementById('addSystemBtn').addEventListener('click', function() { addContextBlock('system'); });
      document.getElementById('addReferenceBtn').addEventListener('click', function() { addContextBlock('reference'); });
      document.getElementById('addPreviousBtn').addEventListener('click', function() { addContextBlock('previous'); });
      document.getElementById('addInstructionBtn').addEventListener('click', function() { addContextBlock('instruction'); });
      document.getElementById('composeBtn').addEventListener('click', composeContext);
      document.getElementById('snapshotBtn').addEventListener('click', takeSnapshot);
      document.getElementById('addCodeBtn').addEventListener('click', function() { addOutputBlock('code'); });
      document.getElementById('addTextBtn').addEventListener('click', function() { addOutputBlock('text'); });
      document.getElementById('addConfigBtn').addEventListener('click', function() { addOutputBlock('config'); });
      document.getElementById('addDataBtn').addEventListener('click', function() { addOutputBlock('data'); });
      document.getElementById('buildBtn').addEventListener('click', buildOutput);
      document.getElementById('modalOverlay').addEventListener('click', closeModal);
      document.getElementById('modalContent').addEventListener('click', function(e) { e.stopPropagation(); });

      // ===== THEME TOGGLE =====
      function initTheme() {
        var saved = localStorage.getItem('loom_theme');
        if (saved) {
          document.documentElement.setAttribute('data-theme', saved);
        }
        updateThemeButton();
      }

      function toggleTheme() {
        var current = document.documentElement.getAttribute('data-theme');
        var next = current === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('loom_theme', next);
        updateThemeButton();
      }

      function updateThemeButton() {
        var btn = document.getElementById('themeToggleBtn');
        var isLight = document.documentElement.getAttribute('data-theme') === 'light';
        btn.textContent = isLight ? '\u263E Dark' : '\u2600 Light';
      }

      document.getElementById('themeToggleBtn').addEventListener('click', toggleTheme);

      // ===== INIT =====
      initTheme();
      load();
      renderContextBlocks();
      renderOutputBlocks();
      renderSnapshots();
    })();
    </script>
  </body>
</html>
