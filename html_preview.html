<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; connect-src https://fonts.googleapis.com https://fonts.gstatic.com;" />
    <title>拡張版HTMLプレビューアー</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        /* デジタル庁デザインシステム準拠カラーパレット */
        /* プライマリカラー（ブランドの基調色） */
        --da-primary: #1f2937;
        --da-primary-hover: #111827;
        
        /* セカンダリカラー（プライマリと調和する補完色） */
        --da-secondary: #3b82f6;
        --da-secondary-hover: #2563eb;
        
        /* ターシャリカラー（視覚的階層構築用） */
        --da-tertiary: #60a5fa;
        --da-tertiary-light: #93c5fd;
        
        /* 機能的カラー */
        --da-neutral-white: #ffffff;
        --da-neutral-50: #f9fafb;
        --da-neutral-100: #f3f4f6;
        --da-neutral-200: #e5e7eb;
        --da-neutral-300: #d1d5db;
        --da-neutral-400: #9ca3af;
        --da-neutral-500: #6b7280;
        --da-neutral-600: #4b5563;
        --da-neutral-700: #374151;
        --da-neutral-800: #1f2937;
        --da-neutral-900: #111827;
        
        /* セマンティックカラー */
        --da-success: #10b981;
        --da-warning: #f59e0b;
        --da-error: #ef4444;
        --da-info: var(--da-secondary);
        
        /* アプリケーション固有の役割 */
        --app-text-primary: var(--da-neutral-900);
        --app-text-secondary: var(--da-neutral-600);
        --app-text-on-dark: var(--da-neutral-white);
        --app-text-muted: var(--da-neutral-500);
        
        --app-bg-primary: var(--da-neutral-white);
        --app-bg-secondary: var(--da-neutral-50);
        --app-bg-dark: var(--da-primary);
        
        --app-border-default: var(--da-neutral-200);
        --app-border-focus: var(--da-secondary);
        --app-border-hover: var(--da-neutral-300);
        
        --app-toolbar-bg: var(--da-primary);
        --app-toolbar-text: var(--app-text-on-dark);
        --app-toolbar-border: var(--da-neutral-700);
        
        --app-panel-header-bg: var(--da-neutral-800);
        --app-panel-header-text: var(--app-text-on-dark);
        
        --app-editor-bg: var(--app-bg-primary);
        --app-editor-text: var(--app-text-primary);
        --app-editor-placeholder: var(--app-text-muted);
        
        --app-line-numbers-bg: var(--da-neutral-800);
        --app-line-numbers-text: var(--da-neutral-300);
        
        --app-gutter-bg: var(--da-neutral-800);
        --app-gutter-hover: var(--da-neutral-700);
        --app-gutter-handle: var(--da-neutral-400);
        
        --app-accent: var(--da-secondary);
        --app-accent-hover: var(--da-secondary-hover);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
        font-size: 16px;
        line-height: 1.5;
        font-weight: 400;
        height: 100vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        background-color: var(--app-bg-primary);
        color: var(--app-text-primary);
      }

      .toolbar {
        background-color: var(--app-toolbar-bg);
        padding: 12px 16px;
        border-bottom: 1px solid var(--app-toolbar-border);
        display: flex;
        align-items: center;
        gap: 12px;
        flex-shrink: 0;
        min-height: 48px;
      }

      .toolbar-title {
        font-weight: 500;
        font-size: 18px;
        line-height: 1.4;
        margin-right: auto;
        color: var(--app-toolbar-text);
        letter-spacing: 0.02em;
      }

      .toolbar-button {
        background: none;
        border: none;
        padding: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        min-width: 40px;
        min-height: 40px;
        transition: all 0.2s ease;
      }

      .toolbar-button svg {
        width: 20px;
        height: 20px;
        color: var(--da-neutral-300);
        transition: all 0.2s ease;
      }

      .toolbar-button:hover {
        background-color: var(--da-neutral-700);
      }
      .toolbar-button:hover svg {
        color: var(--da-neutral-white);
      }
      .toolbar-button.active {
        background-color: var(--app-accent);
      }
      .toolbar-button.active svg {
        color: var(--da-neutral-white);
      }
      
      .toolbar-button:focus,
      .toolbar-button:focus-visible {
        outline: 2px solid var(--app-border-focus);
        outline-offset: 2px;
        border-radius: 6px;
      }

      #html-editor:focus,
      #html-editor:focus-visible {
        outline: 2px solid var(--app-border-focus);
        outline-offset: -2px;
        border-radius: 4px;
      }

      .split-view {
        display: flex;
        width: 100%;
        flex-grow: 1;
        position: relative;
        overflow: hidden;
      }

      .split-view.layout-lr {
        flex-direction: row;
      }
      .split-view.layout-tb {
        flex-direction: column;
      }

      .editor-container,
      .preview-panel {
        display: flex;
        flex-direction: column;
        min-width: 0;
        min-height: 0;
        overflow: hidden;
      }

      .editor-container {
        background-color: var(--app-editor-bg);
      }
      .split-view.layout-lr .editor-container {
        width: 50%;
        height: 100%;
      }
      .split-view.layout-tb .editor-container {
        width: 100%;
        height: 50%;
      }

      .preview-panel {
        background-color: var(--app-bg-primary);
      }
      .split-view.layout-lr .preview-panel {
        width: 50%;
        height: 100%;
      }
      .split-view.layout-tb .preview-panel {
        width: 100%;
        height: 50%;
      }

      .split-view.layout-po .editor-container,
      .split-view.layout-po .gutter {
        display: none;
      }
      .split-view.layout-po .preview-panel {
        width: 100% !important;
        height: 100% !important;
      }

      .panel-header {
        background-color: var(--app-panel-header-bg);
        color: var(--app-panel-header-text);
        padding: 12px 16px;
        font-weight: 500;
        font-size: 16px;
        line-height: 1.5;
        text-align: center;
        user-select: none;
        flex-shrink: 0;
        letter-spacing: 0.02em;
      }

      .editor-content-wrapper {
        display: flex;
        flex-grow: 1;
        overflow: hidden;
        border: 1px solid var(--app-border-default);
        border-top: none;
        border-radius: 0 0 4px 4px;
      }

      #line-numbers {
        width: 50px;
        padding: 12px 8px 12px 12px;
        font-family: "Noto Sans Mono", Consolas, "Courier New", monospace;
        font-size: 14px;
        line-height: 1.5;
        background-color: var(--app-line-numbers-bg);
        color: var(--app-line-numbers-text);
        text-align: right;
        user-select: none;
        overflow: hidden;
        flex-shrink: 0;
        border-right: 1px solid var(--da-neutral-600);
      }
      /* Individual line number styling (if needed, but usually handled by parent) */
      #line-numbers div {
        height: calc(14px * 1.5); /* font-size * line-height */
        display: flex;
        align-items: center;
        justify-content: flex-end;
      }

      #html-editor {
        width: 100%;
        height: 100%;
        border: none;
        border-radius: 0;
        padding: 12px 16px;
        font-family: "Noto Sans Mono", Consolas, "Courier New", monospace;
        font-size: 14px;
        line-height: 1.5;
        resize: none;
        flex-grow: 1;
        background-color: var(--app-editor-bg);
        color: var(--app-editor-text);
      }
      #html-editor::placeholder {
        color: var(--app-editor-placeholder);
        font-style: italic;
      }

      .panel-content {
        flex-grow: 1;
        overflow: auto;
        padding: 12px 16px;
        border: 1px solid var(--app-border-default);
        border-top: none;
        background-color: var(--app-bg-primary);
        border-radius: 0 0 4px 4px;
      }

      #preview-container {
        width: 100%;
        height: 100%;
        border: none;
        background-color: var(--app-bg-primary);
        border-radius: 4px;
      }

      .gutter {
        background-color: var(--app-gutter-bg);
        position: relative;
        transition: background-color 0.2s ease;
      }
      .split-view.layout-lr .gutter {
        width: 8px;
        height: 100%;
        cursor: col-resize;
      }
      .split-view.layout-tb .gutter {
        width: 100%;
        height: 8px;
        cursor: row-resize;
      }

      .gutter:hover {
        background-color: var(--app-gutter-hover);
      }

      .gutter::after {
        content: "";
        position: absolute;
        background-color: var(--app-gutter-handle);
        border-radius: 2px;
        transition: background-color 0.2s ease;
      }
      .split-view.layout-lr .gutter::after {
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 2px;
        height: 30px;
      }
      .split-view.layout-tb .gutter::after {
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 30px;
        height: 2px;
      }

      body.dragging,
      body.dragging * {
        cursor: col-resize !important; /* Default, JS will adjust for TB */
      }
      .resize-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 9999;
      }

      .security-notice {
        background-color: #fef3c7;
        border: 1px solid var(--da-warning);
        color: #92400e;
        padding: 8px 12px;
        font-size: 13px;
        font-weight: 500;
        text-align: center;
        border-radius: 6px;
        margin: 8px 16px;
        display: none;
        line-height: 1.4;
      }

      .security-notice.show {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="toolbar">
      <span class="toolbar-title">HTMLプレビューアー</span>
      <button class="toolbar-button" id="copy-btn" title="コードをクリップボードにコピー (Ctrl+Shift+C)" aria-label="エディター内容をクリップボードにコピー" role="button" tabindex="0">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 0 1-.75.75H9a.75.75 0 0 1-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0 1 1.927-.184" />
        </svg>
      </button>
      <button class="toolbar-button" id="clear-btn" title="エディターをクリア (Ctrl+Delete)" aria-label="エディター内容をクリア" role="button" tabindex="0">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
        </svg>
      </button>
      <div style="width: 1px; height: 24px; background-color: var(--app-toolbar-border); margin: 0 12px;" role="separator" aria-orientation="vertical"></div>
      <button class="toolbar-button" id="layout-lr-btn" title="左右分割レイアウト" aria-label="左右分割レイアウトに変更" role="button" tabindex="0">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 4.5v15m6-15v15m-13.5-7.5h21" />
        </svg>
      </button>
      <button class="toolbar-button" id="layout-tb-btn" title="上下分割レイアウト" aria-label="上下分割レイアウトに変更" role="button" tabindex="0">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
        </svg>
      </button>
      <button class="toolbar-button" id="layout-po-btn" title="プレビューのみ" aria-label="プレビューのみ表示" role="button" tabindex="0">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path
            d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"
          />
        </svg>
      </button>
      <div style="flex-grow: 1" aria-hidden="true"></div>
      <button class="toolbar-button" id="save-btn" title="HTMLファイルをダウンロード (Ctrl+S)" aria-label="HTMLファイルとして保存" role="button" tabindex="0">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
        </svg>
      </button>
    </div>

    <div class="split-view" id="split-view">
      <div class="editor-container" id="editor-container">
        <div class="panel-header">HTMLエディタ</div>
        <div class="editor-content-wrapper">
          <div id="line-numbers" aria-hidden="true"></div>
          <textarea
            id="html-editor"
            placeholder="HTMLコードをここに貼り付けてください..."
            wrap="soft"
            aria-label="HTMLコードエディター"
            role="textbox"
            aria-multiline="true"
            aria-describedby="security-notice"
            spellcheck="false"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="off"
          ></textarea>
        </div>
      </div>
      <div class="gutter" id="gutter"></div>
      <div class="preview-panel" id="preview-panel">
        <div class="panel-header">プレビュー</div>
        <div class="security-notice" id="security-notice" role="alert" aria-live="polite">
          <span aria-hidden="true">⚠️</span> 信頼できないHTMLコードの実行にご注意ください
        </div>
        <div class="panel-content">
          <iframe id="preview-container" frameborder="0" sandbox="allow-same-origin allow-scripts allow-forms allow-popups" aria-label="HTMLプレビュー表示エリア" title="HTMLコードのプレビュー結果" role="application"></iframe>
        </div>
      </div>
    </div>

    <script>
      (function() {
        'use strict';
        
        // 設定オブジェクト
        const CONFIG = {
          defaultLayout: "lr",
          storageKey: "htmlPreviewerCode",
          debounceDelay: 300,
          layouts: {
            lr: "左右分割",
            tb: "上下分割", 
            po: "プレビューのみ"
          }
        };

        // 統一エラーハンドリング
        const ErrorHandler = {
          log: (error, context = '') => {
            console.error(`[HTMLプレビューアー${context ? ` - ${context}` : ''}]`, error);
          },
          
          showPreviewError: (error) => {
            const iframeDoc = elements.previewContainer.contentDocument || 
                              elements.previewContainer.contentWindow.document;
            iframeDoc.open();
            iframeDoc.write(`
              <div style="padding: 20px; background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; font-family: system-ui;">
                <h3 style="margin-top: 0;">プレビューエラー</h3>
                <p>HTMLの処理中にエラーが発生しました。</p>
                <details style="margin-top: 10px;">
                  <summary style="cursor: pointer;">詳細を表示</summary>
                  <pre style="background: #f8f9fa; padding: 10px; margin-top: 10px; border-radius: 4px; overflow-x: auto;">${error.message || error}</pre>
                </details>
              </div>
            `);
            iframeDoc.close();
          },
          
          handle: (error, context = '', showToUser = true) => {
            ErrorHandler.log(error, context);
            if (showToUser && context === 'プレビュー更新') {
              ErrorHandler.showPreviewError(error);
            }
          }
        };

        // ユーティリティ関数
        const Utils = {
          debounce: (func, delay) => {
            let timeoutId;
            return function(...args) {
              clearTimeout(timeoutId);
              timeoutId = setTimeout(() => func.apply(this, args), delay);
            };
          }
        };
        
        // DOM要素の取得
        const elements = {
          splitView: document.getElementById("split-view"),
          editorContainer: document.getElementById("editor-container"),
          previewPanel: document.getElementById("preview-panel"),
          gutter: document.getElementById("gutter"),
          htmlEditor: document.getElementById("html-editor"),
          previewContainer: document.getElementById("preview-container"),
          lineNumbersDiv: document.getElementById("line-numbers"),
          securityNotice: document.getElementById("security-notice"),
          layoutLrBtn: document.getElementById("layout-lr-btn"),
          layoutTbBtn: document.getElementById("layout-tb-btn"),
          layoutPoBtn: document.getElementById("layout-po-btn"),
          copyBtn: document.getElementById("copy-btn"),
          clearBtn: document.getElementById("clear-btn"),
          saveBtn: document.getElementById("save-btn")
        };

        // 状態管理
        let state = {
          currentLayout: CONFIG.defaultLayout,
          isDragging: false,
          dragContext: {},
          lastLineCount: 0
        };

        // --- 初期化 ---
        function initialize() {
          loadSavedCode();
          // 初期行数を設定
          state.lastLineCount = elements.htmlEditor.value.split("\n").length;
          applyLayout(state.currentLayout); // 初期レイアウト適用
          updatePreview();
          updateLineNumbers();
          
          // セキュリティ警告を表示（コンテンツがある場合は非表示）
          if (elements.htmlEditor.value.trim()) {
            elements.securityNotice.classList.remove("show");
          } else {
            elements.securityNotice.classList.add("show");
          }

          elements.htmlEditor.addEventListener("input", handleEditorInput);
          elements.htmlEditor.addEventListener("scroll", syncScroll);
          // Observe textarea resize to update line numbers if its width changes affecting wrapping
          new ResizeObserver(updateLineNumbers).observe(elements.htmlEditor);

          elements.gutter.addEventListener("mousedown", startDrag);
          elements.gutter.addEventListener("touchstart", (e) => {
            e.preventDefault(); // スクロール防止
            startDrag(e.touches[0]);
          });

          elements.layoutLrBtn.addEventListener("click", () => applyLayout("lr"));
          elements.layoutTbBtn.addEventListener("click", () => applyLayout("tb"));
          elements.layoutPoBtn.addEventListener("click", () => applyLayout("po"));
          elements.copyBtn.addEventListener("click", copyEditor);
          elements.clearBtn.addEventListener("click", clearEditor);
          elements.saveBtn.addEventListener("click", saveToFile); // Add event listener for save
          
          // キーボードショートカット
          document.addEventListener("keydown", handleKeyboard);
          
          // ツールバーボタンのキーボード操作対応
          const toolbarButtons = [elements.layoutLrBtn, elements.layoutTbBtn, elements.layoutPoBtn, elements.copyBtn, elements.clearBtn, elements.saveBtn];
          toolbarButtons.forEach(btn => {
            btn.addEventListener("keydown", (e) => {
              if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                btn.click();
              }
            });
          });
        }

        // デバウンス版saveCode
        const debouncedSaveCode = Utils.debounce(saveCode, CONFIG.debounceDelay);

        function handleEditorInput() {
          updatePreview();
          updateLineNumbers();
          debouncedSaveCode();
          
          // コンテンツが入力されたらセキュリティ警告を非表示
          if (elements.htmlEditor.value.trim() && elements.securityNotice.classList.contains("show")) {
            elements.securityNotice.classList.remove("show");
          } else if (!elements.htmlEditor.value.trim() && !elements.securityNotice.classList.contains("show")) {
            elements.securityNotice.classList.add("show");
          }
        }

        function handleKeyboard(e) {
          // Ctrl+S: 保存
          if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            saveToFile();
          }
          // Ctrl+Shift+C: コピー
          else if (e.ctrlKey && e.shiftKey && e.key === 'C') {
            e.preventDefault();
            copyEditor();
          }
          // Ctrl+Delete: クリア
          else if (e.ctrlKey && e.key === 'Delete') {
            e.preventDefault();
            clearEditor();
          }
          // Ctrl+1: 左右分割
          else if (e.ctrlKey && e.key === '1') {
            e.preventDefault();
            applyLayout("lr");
          }
          // Ctrl+2: 上下分割
          else if (e.ctrlKey && e.key === '2') {
            e.preventDefault();
            applyLayout("tb");
          }
          // Ctrl+3: プレビューのみ
          else if (e.ctrlKey && e.key === '3') {
            e.preventDefault();
            applyLayout("po");
          }
        }

        // --- レイアウト制御 ---
        function applyLayout(mode) {
          state.currentLayout = mode;
          elements.splitView.className = "split-view"; // Reset classes
          elements.splitView.classList.add(`layout-${mode}`);

          elements.editorContainer.style.width = "";
          elements.editorContainer.style.height = "";
          elements.previewPanel.style.width = "";
          elements.previewPanel.style.height = "";

          const toolbarButtons = [elements.layoutLrBtn, elements.layoutTbBtn, elements.layoutPoBtn];
          toolbarButtons.forEach((btn) => btn.classList.remove("active"));
          if (mode === "lr") elements.layoutLrBtn.classList.add("active");
          else if (mode === "tb") elements.layoutTbBtn.classList.add("active");
          else if (mode === "po") elements.layoutPoBtn.classList.add("active");

          if (mode === "lr") {
            elements.editorContainer.style.width = "50%";
            elements.previewPanel.style.width = "50%";
          } else if (mode === "tb") {
            elements.editorContainer.style.height = "50%";
            elements.previewPanel.style.height = "50%";
          }
          // Ensure line numbers are updated after layout change, as width might affect wrapping
          requestAnimationFrame(updateLineNumbers);
        }

        // --- プレビュー更新 ---
        function updatePreview() {
          const htmlCode = elements.htmlEditor.value;
          const iframeDoc =
            elements.previewContainer.contentDocument ||
            elements.previewContainer.contentWindow.document;
          try {
            iframeDoc.open();
            iframeDoc.write(htmlCode);
            iframeDoc.close();
          } catch (error) {
            ErrorHandler.handle(error, 'プレビュー更新', true);
          }
        }

        // --- 行番号処理 ---
        function updateLineNumbers() {
          const lines = elements.htmlEditor.value.split("\n");
          const currentLineCount = lines.length;
          
          // 行数に変更がない場合はスキップ
          if (currentLineCount === state.lastLineCount) {
            syncScroll(); // スクロール同期は常に実行
            return;
          }
          
          let numbersHTML = "";
          for (let i = 1; i <= currentLineCount; i++) {
            numbersHTML += `<div>${i}</div>`;
          }
          elements.lineNumbersDiv.innerHTML = numbersHTML;
          state.lastLineCount = currentLineCount;
          
          syncScroll(); // Ensure scroll is synced after updating numbers
        }

        function syncScroll() {
          // Sync the scroll position of the line numbers div with the textarea
          elements.lineNumbersDiv.scrollTop = elements.htmlEditor.scrollTop;
        }

        // --- ローカルストレージ ---
        function saveCode() {
          try {
            localStorage.setItem(CONFIG.storageKey, elements.htmlEditor.value);
          } catch (error) {
            ErrorHandler.handle(error, 'ローカル保存', false);
          }
        }

        function loadSavedCode() {
          try {
            const savedCode = localStorage.getItem(CONFIG.storageKey);
            if (savedCode !== null) {
              elements.htmlEditor.value = savedCode;
            } else {
              elements.htmlEditor.value = `<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>サンプルページ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --da-primary: #1f2937;
      --da-secondary: #3b82f6;
      --da-neutral-white: #ffffff;
      --da-neutral-50: #f9fafb;
      --da-neutral-100: #f3f4f6;
      --da-neutral-900: #111827;
    }
    body {
      font-family: 'Noto Sans JP', 'Hiragino Kaku Gothic ProN', sans-serif;
      font-size: 16px;
      line-height: 1.6;
      margin: 0;
      padding: 24px;
      background-color: var(--da-neutral-50);
      color: var(--da-neutral-900);
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 32px;
      background-color: var(--da-neutral-white);
      border-radius: 8px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    h1 {
      font-size: 32px;
      font-weight: 700;
      color: var(--da-primary);
      border-bottom: 2px solid var(--da-secondary);
      padding-bottom: 12px;
      margin-bottom: 24px;
      letter-spacing: 0.02em;
    }
    p {
      font-size: 16px;
      line-height: 1.6;
      margin-bottom: 16px;
      color: var(--da-neutral-900);
    }
    .button {
      background-color: var(--da-secondary);
      color: var(--da-neutral-white);
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.2s ease;
      font-family: inherit;
    }
    .button:hover {
      background-color: #2563eb;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
    }
    .button:focus {
      outline: 2px solid var(--da-secondary);
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>HTMLプレビューアーへようこそ</h1>
    <p>エディタにHTMLコードを入力または貼り付けると、こちらにリアルタイムでプレビューが表示されます。</p>
    <p>ツールバーのボタンでレイアウトを変更したり、ファイルを保存したりできます。デジタル庁デザインシステムに準拠した美しいUIをお楽しみください。</p>
    <button class="button" onclick="alert('こんにちは！デザインシステムが適用されました。')">クリックテスト</button>
  </div>
</body>
</html>`;
            }
          } catch (error) {
            ErrorHandler.handle(error, 'ローカル読み込み', false);
          }
        }

        // --- エディター操作機能 ---
        function clearEditor() {
          if (elements.htmlEditor.value.trim() === '') {
            showTemporaryMessage('エディターは既に空です');
            return;
          }
          
          if (confirm('エディターの内容をクリアしますか？\n\n※この操作は取り消せません。')) {
            elements.htmlEditor.value = '';
            updatePreview();
            updateLineNumbers();
            debouncedSaveCode();
            
            // セキュリティ警告を表示
            elements.securityNotice.classList.add("show");
            showTemporaryMessage('エディターをクリアしました');
          }
        }

        async function copyEditor() {
          const content = elements.htmlEditor.value;
          
          if (content.trim() === '') {
            showTemporaryMessage('コピーする内容がありません');
            return;
          }
          
          try {
            await navigator.clipboard.writeText(content);
            showTemporaryMessage('エディター内容をクリップボードにコピーしました');
          } catch (error) {
            ErrorHandler.handle(error, 'クリップボード操作', false);
            // フォールバック: 古いブラウザ対応
            try {
              const textArea = document.createElement('textarea');
              textArea.value = content;
              document.body.appendChild(textArea);
              textArea.select();
              document.execCommand('copy');
              document.body.removeChild(textArea);
              showTemporaryMessage('エディター内容をコピーしました（フォールバック）');
            } catch (fallbackError) {
              ErrorHandler.handle(fallbackError, 'フォールバックコピー', false);
              showTemporaryMessage('コピーに失敗しました', 'error');
            }
          }
        }

        function showTemporaryMessage(message, type = 'success') {
          // 一時的なメッセージ表示機能
          const messageDiv = document.createElement('div');
          messageDiv.textContent = message;
          messageDiv.style.cssText = `
            position: fixed;
            top: 60px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 10000;
            pointer-events: none;
            transition: opacity 0.3s ease;
            ${type === 'error' 
              ? 'background-color: #fee; color: #c33; border: 1px solid #fcc;' 
              : 'background-color: #efe; color: #363; border: 1px solid #cfc;'}
          `;
          
          document.body.appendChild(messageDiv);
          
          setTimeout(() => {
            messageDiv.style.opacity = '0';
            setTimeout(() => {
              if (messageDiv.parentNode) {
                document.body.removeChild(messageDiv);
              }
            }, 300);
          }, 2000);
        }

        // --- ファイル保存機能 ---
        function getTitleFromHtml(html) {
          const titleMatch = html.match(/<title[^>]*>([\s\S]*?)<\/title>/i); // Use [\s\S]*? for multiline titles
          if (titleMatch && titleMatch[1]) {
            // Sanitize title to be a valid filename
            let filename = titleMatch[1].trim();
            filename = filename.replace(
              /[^a-z0-9_\-\s\u3000-\u303F\u3040-\u309F\u30A0-\u30FF\uFF00-\uFFEF\u4E00-\u9FAF]+/gi,
              "_"
            ); // Allow Japanese chars
            filename = filename.replace(/\s+/g, "_");
            return filename + ".html";
          }
          return "preview.html";
        }

        function saveToFile() {
          const htmlCode = elements.htmlEditor.value;
          const filename = getTitleFromHtml(htmlCode);

          const blob = new Blob([htmlCode], { type: "text/html;charset=utf-8" });

          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = filename;

          document.body.appendChild(link); // Required for Firefox
          link.click();
          document.body.removeChild(link);

          URL.revokeObjectURL(link.href); // Clean up
        }

        // --- Split View リサイズ機能 ---
        function startDrag(e) {
          state.isDragging = true;
          document.body.classList.add("dragging");

          state.dragContext.startX = e.clientX;
          state.dragContext.startY = e.clientY;
          state.dragContext.editorInitialWidth = elements.editorContainer.offsetWidth;
          state.dragContext.editorInitialHeight = elements.editorContainer.offsetHeight;

          window.addEventListener("mousemove", doDrag);
          window.addEventListener("touchmove", (ev) => doDrag(ev.touches[0]), {
            passive: false,
          });
          window.addEventListener("mouseup", stopDrag);
          window.addEventListener("touchend", stopDrag);
          window.addEventListener("mouseleave", stopDrag);

          document.body.style.userSelect = "none";
          if (state.currentLayout === "tb") {
            document.body.style.cursor = "row-resize";
          } else {
            document.body.style.cursor = "col-resize";
          }

          const overlay = document.createElement("div");
          overlay.className = "resize-overlay";
          document.body.appendChild(overlay);
        }

        function doDrag(e) {
          if (!state.isDragging) return;

          requestAnimationFrame(() => {
            const dx = e.clientX - state.dragContext.startX;
            const dy = e.clientY - state.dragContext.startY;

            let editorNewSize;

            if (state.currentLayout === "lr") {
              const totalWidth =
                elements.editorContainer.parentElement.clientWidth - elements.gutter.offsetWidth;
              editorNewSize = state.dragContext.editorInitialWidth + dx;
              const minWidth = Math.max(totalWidth * 0.1, 100);
              editorNewSize = Math.max(minWidth, editorNewSize);
              editorNewSize = Math.min(totalWidth - minWidth, editorNewSize);

              elements.editorContainer.style.width = `${editorNewSize}px`;
              elements.previewPanel.style.width = `${totalWidth - editorNewSize}px`;
            } else if (state.currentLayout === "tb") {
              const totalHeight =
                elements.editorContainer.parentElement.clientHeight - elements.gutter.offsetHeight;
              editorNewSize = state.dragContext.editorInitialHeight + dy;
              const minHeight = Math.max(totalHeight * 0.1, 100);
              editorNewSize = Math.max(minHeight, editorNewSize);
              editorNewSize = Math.min(totalHeight - minHeight, editorNewSize);

              elements.editorContainer.style.height = `${editorNewSize}px`;
              elements.previewPanel.style.height = `${totalHeight - editorNewSize}px`;
            }
            // Update line numbers as panel resize might affect textarea width and thus wrapping
            updateLineNumbers();
          });
        }

        function stopDrag() {
          if (!state.isDragging) return;
          state.isDragging = false;
          document.body.classList.remove("dragging");

          window.removeEventListener("mousemove", doDrag);
          window.removeEventListener("touchmove", doDrag);
          window.removeEventListener("mouseup", stopDrag);
          window.removeEventListener("touchend", stopDrag);
          window.removeEventListener("mouseleave", stopDrag);

          document.body.style.userSelect = "";
          document.body.style.cursor = "";

          const overlay = document.querySelector(".resize-overlay");
          if (overlay) {
            document.body.removeChild(overlay);
          }
          state.dragContext = {};
          // Final update to line numbers after dragging stops
          requestAnimationFrame(updateLineNumbers);
        }

        // 初期化実行
        initialize();
      })();
    </script>
  </body>
</html>
